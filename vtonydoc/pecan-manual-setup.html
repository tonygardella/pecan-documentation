<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>4 Install PEcAn | The Predictive Ecosystem Analyzer</title>
  <meta name="description" content="4 Install PEcAn | The Predictive Ecosystem Analyzer">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="4 Install PEcAn | The Predictive Ecosystem Analyzer" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Install PEcAn | The Predictive Ecosystem Analyzer" />
  
  
  

<meta name="author" content="By: PEcAn Team">


<meta name="date" content="2019-04-29">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="about-the-pecan-book.html">
<link rel="next" href="user-section.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.5/datatables.js"></script>
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.16/js/jquery.dataTables.min.js"></script>
<link href="libs/dt-ext-fixedcolumns-1.10.16/css/fixedColumns.dataTables.min.css" rel="stylesheet" />
<script src="libs/dt-ext-fixedcolumns-1.10.16/js/dataTables.fixedColumns.min.js"></script>
<script src="libs/jszip-1.10.16/jszip.min.js"></script>
<script src="libs/pdfmake-1.10.16/pdfmake.min.js"></script>
<script src="libs/pdfmake-1.10.16/vfs_fonts.js"></script>
<link href="libs/dt-ext-buttons-1.10.16/css/buttons.dataTables.min.css" rel="stylesheet" />
<script src="libs/dt-ext-buttons-1.10.16/js/dataTables.buttons.min.js"></script>
<script src="libs/dt-ext-buttons-1.10.16/js/buttons.flash.min.js"></script>
<script src="libs/dt-ext-buttons-1.10.16/js/buttons.html5.min.js"></script>
<script src="libs/dt-ext-buttons-1.10.16/js/buttons.colVis.min.js"></script>
<script src="libs/dt-ext-buttons-1.10.16/js/buttons.print.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="part"><span><b>I Introduction</b></span></li>
<li class="chapter" data-level="1" data-path="project-overview.html"><a href="project-overview.html"><i class="fa fa-check"></i><b>1</b> Project Overview</a></li>
<li class="chapter" data-level="2" data-path="contributor-covenant-code-of-conduct.html"><a href="contributor-covenant-code-of-conduct.html"><i class="fa fa-check"></i><b>2</b> Contributor Covenant Code of Conduct</a></li>
<li class="chapter" data-level="3" data-path="about-the-pecan-book.html"><a href="about-the-pecan-book.html"><i class="fa fa-check"></i><b>3</b> About the PEcAn Book</a><ul>
<li class="chapter" data-level="3.0.1" data-path="about-the-pecan-book.html"><a href="about-the-pecan-book.html#general-feedbackcommentssuggestions"><i class="fa fa-check"></i><b>3.0.1</b> General Feedback/Comments/Suggestions</a></li>
<li class="chapter" data-level="3.1" data-path="about-the-pecan-book.html"><a href="about-the-pecan-book.html#bookediting"><i class="fa fa-check"></i><b>3.1</b> Editing this book</a></li>
</ul></li>
<li class="part"><span><b>II Tutorials,Demos and How To’s</b></span></li>
<li class="chapter" data-level="4" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html"><i class="fa fa-check"></i><b>4</b> Install PEcAn</a><ul>
<li class="chapter" data-level="4.1" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#pecanvm"><i class="fa fa-check"></i><b>4.1</b> PEcAn Virtual Machine</a><ul>
<li class="chapter" data-level="4.1.1" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#maintain-vm"><i class="fa fa-check"></i><b>4.1.1</b> Maintaining your PEcAn VM</a></li>
<li class="chapter" data-level="4.1.2" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#working-with-vm"><i class="fa fa-check"></i><b>4.1.2</b> Working with the VM</a></li>
<li class="chapter" data-level="4.1.3" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#awsvm"><i class="fa fa-check"></i><b>4.1.3</b> Using Amazon Web Services for a VM (AWS)</a></li>
<li class="chapter" data-level="4.1.4" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#createvm"><i class="fa fa-check"></i><b>4.1.4</b> Creating a Virtual Machine</a></li>
<li class="chapter" data-level="4.1.5" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#vm-dektop-conversion"><i class="fa fa-check"></i><b>4.1.5</b> VM Desktop Conversion</a></li>
<li class="chapter" data-level="4.1.6" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#aws-setup"><i class="fa fa-check"></i><b>4.1.6</b> AWS Setup</a></li>
<li class="chapter" data-level="4.1.7" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#porting-vm-to-aws"><i class="fa fa-check"></i><b>4.1.7</b> Porting VM to AWS</a></li>
<li class="chapter" data-level="4.1.8" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#set-up-multiple-instances-optional"><i class="fa fa-check"></i><b>4.1.8</b> Set up multiple instances (optional)</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#shiny-setup"><i class="fa fa-check"></i><b>4.2</b> Shiny Setup</a><ul>
<li class="chapter" data-level="4.2.1" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#install-the-shiny-r-package-and-shiny-server"><i class="fa fa-check"></i><b>4.2.1</b> Install the Shiny R package and Shiny server</a></li>
<li class="chapter" data-level="4.2.2" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#modify-the-shiny-configuration-file"><i class="fa fa-check"></i><b>4.2.2</b> Modify the shiny configuration file</a></li>
<li class="chapter" data-level="4.2.3" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#set-the-apache-proxy"><i class="fa fa-check"></i><b>4.2.3</b> Set the Apache proxy</a></li>
<li class="chapter" data-level="4.2.4" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#enable-and-start-the-shiny-server-and-restart-apache"><i class="fa fa-check"></i><b>4.2.4</b> Enable and start the shiny server, and restart apache</a></li>
<li class="chapter" data-level="4.2.5" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#troubleshooting"><i class="fa fa-check"></i><b>4.2.5</b> Troubleshooting</a></li>
<li class="chapter" data-level="4.2.6" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#further-reading"><i class="fa fa-check"></i><b>4.2.6</b> Further reading</a></li>
<li class="chapter" data-level="4.2.7" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#thredds-setup"><i class="fa fa-check"></i><b>4.2.7</b> Thredds Setup</a></li>
<li class="chapter" data-level="4.2.8" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#install-the-tomcat-8-and-thredds-webapp"><i class="fa fa-check"></i><b>4.2.8</b> Install the Tomcat 8 and Thredds webapp</a></li>
<li class="chapter" data-level="4.2.9" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#update-the-catalog"><i class="fa fa-check"></i><b>4.2.9</b> Update the catalog</a></li>
<li class="chapter" data-level="4.2.10" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#troubleshooting-1"><i class="fa fa-check"></i><b>4.2.10</b> Troubleshooting</a></li>
<li class="chapter" data-level="4.2.11" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#further-reading-1"><i class="fa fa-check"></i><b>4.2.11</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#docker-index"><i class="fa fa-check"></i><b>4.3</b> Docker</a><ul>
<li class="chapter" data-level="4.3.1" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#setup-pecan-using-docker-compose"><i class="fa fa-check"></i><b>4.3.1</b> Setup PEcAn using docker-compose</a></li>
<li class="chapter" data-level="4.3.2" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#pecan-docker-quickstart-init"><i class="fa fa-check"></i><b>4.3.2</b> Initialize PEcAn (first time only)</a></li>
<li class="chapter" data-level="4.3.3" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#docker-quickstart-troubleshooting"><i class="fa fa-check"></i><b>4.3.3</b> Troubleshooting</a></li>
<li class="chapter" data-level="4.3.4" data-path="pecan-manual-setup.html"><a href="pecan-manual-setup.html#osinstall"><i class="fa fa-check"></i><b>4.3.4</b> OS Specific Installations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="user-section.html"><a href="user-section.html"><i class="fa fa-check"></i><b>5</b> User Tutorial Section</a><ul>
<li class="chapter" data-level="5.0.1" data-path="user-section.html"><a href="user-section.html#demo-table"><i class="fa fa-check"></i><b>5.0.1</b> PEcAn Demos</a></li>
<li class="chapter" data-level="5.1" data-path="user-section.html"><a href="user-section.html#basic-web-wrokflow"><i class="fa fa-check"></i><b>5.1</b> Basic Web workflow</a><ul>
<li class="chapter" data-level="5.1.1" data-path="user-section.html"><a href="user-section.html#web-site-model"><i class="fa fa-check"></i><b>5.1.1</b> Site and model selection</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="user-section.html"><a href="user-section.html#intermediate-user"><i class="fa fa-check"></i><b>5.2</b> PEcAn Web Interface</a></li>
<li class="chapter" data-level="5.3" data-path="user-section.html"><a href="user-section.html#advanced-user"><i class="fa fa-check"></i><b>5.3</b> Advanced User Guide</a><ul>
<li class="chapter" data-level="5.3.1" data-path="user-section.html"><a href="user-section.html#adding-to-pecan"><i class="fa fa-check"></i><b>5.3.1</b> Adding to PEcAn</a></li>
<li class="chapter" data-level="5.3.2" data-path="user-section.html"><a href="user-section.html#web-curl-submission"><i class="fa fa-check"></i><b>5.3.2</b> Submitting Workflow from Command Line</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="developer-guide.html"><a href="developer-guide.html"><i class="fa fa-check"></i><b>6</b> Developer guide</a><ul>
<li class="chapter" data-level="6.1" data-path="developer-guide.html"><a href="developer-guide.html#updatebety"><i class="fa fa-check"></i><b>6.1</b> Updating PEcAn Code and Bety Database</a></li>
<li class="chapter" data-level="6.2" data-path="developer-guide.html"><a href="developer-guide.html#pecan-git"><i class="fa fa-check"></i><b>6.2</b> Git and GitHub Workflow</a><ul>
<li class="chapter" data-level="6.2.1" data-path="developer-guide.html"><a href="developer-guide.html#using-git"><i class="fa fa-check"></i><b>6.2.1</b> Using Git</a></li>
<li class="chapter" data-level="6.2.2" data-path="developer-guide.html"><a href="developer-guide.html#github-use-with-pecan"><i class="fa fa-check"></i><b>6.2.2</b> GitHub use with PEcAn</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="developer-guide.html"><a href="developer-guide.html#coding-practices"><i class="fa fa-check"></i><b>6.3</b> Coding Practices</a></li>
<li class="chapter" data-level="6.4" data-path="developer-guide.html"><a href="developer-guide.html#coding-style"><i class="fa fa-check"></i><b>6.4</b> Coding Style</a></li>
<li class="chapter" data-level="6.5" data-path="developer-guide.html"><a href="developer-guide.html#logging"><i class="fa fa-check"></i><b>6.5</b> Logging</a><ul>
<li class="chapter" data-level="6.5.1" data-path="developer-guide.html"><a href="developer-guide.html#pecan-logging-functions"><i class="fa fa-check"></i><b>6.5.1</b> PEcAn logging functions</a></li>
<li class="chapter" data-level="6.5.2" data-path="developer-guide.html"><a href="developer-guide.html#other-r-logging-packages"><i class="fa fa-check"></i><b>6.5.2</b> Other R logging packages</a></li>
<li class="chapter" data-level="6.5.3" data-path="developer-guide.html"><a href="developer-guide.html#example-usage"><i class="fa fa-check"></i><b>6.5.3</b> Example Usage</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="developer-guide.html"><a href="developer-guide.html#package-data"><i class="fa fa-check"></i><b>6.6</b> Package Data</a></li>
<li class="chapter" data-level="6.7" data-path="developer-guide.html"><a href="developer-guide.html#roxygen2-1"><i class="fa fa-check"></i><b>6.7</b> Roxygen2</a></li>
<li class="chapter" data-level="6.8" data-path="developer-guide.html"><a href="developer-guide.html#testing"><i class="fa fa-check"></i><b>6.8</b> Testing</a></li>
<li class="chapter" data-level="6.9" data-path="developer-guide.html"><a href="developer-guide.html#download-and-compile-pecan"><i class="fa fa-check"></i><b>6.9</b> Download and Compile PEcAn</a><ul>
<li class="chapter" data-level="6.9.1" data-path="developer-guide.html"><a href="developer-guide.html#pecan-testrun"><i class="fa fa-check"></i><b>6.9.1</b> PEcAn Testrun</a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="developer-guide.html"><a href="developer-guide.html#directory-structure"><i class="fa fa-check"></i><b>6.10</b> Directory structure</a></li>
</ul></li>
<li class="part"><span><b>III Topical Pages</b></span></li>
<li class="chapter" data-level="7" data-path="pecan-standards.html"><a href="pecan-standards.html"><i class="fa fa-check"></i><b>7</b> PEcAn standard formats</a><ul>
<li class="chapter" data-level="7.1" data-path="pecan-standards.html"><a href="pecan-standards.html#defining-new-input-formats"><i class="fa fa-check"></i><b>7.1</b> Defining new input formats</a></li>
<li class="chapter" data-level="7.2" data-path="pecan-standards.html"><a href="pecan-standards.html#time-standard"><i class="fa fa-check"></i><b>7.2</b> Time Standard</a><ul>
<li class="chapter" data-level="7.2.1" data-path="pecan-standards.html"><a href="pecan-standards.html#input-standards"><i class="fa fa-check"></i><b>7.2.1</b> Input Standards</a></li>
<li class="chapter" data-level="7.2.2" data-path="pecan-standards.html"><a href="pecan-standards.html#soils-and-vegetation-inputs"><i class="fa fa-check"></i><b>7.2.2</b> Soils and Vegetation Inputs</a></li>
<li class="chapter" data-level="7.2.3" data-path="pecan-standards.html"><a href="pecan-standards.html#output-standards"><i class="fa fa-check"></i><b>7.2.3</b> Output Standards</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="pecanXML.html"><a href="pecanXML.html"><i class="fa fa-check"></i><b>8</b> The PEcAn XML</a><ul>
<li class="chapter" data-level="8.0.1" data-path="pecanXML.html"><a href="pecanXML.html#xml-core-config"><i class="fa fa-check"></i><b>8.0.1</b> Core configuration</a></li>
<li class="chapter" data-level="8.0.2" data-path="pecanXML.html"><a href="pecanXML.html#xml-outdir"><i class="fa fa-check"></i><b>8.0.2</b> <code>outdir</code>: Output directory</a></li>
<li class="chapter" data-level="8.0.3" data-path="pecanXML.html"><a href="pecanXML.html#xml-database"><i class="fa fa-check"></i><b>8.0.3</b> <code>database</code>: PEcAn database settings</a></li>
<li class="chapter" data-level="8.0.4" data-path="pecanXML.html"><a href="pecanXML.html#xml-pft"><i class="fa fa-check"></i><b>8.0.4</b> <code>pft</code>: Plant functional type selection</a></li>
<li class="chapter" data-level="8.0.5" data-path="pecanXML.html"><a href="pecanXML.html#xml-meta-analysis"><i class="fa fa-check"></i><b>8.0.5</b> <code>meta.analysis</code>: Trait Meta Analysis</a></li>
<li class="chapter" data-level="8.0.6" data-path="pecanXML.html"><a href="pecanXML.html#xml-model"><i class="fa fa-check"></i><b>8.0.6</b> <code>model</code>: Model configuration</a></li>
<li class="chapter" data-level="8.0.7" data-path="pecanXML.html"><a href="pecanXML.html#xml-run"><i class="fa fa-check"></i><b>8.0.7</b> <code>run</code>: Run Setup</a></li>
<li class="chapter" data-level="8.0.8" data-path="pecanXML.html"><a href="pecanXML.html#xml-host"><i class="fa fa-check"></i><b>8.0.8</b> <code>host</code>: Host information for remote execution</a></li>
<li class="chapter" data-level="8.0.9" data-path="pecanXML.html"><a href="pecanXML.html#xml-advanced"><i class="fa fa-check"></i><b>8.0.9</b> Advanced features</a></li>
<li class="chapter" data-level="8.0.10" data-path="pecanXML.html"><a href="pecanXML.html#xml-ensemble"><i class="fa fa-check"></i><b>8.0.10</b> <code>ensemble</code>: Ensemble Runs</a></li>
<li class="chapter" data-level="8.0.11" data-path="pecanXML.html"><a href="pecanXML.html#xml-sensitivity-analysis"><i class="fa fa-check"></i><b>8.0.11</b> <code>sensitivity.analysis</code>: Sensitivity analysis</a></li>
<li class="chapter" data-level="8.0.12" data-path="pecanXML.html"><a href="pecanXML.html#xml-parameter-data-assimilation"><i class="fa fa-check"></i><b>8.0.12</b> Parameter Data Assimilation</a></li>
<li class="chapter" data-level="8.0.13" data-path="pecanXML.html"><a href="pecanXML.html#xml-multi-settings"><i class="fa fa-check"></i><b>8.0.13</b> Multi-Settings</a></li>
<li class="chapter" data-level="8.0.14" data-path="pecanXML.html"><a href="pecanXML.html#xml-state-data-assimilation"><i class="fa fa-check"></i><b>8.0.14</b> (experimental) State Data Assimilation</a></li>
<li class="chapter" data-level="8.0.15" data-path="pecanXML.html"><a href="pecanXML.html#xml-browndog"><i class="fa fa-check"></i><b>8.0.15</b> (experimental) Brown Dog</a></li>
<li class="chapter" data-level="8.0.16" data-path="pecanXML.html"><a href="pecanXML.html#xml-benchmarking"><i class="fa fa-check"></i><b>8.0.16</b> (experimental) Benchmarking</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="workflow.html"><a href="workflow.html"><i class="fa fa-check"></i><b>9</b> PEcAn workflow (web/workflow.R)</a><ul>
<li class="chapter" data-level="9.0.1" data-path="workflow.html"><a href="workflow.html#workflow-readsettings"><i class="fa fa-check"></i><b>9.0.1</b> Read Settings</a></li>
<li class="chapter" data-level="9.0.2" data-path="workflow.html"><a href="workflow.html#workflow-input"><i class="fa fa-check"></i><b>9.0.2</b> Input Conversions</a></li>
<li class="chapter" data-level="9.0.3" data-path="workflow.html"><a href="workflow.html#workflow-input-data"><i class="fa fa-check"></i><b>9.0.3</b> Input Data</a></li>
<li class="chapter" data-level="9.0.4" data-path="workflow.html"><a href="workflow.html#workflow-input-initial"><i class="fa fa-check"></i><b>9.0.4</b> Initial Conditions</a></li>
<li class="chapter" data-level="9.0.5" data-path="workflow.html"><a href="workflow.html#workflow-met"><i class="fa fa-check"></i><b>9.0.5</b> Meteorological Data</a></li>
<li class="chapter" data-level="9.0.6" data-path="workflow.html"><a href="workflow.html#workflow-met-standard"><i class="fa fa-check"></i><b>9.0.6</b> Converting raw data to PEcAn standard</a></li>
<li class="chapter" data-level="9.0.7" data-path="workflow.html"><a href="workflow.html#workflow-met-downscale"><i class="fa fa-check"></i><b>9.0.7</b> Downscaling and gapfilling (optional)</a></li>
<li class="chapter" data-level="9.0.8" data-path="workflow.html"><a href="workflow.html#workflow-met-model"><i class="fa fa-check"></i><b>9.0.8</b> Converting from PEcAn standard to model-specific format</a></li>
<li class="chapter" data-level="9.0.9" data-path="workflow.html"><a href="workflow.html#workflow-traits"><i class="fa fa-check"></i><b>9.0.9</b> Traits</a></li>
<li class="chapter" data-level="9.0.10" data-path="workflow.html"><a href="workflow.html#workflow-metaanalysis"><i class="fa fa-check"></i><b>9.0.10</b> Meta Analysis</a></li>
<li class="chapter" data-level="9.0.11" data-path="workflow.html"><a href="workflow.html#workflow-modelconfig"><i class="fa fa-check"></i><b>9.0.11</b> Model Configuration</a></li>
<li class="chapter" data-level="9.0.12" data-path="workflow.html"><a href="workflow.html#workflow-modelrun"><i class="fa fa-check"></i><b>9.0.12</b> Run Execution</a></li>
<li class="chapter" data-level="9.0.13" data-path="workflow.html"><a href="workflow.html#workflow-postrun"><i class="fa fa-check"></i><b>9.0.13</b> Post Run Analysis</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="pecan-models.html"><a href="pecan-models.html"><i class="fa fa-check"></i><b>10</b> PEcAn Models</a><ul>
<li class="chapter" data-level="10.0.1" data-path="pecan-models.html"><a href="pecan-models.html#models-biocro"><i class="fa fa-check"></i><b>10.0.1</b> BioCro</a></li>
<li class="chapter" data-level="10.0.2" data-path="pecan-models.html"><a href="pecan-models.html#models-clm"><i class="fa fa-check"></i><b>10.0.2</b> CLM</a></li>
<li class="chapter" data-level="10.0.3" data-path="pecan-models.html"><a href="pecan-models.html#models-dalec"><i class="fa fa-check"></i><b>10.0.3</b> DALEC</a></li>
<li class="chapter" data-level="10.0.4" data-path="pecan-models.html"><a href="pecan-models.html#models-ed"><i class="fa fa-check"></i><b>10.0.4</b> ED2</a></li>
<li class="chapter" data-level="10.0.5" data-path="pecan-models.html"><a href="pecan-models.html#installation-notes"><i class="fa fa-check"></i><b>10.0.5</b> Installation notes</a></li>
<li class="chapter" data-level="10.0.6" data-path="pecan-models.html"><a href="pecan-models.html#models-gday"><i class="fa fa-check"></i><b>10.0.6</b> GDAY</a></li>
<li class="chapter" data-level="10.0.7" data-path="pecan-models.html"><a href="pecan-models.html#models-linkages"><i class="fa fa-check"></i><b>10.0.7</b> LINKAGES</a></li>
<li class="chapter" data-level="10.0.8" data-path="pecan-models.html"><a href="pecan-models.html#models-lpjguess"><i class="fa fa-check"></i><b>10.0.8</b> LPJ-GUESS</a></li>
<li class="chapter" data-level="10.0.9" data-path="pecan-models.html"><a href="pecan-models.html#models-maespa"><i class="fa fa-check"></i><b>10.0.9</b> MAESPA</a></li>
<li class="chapter" data-level="10.0.10" data-path="pecan-models.html"><a href="pecan-models.html#models-preles"><i class="fa fa-check"></i><b>10.0.10</b> PRELES</a></li>
<li class="chapter" data-level="10.0.11" data-path="pecan-models.html"><a href="pecan-models.html#models-sipnet"><i class="fa fa-check"></i><b>10.0.11</b> SiPNET</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html"><i class="fa fa-check"></i><b>11</b> Available Meteorological Drivers</a><ul>
<li class="chapter" data-level="11.0.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#ameriflux"><i class="fa fa-check"></i><b>11.0.1</b> Ameriflux</a></li>
<li class="chapter" data-level="11.0.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#amerifluxlbl"><i class="fa fa-check"></i><b>11.0.2</b> AmerifluxLBL</a></li>
<li class="chapter" data-level="11.0.3" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#fluxnet2015"><i class="fa fa-check"></i><b>11.0.3</b> Fluxnet2015</a></li>
<li class="chapter" data-level="11.0.4" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#narr"><i class="fa fa-check"></i><b>11.0.4</b> NARR</a></li>
<li class="chapter" data-level="11.0.5" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#cruncep"><i class="fa fa-check"></i><b>11.0.5</b> CRUNCEP</a></li>
<li class="chapter" data-level="11.0.6" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#cmip5"><i class="fa fa-check"></i><b>11.0.6</b> CMIP5</a></li>
<li class="chapter" data-level="11.0.7" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#nldas"><i class="fa fa-check"></i><b>11.0.7</b> NLDAS</a></li>
<li class="chapter" data-level="11.0.8" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#gldas"><i class="fa fa-check"></i><b>11.0.8</b> GLDAS</a></li>
<li class="chapter" data-level="11.0.9" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#paleon"><i class="fa fa-check"></i><b>11.0.9</b> PalEON</a></li>
<li class="chapter" data-level="11.0.10" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#fluxnetlathuile"><i class="fa fa-check"></i><b>11.0.10</b> FluxnetLaThuile</a></li>
<li class="chapter" data-level="11.0.11" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#geostreams"><i class="fa fa-check"></i><b>11.0.11</b> Geostreams</a></li>
<li class="chapter" data-level="11.0.12" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#download-gfdl"><i class="fa fa-check"></i><b>11.0.12</b> Download GFDL</a></li>
<li class="chapter" data-level="11.0.13" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#cm3"><i class="fa fa-check"></i><b>11.0.13</b> CM3</a></li>
<li class="chapter" data-level="11.0.14" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#esm2m-esm2g"><i class="fa fa-check"></i><b>11.0.14</b> ESM2M &amp; ESM2G</a></li>
<li class="chapter" data-level="11.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#database-synchronization"><i class="fa fa-check"></i><b>11.1</b> Database synchronization</a><ul>
<li class="chapter" data-level="11.1.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#how-does-it-work"><i class="fa fa-check"></i><b>11.1.1</b> How does it work?</a></li>
<li class="chapter" data-level="11.1.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#set-up"><i class="fa fa-check"></i><b>11.1.2</b> Set up</a></li>
<li class="chapter" data-level="11.1.3" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#fetch-latest-data"><i class="fa fa-check"></i><b>11.1.3</b> Fetch latest data</a></li>
<li class="chapter" data-level="11.1.4" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#sharing-data"><i class="fa fa-check"></i><b>11.1.4</b> Sharing data</a></li>
<li class="chapter" data-level="11.1.5" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#automation"><i class="fa fa-check"></i><b>11.1.5</b> Automation</a></li>
<li class="chapter" data-level="11.1.6" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#database-maintentance"><i class="fa fa-check"></i><b>11.1.6</b> Database maintentance</a></li>
<li class="chapter" data-level="11.1.7" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#troubleshooting-3"><i class="fa fa-check"></i><b>11.1.7</b> Troubleshooting</a></li>
<li class="chapter" data-level="11.1.8" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#network-status-map"><i class="fa fa-check"></i><b>11.1.8</b> Network Status Map</a></li>
<li class="chapter" data-level="11.1.9" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#tasks"><i class="fa fa-check"></i><b>11.1.9</b> Tasks</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#standalone-tools-modules"><i class="fa fa-check"></i><b>11.2</b> Standalone tools (modules)</a><ul>
<li class="chapter" data-level="11.2.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#LoadData"><i class="fa fa-check"></i><b>11.2.1</b> Loading Data in PEcAn</a></li>
<li class="chapter" data-level="11.2.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#function-load_data"><i class="fa fa-check"></i><b>11.2.2</b> Function <code>load_data</code></a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#using-the-pecan-download.file-function"><i class="fa fa-check"></i><b>11.3</b> Using the PEcAn download.file() function</a></li>
<li class="chapter" data-level="11.4" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#shiny"><i class="fa fa-check"></i><b>11.4</b> SHINY</a><ul>
<li class="chapter" data-level="11.4.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#debugging-shiny-apps"><i class="fa fa-check"></i><b>11.4.1</b> Debugging Shiny Apps</a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#debugging"><i class="fa fa-check"></i><b>11.5</b> Debugging</a><ul>
<li class="chapter" data-level="11.5.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#using-testsworkflow.r"><i class="fa fa-check"></i><b>11.5.1</b> Using <code>tests/workflow.R</code></a></li>
<li class="chapter" data-level="11.5.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#useful-scripts"><i class="fa fa-check"></i><b>11.5.2</b> Useful scripts</a></li>
</ul></li>
<li class="chapter" data-level="11.6" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#troubleshooting-pecan"><i class="fa fa-check"></i><b>11.6</b> Troubleshooting PEcAn</a><ul>
<li class="chapter" data-level="11.6.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#cookies-and-pecan-web-pages"><i class="fa fa-check"></i><b>11.6.1</b> Cookies and pecan web pages</a></li>
<li class="chapter" data-level="11.6.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#warning-mkdir-function.mkdir-no-such-file-or-directory"><i class="fa fa-check"></i><b>11.6.2</b> <code>Warning: mkdir() [function.mkdir]: No such file or directory</code></a></li>
<li class="chapter" data-level="11.6.3" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#after-creating-a-new-pft-the-tag-for-pft-not-passed-to-config.xml-in-ed"><i class="fa fa-check"></i><b>11.6.3</b> After creating a new PFT the <num> tag for PFT not passed to config.xml in ED</a></li>
</ul></li>
<li class="chapter" data-level="11.7" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#pecan-project-use-to-teach-ecological-model-data-synthesis"><i class="fa fa-check"></i><b>11.7</b> PEcAn Project use to teach Ecological model-data synthesis</a><ul>
<li class="chapter" data-level="11.7.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#university-classes"><i class="fa fa-check"></i><b>11.7.1</b> University classes</a></li>
<li class="chapter" data-level="11.7.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#summer-courses-workshops"><i class="fa fa-check"></i><b>11.7.2</b> Summer Courses / Workshops</a></li>
<li class="chapter" data-level="11.7.3" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#selected-publications"><i class="fa fa-check"></i><b>11.7.3</b> Selected Publications</a></li>
</ul></li>
<li class="chapter" data-level="11.8" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#rabbitmq"><i class="fa fa-check"></i><b>11.8</b> RabbitMQ</a><ul>
<li class="chapter" data-level="11.8.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#rabbitmq-basics-sender"><i class="fa fa-check"></i><b>11.8.1</b> Producer – <code>sender.py</code></a></li>
<li class="chapter" data-level="11.8.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#rabbitmq-basics-receiver"><i class="fa fa-check"></i><b>11.8.2</b> Consumer – <code>receiver.py</code></a></li>
<li class="chapter" data-level="11.8.3" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#rabbitmq-web"><i class="fa fa-check"></i><b>11.8.3</b> RabbitMQ and the PEcAn web interface</a></li>
<li class="chapter" data-level="11.8.4" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#rabbitmq-xml"><i class="fa fa-check"></i><b>11.8.4</b> RabbitMQ in the PEcAn XML</a></li>
<li class="chapter" data-level="11.8.5" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#rabbitmq-dockerfile"><i class="fa fa-check"></i><b>11.8.5</b> RabbitMQ configuration in Dockerfiles</a></li>
<li class="chapter" data-level="11.8.6" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#rabbitmq-case-study"><i class="fa fa-check"></i><b>11.8.6</b> Case study: PEcAn web interface</a></li>
</ul></li>
<li class="chapter" data-level="11.9" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#database"><i class="fa fa-check"></i><b>11.9</b> BETY Database Administration</a><ul>
<li class="chapter" data-level="11.9.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#database-setup"><i class="fa fa-check"></i><b>11.9.1</b> Best practices</a></li>
<li class="chapter" data-level="11.9.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#backup-of-bety-database"><i class="fa fa-check"></i><b>11.9.2</b> Backup of BETY database</a></li>
<li class="chapter" data-level="11.9.3" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#restore-of-bety-database"><i class="fa fa-check"></i><b>11.9.3</b> Restore of BETY database</a></li>
</ul></li>
<li class="chapter" data-level="11.10" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#workflow-modules"><i class="fa fa-check"></i><b>11.10</b> Workflow modules</a><ul>
<li class="chapter" data-level="11.10.1" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#overview"><i class="fa fa-check"></i><b>11.10.1</b> Overview</a></li>
<li class="chapter" data-level="11.10.2" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#load-settings"><i class="fa fa-check"></i><b>11.10.2</b> Load Settings:</a></li>
<li class="chapter" data-level="11.10.3" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#query-database"><i class="fa fa-check"></i><b>11.10.3</b> Query Database:</a></li>
<li class="chapter" data-level="11.10.4" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#meta-analysis"><i class="fa fa-check"></i><b>11.10.4</b> Meta Analysis:</a></li>
<li class="chapter" data-level="11.10.5" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#write-configuration-files"><i class="fa fa-check"></i><b>11.10.5</b> Write Configuration Files</a></li>
<li class="chapter" data-level="11.10.6" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#start-runs"><i class="fa fa-check"></i><b>11.10.6</b> Start Runs:</a></li>
<li class="chapter" data-level="11.10.7" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#get-model-output"><i class="fa fa-check"></i><b>11.10.7</b> Get Model Output</a></li>
<li class="chapter" data-level="11.10.8" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#ensemble-analysis"><i class="fa fa-check"></i><b>11.10.8</b> Ensemble Analysis</a></li>
<li class="chapter" data-level="11.10.9" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#sensitivity-analysis-variance-decomposition"><i class="fa fa-check"></i><b>11.10.9</b> Sensitivity Analysis, Variance Decomposition</a></li>
<li class="chapter" data-level="11.10.10" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#glossary"><i class="fa fa-check"></i><b>11.10.10</b> Glossary</a></li>
</ul></li>
<li class="chapter" data-level="11.11" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#data-assimilation-with-dart"><i class="fa fa-check"></i><b>11.11</b> Data assimilation with DART</a></li>
</ul></li>
<li class="part"><span><b>IV Appendix</b></span><ul>
<li class="chapter" data-level="11.12" data-path="02_demos_tutorials_workflows/01_installation/00_install_PEcAn_intro.html"><a href="#todo"><i class="fa fa-check"></i><b>11.12</b> TODO:</a></li>
<li class="chapter" data-level="11.13" data-path="available-meteorological-drivers.html"><a href="available-meteorological-drivers.html#faq"><i class="fa fa-check"></i><b>11.13</b> FAQ</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The Predictive Ecosystem Analyzer</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="pecan-manual-setup" class="section level1">
<h1><span class="header-section-number">4</span> Install PEcAn</h1>
<p>These instructions are provided to document how to install and setup PEcAn. It includes:</p>
<ul>
<li><a href="pecan-manual-setup.html#pecanvm">Installing and maintaining the PEcAn VM</a></li>
<li><a href="pecan-manual-setup.html#docker-index">PEcAn Docker</a></li>
<li><a href="pecan-manual-setup.html#osinstall">PEcAn OS specific installation</a></li>
</ul>
<p>The PEcAn code and necessary infrastructure can be obtained and compiled in different ways. This set of instructions will help facilitate your path and the steps necessary to move forward to have a fully a functioning PEcAn environment.</p>

<div id="pecanvm" class="section level2">
<h2><span class="header-section-number">4.1</span> PEcAn Virtual Machine</h2>
<p>This section includes the following VM related documentation:
<a href="pecan-manual-setup.html#maintain-vm">Maintaining your PEcAn VM</a>
<a href="pecan-manual-setup.html#ssh-vm">Connecting to the VM via SSH</a>
<a href="pecan-manual-setup.html#ssh-vm-bety">Connecting to bety on the VM via SSh</a>
<a href="pecan-manual-setup.html#awsvm">Using Amazon Web Services for a VM (AWS)</a>
<a href="pecan-manual-setup.html#createvm">Creating a Virtual Machine</a>
<a href="pecan-manual-setup.html#vm-dektop-conversion">VM Desktop Conversion</a>
<a href="pecan-manual-setup.html#install-rstudio">Install RStudio Desktop</a></p>
<p>The PEcAn virtual machine consists of all of PEcAn pre-compiled within a Linux operating system and saved in a “virtual machine” (VM). Virtual machines allow for running consistent set-ups without worrying about differences between operating systems, library dependencies, compiling the code, etc.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Install VirtualBox</strong> This is the software that runs the virtual machine. You can find the download link and instructions at <a href="http://www.virtualbox.org" class="uri">http://www.virtualbox.org</a>. <em>NOTE: On Windows you may see a warning about Logo testing, it is okay to ignore the warning.</em></p></li>
<li><p><strong>Download the PEcAn VM</strong> You can find the download link at <a href="http://opensource.ncsa.illinois.edu/projects/artifacts.php?key=PECAN" class="uri">http://opensource.ncsa.illinois.edu/projects/artifacts.php?key=PECAN</a>, under the “<strong>Files</strong>” header. Click the “.ova” file to begin the download. Note that the file is ~7 GB, so this download can take several minutes to hours depending on your connection speed. Also, the VM requires &gt;4 GB of RAM to operate correctly. Please check current usage of RAM and shutdown processes as needed.</p></li>
<li><p><strong>Import the VM</strong> Once the download is complete, open VirtualBox. In the VirtualBox menus, go to “File” → “Import Appliance” and locate the downloaded “.ova” file.</p></li>
</ol>
<p>For Virtualbox version 5.x: In the Appliance Import Settings, make sure you select “Reinitialize the MAC address of all network cards” (picture below). This is not selected by default and can result in networking issues since multiple machines might claim to have the same network MAC Address.</p>
<p><img src="figures/pic1.jpg" width="259" style="display: block; margin: auto;" /></p>
<p>For Virtualbox versions starting with 6.0, there is a slightly different interface (see figure). Select “Generate new MAC addresses for all network adapters” from the MAC Address Policy:</p>
<p><img src="figures/pic1v2.png" width="510" style="display: block; margin: auto;" /></p>
<p>NOTE: If you experience network connection difficulties in the VM with this enabled, try re-importing the VM without this setting selected).</p>
<p>Finally, click “Import” to build the Virtual Machine from its image.</p>
<ol start="4" style="list-style-type: decimal">
<li><strong>Launch PEcAn</strong> Double click the icon for the PEcAn VM. A terminal window will pop up showing the machine booting up which may take a minute. It is done booting when you get to the <code>pecan login:</code> prompt. You do not need to login as the VM behaves like a server that we will be accessing through you web browser. Feel free to minimize the VM window.</li>
</ol>
<ul>
<li>If you <em>do</em> want to login to the VM, the credentials are as follows: <code>username: carya</code>, <code>password: illinois</code> (after the pecan tree, [Carya illinoinensis][pecan-wikipedia]).</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li><strong>Open the PEcAn web interface</strong> With the VM running in the background, open any web browser on the same machine and navigate to <code>localhost:6480/pecan/</code> to start the PEcAn workflow. (NOTE: The trailing backslash may be necessary depending on your browser)</li>
</ol>
<ul>
<li>To ssh into the VM, open up a terminal on your machine and execute <code>ssh -l carya -p 6422 localhost</code>. Username and password are the same as when you log into the machine.</li>
</ul>
<div id="maintain-vm" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Maintaining your PEcAn VM</h3>
<p>The PEcAn VM is distributed with specific versions of PEcAn compiled. However, you do not need to constantly download the VM in order to update your code and verion of BETY. To update and maintain your code you can follow the steps found in the Developer section in <span id="updatepecan">Updating PecAn and Code and BETY Database</span></p>
</div>
<div id="working-with-vm" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Working with the VM</h3>
<div id="ssh-vm" class="section level4">
<h4><span class="header-section-number">4.1.2.1</span> Connecting to the VM via SSH</h4>
<p>Once the VM is running anywhere on your machine, you can connect to it from a separate terminal via SSH as follows:</p>
<pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">ssh</span> -p 6422 carya@localhost</code></pre>
<p>You will be prompted for a password. Like everywhere else in PEcAn, the username is <code>carya</code> and the password is <code>illinois</code>. The same password is used for any system maintenance you wish to do on the VM via <code>sudo</code>.</p>
<p>As a shortcut, you can add the following to your <code>~/.ssh/config</code> file (or create one if it does not exist).</p>
<pre><code>Host pecan-vm
    Hostname localhost
    Port 6422
    user carya
    ForwardX11Trusted yes</code></pre>
<p>This will allow you to SSH into the VM with the simplified command, <code>ssh pecan-vm</code>.</p>
</div>
<div id="ssh-vm-bety" class="section level4">
<h4><span class="header-section-number">4.1.2.2</span> Connecting to bety on the VM via SSh</h4>
<p>Sometimes, you may want to develop code locally but connect to an instance of Bety on the VM.
To do this, first open a new terminal and connect to the VM while enabling port forwarding (with the <code>-L</code> flag) and setting XXXX to any available port (more or less any 4 digit number – a reasonable choice is 3333).</p>
<pre><code>ssh -L XXXX:localhost:5432 carya@localhost:6422</code></pre>
<p>This makes port XXXX on the local machine match port 5432 on the VM.
This means that connecting to <code>localhost:XXXX</code> will give you access to Bety on the VM.</p>
<p>To test this on the command line, try the following command, which, if successful, will drop you into the <code>psql</code> console.</p>
<pre><code>psql -d bety -U bety -h localhost -p XXXX</code></pre>
<p>To test this in R, open a Postgres using the analogous parameters:</p>
<pre><code>library(RPostgres)
con &lt;- dbConnect(
  Postgres(),
  user = &quot;bety&quot;,
  password = &quot;bety&quot;,
  dbname = &quot;bety&quot;,
  host = &quot;localhost&quot;,
  port = XXXX
  )
dbListTables(con)   # This should return a vector of bety tables</code></pre>
<p>Note that the same general approach will work on any Bety server where port forwarding is enabled.</p>
</div>
</div>
<div id="awsvm" class="section level3">
<h3><span class="header-section-number">4.1.3</span> Using Amazon Web Services for a VM (AWS)</h3>
<p>Login to <a href="http://console.aws.amazon.com/">Amazon Web Services (AWS)</a> and select the EC2 Dashboard. If this is your first time using AWS you will need to set up an account before you are able to access the EC2 Dashboard. Important: You will need a credit card number and access to a phone to be able to verify AWS account registration. AWS is free for one year.</p>
<ol style="list-style-type: decimal">
<li>Choose AMI</li>
</ol>
<ul>
<li>On the top right next to your name, make sure the location setting is on U.S. East (N. Virginia), not U.S. West (Oregon)</li>
<li>On the left click, click on EC2 (Virtual servers), then click on “AMIs”, also on the left</li>
<li>In the search window toggle to change “Owned by me” to “Public images”</li>
<li>Type “pecan” into the search window</li>
<li>Click on the toggle button on the left next to PEcAn1.4.6</li>
<li>Click on the “Launch” button at the top</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Choose an Instance Type</li>
</ol>
<ul>
<li>Select what type of machine you want to run. For this demo the default, t2.micro, will be adequate. Be aware that different machine types incur very different costs, from 1.3 cents/hour to over $5/hr <a href="https://aws.amazon.com/ec2/pricing/" class="uri">https://aws.amazon.com/ec2/pricing/</a><br />
</li>
<li>Select t2.micro, then click “Next: Configure Instance Details”</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Configure Instance Details</li>
</ol>
<ul>
<li>The defaults are OK. Click “Next: Add Storage”</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Add Storage</li>
</ol>
<ul>
<li>The defaults are OK. Click “Next: Tag Instance”</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li>Tag Instance</li>
</ol>
<ul>
<li>You can name your instance if you want. Click “Next: Configure Security Group”</li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li>Configure Security Group</li>
</ol>
<ul>
<li>You will need to add two new rules:</li>
<li>Click “Add Rule” then select “HTTP” from the pull down menu. This rule allows you to access the webserver on PEcAn.</li>
<li>Click “Add Rule”, leave the pull down on “Custom TCP Rule”, and then change the Port Range from 0 to 8787. Set “Source” to Anywhere. This rule allows you to access RStudio Server on PEcAn.</li>
<li>Click “Review and Launch” . You will then see this pop-up:</li>
</ul>
<p><img src="figures/pic2.jpg" width="343" style="display: block; margin: auto;" /></p>
<p>Select the default drive volume type and click Next</p>
<ol start="7" style="list-style-type: decimal">
<li>Review and Launch</li>
</ol>
<ul>
<li>Review the settings and then click “Launch”, which will pop up a select/create Key Pair window.</li>
</ul>
<ol start="8" style="list-style-type: decimal">
<li>Key Pair</li>
</ol>
<ul>
<li>Select “Create a new key pair” and give it a name. You won’t actually need this key unless you need to SSH into your PEcAn server, but AWS requires you to create one. Click on “Download Key Pair” then on “Launch Instances”. Next click on “View Instances” at the bottom of the following page.</li>
</ul>
<p><img src="figures/pic3.jpg" width="682" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Instances</li>
</ol>
<ul>
<li>You will see the status of your PEcAn VM, which will take a minute to boot up. Wait until the Instance State reads “running”. The most important piece of information here is the Public IP, which is the URL you will need in order to access your PEcAn instance from within your web browser (see Demo 1 below).</li>
<li>Be aware that it often takes ~1 hr for AWS instances to become fully operational, so if you get an error when you put the Public IP in you web browser, most of the time you just need to wait a bit longer.
Congratulations! You just started a PEcAn server in the “cloud”!</li>
</ul>
<ol start="10" style="list-style-type: decimal">
<li>When you are done using PEcAn, you will want to return to the “Instances” menu to turn off your VM.</li>
</ol>
<ul>
<li>To STOP the instance (which will turn the machine off but keep your work), select your PEcAn instance and click Actions &gt; Instance state &gt; Stop. Be aware that a stopped instance will still accrue a small storage cost on AWS. To restart this instance at any point in the future you do not want to repeat all the steps above, but instead you just need to select your instance and then click Actions &gt; Instance state &gt; Start</li>
<li>To TERMINATE the instance (which will DELETE your PEcAn machine), select your instance and click Actions &gt; Instance state &gt; Terminate. Terminated instances will not incur costs. In most cases you will also want to go to the Volumes menu and delete the storage associated with your PEcAn VM.Remember, AWS is free for one year, but will automatically charge a fee in second year if account is not cancelled.</li>
</ul>
</div>
<div id="createvm" class="section level3">
<h3><span class="header-section-number">4.1.4</span> Creating a Virtual Machine</h3>
<p>First create virtual machine</p>
<pre><code># ----------------------------------------------------------------------
# CREATE VM USING FOLLOWING:
# - VM NAME  = PEcAn
# - CPU      = 2
# - MEMORY   = 2GB 
# - DISK     = 100GB
# - HOSTNAME = pecan
# - FULLNAME = PEcAn Demo User
# - USERNAME = xxxxxxx
# - PASSWORD = yyyyyyy
# - PACKAGE  = openssh
# ----------------------------------------------------------------------</code></pre>
<p>To enable tunnels run the following on the host machine:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">VBoxManage</span> modifyvm <span class="st">&quot;PEcAn&quot;</span> --natpf1 <span class="st">&quot;ssh,tcp,,6422,,22&quot;</span>
<span class="ex">VBoxManage</span> modifyvm <span class="st">&quot;PEcAn&quot;</span> --natpf1 <span class="st">&quot;www,tcp,,6480,,80&quot;</span></code></pre>
<p>Make sure machine is up to date.</p>
<p>UBUNTU</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> apt-get update
<span class="fu">sudo</span> apt-get -y dist-upgrade
<span class="fu">sudo</span> reboot</code></pre>
<p>CENTOS/REDHAT</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> yum -y update
<span class="fu">sudo</span> reboot</code></pre>
<p>Install compiler and other packages needed and install the tools.</p>
<p>UBUNTU</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> apt-get -y install build-essential linux-headers-server dkms</code></pre>
<p>CENTOS/REDHAT</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> yum -y groupinstall <span class="st">&quot;Development Tools&quot;</span>
<span class="fu">sudo</span> yum -y install wget</code></pre>
<p>Install Virtual Box additions for better integration</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> mount /dev/cdrom /mnt
<span class="fu">sudo</span> /mnt/VBoxLinuxAdditions.run
<span class="fu">sudo</span> umount /mnt
<span class="fu">sudo</span> usermod -a -G vboxsf carya</code></pre>
<p><strong>Finishing up the machine</strong></p>
<p><strong>Add a message to the login:</strong></p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -s
<span class="bu">export</span> <span class="va">PORT=$(</span> <span class="fu">hostname</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/pecan//&#39;</span> <span class="va">)</span>
<span class="fu">cat</span> <span class="op">&gt;</span> /etc/motd <span class="op">&lt;&lt; EOF</span>
PEcAn version 1.4.3

For more information about:
Pecan    - http://pecanproject.org
BETY     - http://www.betydb.org

For a list of all models currently navigate [here](../users_guide/basic_users_guide/models_table.md)


You can access this system using a webbrowser at
 http://&lt;hosting machine&gt;:<span class="va">${PORT}</span>80/
or using SSH at
 ssh -l carya -p <span class="va">${PORT}</span>22 &lt;hosting machine&gt;
where &lt;hosting machine&gt; is the machine where the VM runs on.
<span class="op">EOF</span>
<span class="bu">exit</span></code></pre>
<p><strong>Finishing up</strong></p>
<p>Script to clean the VM and remove as much as possible history <a href="http://isda.ncsa.uiuc.edu/~kooper/EBI/cleanvm.sh">cleanvm.sh</a></p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">wget</span> -O ~/cleanvm.sh http://isda.ncsa.uiuc.edu/~kooper/EBI/cleanvm.sh
<span class="fu">chmod</span> 755 ~/cleanvm.sh</code></pre>
<p>Make sure machine has SSH keys <a href="http://isda.ncsa.illinois.edu/~kooper/EBI/rc.local">rc.local</a></p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> wget -O /etc/rc.local http://isda.ncsa.illinois.edu/~kooper/EBI/rc.local</code></pre>
<p>Change the resolution of the console</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> sed -i -e <span class="st">&#39;s/#GRUB_GFXMODE=640x480/GRUB_GFXMODE=1024x768/&#39;</span> /etc/default/grub
<span class="fu">sudo</span> update-grub</code></pre>
<p>Once all done, stop the virtual machine</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">history</span> -c <span class="kw">&amp;&amp;</span> <span class="va">${HOME}</span><span class="ex">/cleanvm.sh</span></code></pre>
</div>
<div id="vm-dektop-conversion" class="section level3">
<h3><span class="header-section-number">4.1.5</span> VM Desktop Conversion</h3>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> apt-get update
<span class="fu">sudo</span> apt-get install xfce4 xorg</code></pre>
<p>For a more refined desktop environment, try</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> apt-get install --no-install-recommends xubuntu-desktop </code></pre>
<ul>
<li>replace <code>xubuntu-</code> with <code>ubuntu-</code>, <code>lubuntu-</code>, or other preferred desktop enviornment</li>
<li>the <code>--no-install-recommends</code> eliminates additional applications, removing it will add a word processor, a browser, and lots of other applications included in the default operating system.</li>
</ul>
<p>Reinstall Virtual Box additions for better integration adding X/mouse support</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> mount /dev/cdrom /mnt
<span class="fu">sudo</span> /mnt/VBoxLinuxAdditions.run
<span class="fu">sudo</span> umount /mnt</code></pre>
<div id="install-rstudio" class="section level4">
<h4><span class="header-section-number">4.1.5.1</span> Install RStudio Desktop</h4>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">wget</span> http://download1.rstudio.org/rstudio-0.97.551-amd64.deb
<span class="ex">apt-get</span> install libjpeg621
<span class="ex">dpkg</span> -i rstudio-*
<span class="fu">rm</span> rstudio-*</code></pre>

</div>
</div>
<div id="aws-setup" class="section level3">
<h3><span class="header-section-number">4.1.6</span> AWS Setup</h3>
<p>***********Mirror of earlier section in installation section?*********************</p>
</div>
<div id="porting-vm-to-aws" class="section level3">
<h3><span class="header-section-number">4.1.7</span> Porting VM to AWS</h3>
<p>The following are Mike’s rough notes from a first attempt to port the PEcAn VM to the AWS. This was done on a Mac</p>
<p>These notes are based on following the instructions <a href="http://www.rittmanmead.com/2014/09/obiee-sampleapp-in-the-cloud-importing-virtualbox-machines-to-aws-ec2/">here</a></p>
<div id="convert-pecan-vm" class="section level4">
<h4><span class="header-section-number">4.1.7.1</span> Convert PEcAn VM</h4>
<p>AWS allows upload of files as VMDK but the default PEcAn VM is in OVA format</p>
<ol style="list-style-type: decimal">
<li><p>If you haven’t done so already, download the <a href="http://isda.ncsa.illinois.edu/download/index.php?project=PEcAn&amp;sort=category">PEcAn VM</a></p></li>
<li><p>Split the OVA file into OVF and VMDK files</p></li>
</ol>
<pre><code>tar xf &lt;ovafile&gt;</code></pre>
</div>
<div id="set-up-an-account-on-aws" class="section level4">
<h4><span class="header-section-number">4.1.7.2</span> Set up an account on <a href="http://aws.amazon.com/">AWS</a></h4>
<p>After you have an account you need to set up a user and save your <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/ManagingCredentials.html">access key and secret key</a></p>
<p>In my case I created a user named ‘carya’</p>
<p>Note: the key that ended up working had to be made at <a href="https://console.aws.amazon.com/iam/home#security_credential" class="uri">https://console.aws.amazon.com/iam/home#security_credential</a>, not the link above.</p>
</div>
<div id="install-ec2-command-line-tools" class="section level4">
<h4><span class="header-section-number">4.1.7.3</span> Install <a href="http://docs.aws.amazon.com/AWSEC2/latest/CommandLineReference/set-up-ec2-cli-linux.html">EC2 command line tools</a></h4>
<pre><code>wget http://s3.amazonaws.com/ec2-downloads/ec2-api-tools.zip

sudo mkdir /usr/local/ec2

sudo unzip ec2-api-tools.zip -d /usr/local/ec2</code></pre>
<p>If need be, download and install <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK</a></p>
<pre><code>export JAVA_HOME=$(/usr/libexec/java_home)

export EC2_HOME=/usr/local/ec2/ec2-api-tools-&lt;version&gt;

export PATH=$PATH:$EC2_HOME/bin</code></pre>
<p>Then set your user credentials as environment variables:</p>
<p><code>export AWS_ACCESS_KEY=xxxxxxxxxxxxxx</code></p>
<p><code>export AWS_SECRET_KEY=xxxxxxxxxxxxxxxxxxxxxx</code></p>
<p>Note: you may want to add all the variables set in the above EXPORT commands above into your .bashrc or equivalent.</p>
</div>
<div id="create-an-aws-s3-bucket-to-upload-vm-to" class="section level4">
<h4><span class="header-section-number">4.1.7.4</span> Create an AWS S3 ‘bucket’ to upload VM to</h4>
<p>Go to <a href="https://console.aws.amazon.com/s3" class="uri">https://console.aws.amazon.com/s3</a> and click “Create Bucket”</p>
<p>In my case I named the bucket ‘pecan’</p>
</div>
<div id="upload" class="section level4">
<h4><span class="header-section-number">4.1.7.5</span> Upload</h4>
<p>In the code below, make sure to change the PEcAn version, the name of the bucket, and the name of the region. Make sure that the PEcAn version matches the one you downloaded.</p>
<p>Also, you may want to choose a considerably larger instance type. The one chosen below is that corresponding to the AWS Free Tier</p>
<pre><code>ec2-import-instance PEcAn_1.2.6-disk1.vmdk --instance-type t2.micro --format VMDK --architecture x86_64 --platform Linux --bucket pecan --region us-east-1 --owner-akid $AWS_ACCESS_KEY --owner-sak $AWS_SECRET_KEY</code></pre>
<p>Make sure to note the ID of the image since you’ll need it to check the VM status. Once the image is uploaded it will take a while (typically about an hour) for Amazon to convert the image to one it can run. You can check on this progress by running</p>
<pre><code>ec2-describe-conversion-tasks &lt;image.ID&gt;</code></pre>
</div>
<div id="configuring-the-vm" class="section level4">
<h4><span class="header-section-number">4.1.7.6</span> Configuring the VM</h4>
<p>On the EC2 management webpage, <a href="https://console.aws.amazon.com/ec2" class="uri">https://console.aws.amazon.com/ec2</a>, if you select <strong>Instances</strong> on the left hand side (LHS) you should be able to see your new PEcAn image as an option under Launch Instance.</p>
<p>Before launching, you will want to update the firewall to open up additional ports that PEcAn needs – specifically port 80 for the webpage. Port 22 (ssh/sftp) should be open by default. Under “Security Groups” select “Inbound” then “Edit” and then add “HTTP”.</p>
<p>Select “Elastic IPs” on the LHS, and “Allocate New Address” in order to create a public IP for your VM.</p>
<p>Next, select “Network Interfaces” on the LHS and then under Actions select “Associate Addresses” then choose the Elastic IP you just created.</p>
<p>See also <a href="http://docs.aws.amazon.com/AmazonVPC/latest/GettingStartedGuide/GetStarted.html" class="uri">http://docs.aws.amazon.com/AmazonVPC/latest/GettingStartedGuide/GetStarted.html</a></p>
</div>
</div>
<div id="set-up-multiple-instances-optional" class="section level3">
<h3><span class="header-section-number">4.1.8</span> Set up multiple instances (optional)</h3>
<p>For info on setting up multiple instances with load balancing see: <a href="http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/gs-ec2VPC.html" class="uri">http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/gs-ec2VPC.html</a></p>
<p>Select “Load Balancers” on the LHS, click on “Create Load Balancer”, follow Wizard keeping defaults.</p>
<p>To be able to launch multiple VMs: Under “Instances” convert VM to an Image. When done, select Launch, enable multiple instances, and associate with the previous security group. Once running, go back to “Load Balancers” and add the instances to the load balancer. Each instance can be accessed individually by it’s own public IP, but external users should access the system more generally via the Load Balancers DNS.</p>
<div id="booting-the-vm" class="section level4">
<h4><span class="header-section-number">4.1.8.1</span> Booting the VM</h4>
<p>Return to “Instances” using the menu on the LHS.</p>
<p>To boot the VM select “Actions” then “Instance State” then “Start”. In the future, once you have the VM loaded and configured this last step is the only one you will need to repeat to turn your VM on and off.</p>
<p>The menu provided should specify the Public IP where the VM has launched</p>

</div>
</div>
</div>
<div id="shiny-setup" class="section level2">
<h2><span class="header-section-number">4.2</span> Shiny Setup</h2>
<p>Installing and configuring Shiny for PEcAn
authors - Alexey Shiklomanov
- Rob Kooper</p>
<p><strong>NOTE: Instructions are only tested for CentOS 6.5 and Ubuntu 16.04</strong>
<strong>NOTE: Pretty much every step here requires root access.</strong></p>
<div id="install-the-shiny-r-package-and-shiny-server" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Install the Shiny R package and Shiny server</h3>
<p>Follow the instructions on the <a href="https://www.rstudio.com/products/shiny/download-server/">Shiny download page</a> for the operating system you are using.</p>
</div>
<div id="modify-the-shiny-configuration-file" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Modify the shiny configuration file</h3>
<p>The Shiny configuration file is located in <code>/etc/shiny-server/shiny-server.conf</code>. Comment out the entire file and add the following, replacing <code>&lt;username&gt;</code> with your user name and <code>&lt;location&gt;</code> with the URL location you want for your app. This will allow you to run Shiny apps from your web browser at <a href="https://your.server.edu/shiny/your-location" class="uri">https://your.server.edu/shiny/your-location</a></p>
<pre><code>run as shiny;
server {
    listen 3838;
    location /&lt;location&gt;/ {
        run as &lt;username&gt;;
        site_dir /path/to/your/shiny/app;
        log_dir /var/log/shiny-server;
        directory_index on;
    }
}</code></pre>
<p>For example, my configuration on the old test-pecan looks like this.</p>
<pre><code>run as shiny;
server {
    listen 3838;
    location /ashiklom/ {
        run as ashiklom;
        site_dir /home/ashiklom/fs-data/pecan/shiny/;
        log_dir /var/log/shiny-server;
        directory_index on;
    }
}</code></pre>
<p>…and I can access my Shiny apps at, for instance, <a href="https://test-pecan.bu.edu/shiny/ashiklom/workflowPlots" class="uri">https://test-pecan.bu.edu/shiny/ashiklom/workflowPlots</a>.</p>
<p>You can add as many <code>location &lt;loc&gt; { ... }</code> fields as you would like.</p>
<pre><code>run as shiny;
server {
    listen 3838;
    location /ashiklom/ {
        ...
    }
    location /bety/ {
        ...
    }
}</code></pre>
<p>If you change the configuration, for example to add a new location, you will need to restart Shiny server.
<em>If you are setting up a new instance of Shiny</em>, skip this step and continue with the guide, since there are a few more steps to get Shiny working.
<em>If there is an instance of Shiny already running</em>, you can restart it with:</p>
<pre><code>## On CentOS
sudo service shiny-server stop
sudo service shiny-server start

## On Ubuntu
sudo systemctl stop shiny-server.service
sudo systemctl start shiny-server.service</code></pre>
</div>
<div id="set-the-apache-proxy" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Set the Apache proxy</h3>
<p>Create a file with the following name, based on the version of the operating system you are using:</p>
<ul>
<li>Ubuntu 16.04 (pecan1, pecan2, test-pecan) – <code>/etc/apache2/conf-available/shiny.conf</code></li>
<li>CentOS 6.5 (psql-pecan) – <code>/etc/httpd/conf.d/shiny.conf</code></li>
</ul>
<p>Into this file, add the following:</p>
<pre><code>ProxyPass           /shiny/ http://localhost:3838/
ProxyPassReverse    /shiny/ http://localhost:3838/
RedirectMatch permanent ^/shiny$ /shiny/</code></pre>
<div id="ubuntu-only-enable-the-new-shiny-configuration" class="section level4">
<h4><span class="header-section-number">4.2.3.1</span> <strong>Ubuntu only:</strong> Enable the new shiny configuration</h4>
<pre><code>sudo a2enconf shiny</code></pre>
<p>This will create a symbolic link to the newly created <code>shiny.conf</code> file inside the <code>/etc/apache2/conf-enabled</code> directory.
You can do <code>ls -l /etc/apache2/conf-enabled</code> to confirm that this worked.</p>
</div>
</div>
<div id="enable-and-start-the-shiny-server-and-restart-apache" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Enable and start the shiny server, and restart apache</h3>
<div id="on-centos" class="section level4">
<h4><span class="header-section-number">4.2.4.1</span> On CentOS</h4>
<pre><code>sudo ln -s /opt/shiny-server/config/init.d/redhat/shiny-server /etc/init.d
sudo service shiny-server stop
sudo service shiny-server start
sudo service httpd restart</code></pre>
<p>You can check that Shiny is running with <code>service shiny-server status</code>.</p>
</div>
<div id="on-ubuntu" class="section level4">
<h4><span class="header-section-number">4.2.4.2</span> On Ubuntu</h4>
<p>Enable the Shiny server service.
This will make sure Shiny runs automatically on startup.</p>
<pre><code>sudo systemctl enable shiny-server.service</code></pre>
<p>Restart Apache.</p>
<pre><code>sudo apachectl restart</code></pre>
<p>Start the Shiny server.</p>
<pre><code>sudo systemctl start shiny-server.service</code></pre>
<p>If there are problems, you can stop the <code>shiny-server.service</code> with…</p>
<pre><code>sudo systemctl stop shiny-server.service</code></pre>
<p>…and then use <code>start</code> again to restart it.</p>
</div>
</div>
<div id="troubleshooting" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Troubleshooting</h3>
<p>Refer to the log files for shiny (<code>/var/log/shiny-server.log</code>) and httpd (on CentOS, <code>/var/log/httpd/error-log</code>; on Ubuntu, <code>/var/log/apache2/error-log</code>).</p>
</div>
<div id="further-reading" class="section level3">
<h3><span class="header-section-number">4.2.6</span> Further reading</h3>
<ul>
<li><a href="http://docs.rstudio.com/shiny-server/">Shiny server configuration reference</a></li>
</ul>

</div>
<div id="thredds-setup" class="section level3">
<h3><span class="header-section-number">4.2.7</span> Thredds Setup</h3>
<p>Installing and configuring Thredds for PEcAn
authors - Rob Kooper</p>
<p><strong>NOTE: Instructions are only tested for Ubuntu 16.04 on the VM, if you have instructions for CENTOS/RedHat please update this documentation</strong>
<strong>NOTE: Pretty much every step here requires root access.</strong></p>
</div>
<div id="install-the-tomcat-8-and-thredds-webapp" class="section level3">
<h3><span class="header-section-number">4.2.8</span> Install the Tomcat 8 and Thredds webapp</h3>
<p>The Tomcat 8 server can be installed from the default Ubuntu repositories. The thredds webapp will be downloaded and installed from unidata.</p>
<div id="ubuntu" class="section level4">
<h4><span class="header-section-number">4.2.8.1</span> Ubuntu</h4>
<p>First step is to install Tomcat 8 and configure it. The flag <code>-Dtds.content.root.path</code> should point to the location of where the thredds folder is located. This needs to be writeable by the user for tomcat. <code>-Djava.security.egd</code> is a special flag to use a different random number generator for tomcat. The default would take to long to generate a random number.</p>
<pre><code>apt-get -y install tomcat8 openjdk-8-jdk
echo JAVA_OPTS=\&quot;-Dtds.content.root.path=/home/carya \${JAVA_OPTS}\&quot; &gt;&gt; /etc/default/tomcat8
echo JAVA_OPTS=\&quot;-Djava.security.egd=file:/dev/./urandom \${JAVA_OPTS}\&quot; &gt;&gt; /etc/default/tomcat8
service tomcat8 restart</code></pre>
<p>Next is to install the webapp.</p>
<pre><code>mkdir /home/carya/thredds
chmod 777 /home/carya/thredds

wget -O /var/lib/tomcat8/webapps/thredds.war ftp://ftp.unidata.ucar.edu/pub/thredds/4.6/current/thredds.war</code></pre>
<p>Finally we configure Apache to prox the thredds server</p>
<pre><code>cat &gt; /etc/apache2/conf-available/thredds.conf &lt;&lt; EOF
ProxyPass        /thredds/ http://localhost:8080/thredds/
ProxyPassReverse /thredds/ http://localhost:8080/thredds/
RedirectMatch permanent ^/thredds$ /thredds/
EOF
a2enmod proxy_http
a2enconf thredds
service apache2 reload</code></pre>
</div>
<div id="customize-the-thredds-server" class="section level4">
<h4><span class="header-section-number">4.2.8.2</span> Customize the Thredds server</h4>
<p>To customize the thredds server for your installation edit the file in /home/carya/thredds/threddsConfig.xml. For example the following file is included in the VM.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;threddsConfig&gt;

  &lt;!-- all options are commented out in standard install - meaning use default values --&gt;
  &lt;!-- see http://www.unidata.ucar.edu/software/thredds/current/tds/reference/ThreddsConfigXMLFile.html --&gt;
  &lt;serverInformation&gt;
    &lt;name&gt;PEcAn&lt;/name&gt;
    &lt;logoUrl&gt;/pecan/images/pecan_small.jpg&lt;/logoUrl&gt;
    &lt;logoAltText&gt;PEcAn&lt;/logoAltText&gt;

    &lt;abstract&gt;Scientific Data&lt;/abstract&gt;
    &lt;keywords&gt;meteorology, atmosphere, climate, ocean, earth science&lt;/keywords&gt;
    
    &lt;contact&gt;
      &lt;name&gt;Rob Kooper&lt;/name&gt;
      &lt;organization&gt;NCSA&lt;/organization&gt;
      &lt;email&gt;kooper@illinois.edu&lt;/email&gt;
      &lt;!--phone&gt;&lt;/phone--&gt;
    &lt;/contact&gt;
    &lt;hostInstitution&gt;
      &lt;name&gt;PEcAn&lt;/name&gt;
      &lt;webSite&gt;http://www.pecanproject.org/&lt;/webSite&gt;
      &lt;logoUrl&gt;/pecan/images/pecan_small.jpg&lt;/logoUrl&gt;
      &lt;logoAltText&gt;PEcAn Project&lt;/logoAltText&gt;
    &lt;/hostInstitution&gt;
  &lt;/serverInformation&gt;

  &lt;!--
  The &lt;catalogRoot&gt; element:
  For catalogs you don&#39;t want visible from the /thredds/catalog.xml chain
  of catalogs, you can use catalogRoot elements. Each catalog root config
  catalog is crawled and used in configuring the TDS.

  &lt;catalogRoot&gt;myExtraCatalog.xml&lt;/catalogRoot&gt;
  &lt;catalogRoot&gt;myOtherExtraCatalog.xml&lt;/catalogRoot&gt;
  --&gt;

  &lt;!--
   * Setup for generated HTML pages.
   *
   * NOTE: URLs may be absolute or relative, relative URLs must be relative
   * to the webapp URL, i.e., http://server:port/thredds/.
    --&gt;
  &lt;htmlSetup&gt;
    &lt;!--
     * CSS documents used in generated HTML pages.
     * The CSS document given in the &quot;catalogCssUrl&quot; element is used for all pages
     * that are HTML catalog views. The CSS document given in the &quot;standardCssUrl&quot;
     * element is used in all other generated HTML pages.
     * --&gt;
    &lt;standardCssUrl&gt;tds.css&lt;/standardCssUrl&gt;
    &lt;catalogCssUrl&gt;tdsCat.css&lt;/catalogCssUrl&gt;
    &lt;openDapCssUrl&gt;tdsDap.css&lt;/openDapCssUrl&gt;

    &lt;!--
     * The Google Analytics Tracking code you would like to use for the
     * webpages associated with THREDDS. This will not track WMS or DAP
     * requests for data, only browsing the catalog.
    --&gt;
    &lt;googleTrackingCode&gt;&lt;/googleTrackingCode&gt;

  &lt;/htmlSetup&gt;
  
  &lt;!-- 
    The &lt;TdsUpdateConfig&gt; element controls if and how the TDS checks
    for updates. The default is for the TDS to check for the current
    stable and development release versions, and to log that information
    in the TDS serverStartup.log file as INFO entries.

  &lt;TdsUpdateConfig&gt;
     &lt;logVersionInfo&gt;true&lt;/logVersionInfo&gt;
  &lt;/TdsUpdateConfig&gt;
  --&gt;
   
  &lt;!--
   The &lt;CORS&gt; element controls Cross-Origin Resource Sharing (CORS).
   CORS is a way to allow a website (such as THREDDS) to open up access
   to resources to web pages and applications running on a different domain.
   One example would be allowing a web-application to use fonts from
   a separate host. For TDS, this can allow a javascript app running on a
   different site to access data on a THREDDS server.
   For more information see: https://en.wikipedia.org/wiki/Cross-origin_resource_sharing
   The elements below represent defaults. Only the &lt;enabled&gt; tag is required
   to enable CORS. The default allowed origin is &#39;*&#39;, which allows sharing
   to any domain.
  &lt;CORS&gt;
    &lt;enabled&gt;false&lt;/enabled&gt;
    &lt;maxAge&gt;1728000&lt;/maxAge&gt;
    &lt;allowedMethods&gt;GET&lt;/allowedMethods&gt;
    &lt;allowedHeaders&gt;Authorization&lt;/allowedHeaders&gt;
    &lt;allowedOrigin&gt;*&lt;/allowedOrigin&gt;
  &lt;/CORS&gt;
  --&gt;

  &lt;!--
   The &lt;CatalogServices&gt; element:
   - Services on local TDS served catalogs are always on.
   - Services on remote catalogs are set with the allowRemote element
   below. They are off by default (recommended).
   --&gt;
  &lt;CatalogServices&gt;
    &lt;allowRemote&gt;false&lt;/allowRemote&gt;
  &lt;/CatalogServices&gt;

  &lt;!--
  Configuring the CDM (netcdf-java library)
  see http://www.unidata.ucar.edu/software/netcdf-java/reference/RuntimeLoading.html

  &lt;nj22Config&gt;
    &lt;ioServiceProvider class=&quot;edu.univ.ny.stuff.FooFiles&quot;/&gt;
    &lt;coordSysBuilder convention=&quot;foo&quot; class=&quot;test.Foo&quot;/&gt;
    &lt;coordTransBuilder name=&quot;atmos_ln_sigma_coordinates&quot; type=&quot;vertical&quot; class=&quot;my.stuff.atmosSigmaLog&quot;/&gt;
    &lt;typedDatasetFactory datatype=&quot;Point&quot; class=&quot;gov.noaa.obscure.file.Flabulate&quot;/&gt;
  &lt;/nj22Config&gt;
  --&gt;

  &lt;!--
  CDM uses the DiskCache directory to store temporary files, like uncompressed files.
  &lt;DiskCache&gt;
    &lt;alwaysUse&gt;false&lt;/alwaysUse&gt;
    &lt;scour&gt;1 hour&lt;/scour&gt;
    &lt;maxSize&gt;1 Gb&lt;/maxSize&gt;
  &lt;/DiskCache&gt;
  --&gt;

  &lt;!--
  Caching open NetcdfFile objects.
  default is to allow 50 - 100 open files, cleanup every 11 minutes
  &lt;NetcdfFileCache&gt;
    &lt;minFiles&gt;50&lt;/minFiles&gt;
    &lt;maxFiles&gt;100&lt;/maxFiles&gt;
    &lt;scour&gt;11 min&lt;/scour&gt;
  &lt;/NetcdfFileCache&gt;
  --&gt;

  &lt;!--
  The &lt;HTTPFileCache&gt; element:
  allow 10 - 20 open datasets, cleanup every 17 minutes
  used by HTTP Range requests.
  &lt;HTTPFileCache&gt;
    &lt;minFiles&gt;10&lt;/minFiles&gt;
    &lt;maxFiles&gt;20&lt;/maxFiles&gt;
    &lt;scour&gt;17 min&lt;/scour&gt;
  &lt;/HTTPFileCache&gt;
  --&gt;

  &lt;!--
  Writing GRIB indexes.
  &lt;GribIndexing&gt;
    &lt;setExtendIndex&gt;false&lt;/setExtendIndex&gt;
    &lt;alwaysUseCache&gt;false&lt;/alwaysUseCache&gt;
  &lt;/GribIndexing&gt;
  --&gt;

  &lt;!--
  Persist joinNew aggregations to named directory. scour every 24 hours, delete stuff older than 90 days
  &lt;AggregationCache&gt;
    &lt;scour&gt;24 hours&lt;/scour&gt;
    &lt;maxAge&gt;90 days&lt;/maxAge&gt;
    &lt;cachePathPolicy&gt;NestedDirectory&lt;/cachePathPolicy&gt;
  &lt;/AggregationCache&gt;
  --&gt;

  &lt;!--
  How to choose the template dataset for an aggregation. latest, random, or penultimate
  &lt;Aggregation&gt;
    &lt;typicalDataset&gt;penultimate&lt;/typicalDataset&gt;
  &lt;/Aggregation&gt;
  --&gt;

  &lt;!--
  The Netcdf Subset Service is off by default.
  &lt;NetcdfSubsetService&gt;
    &lt;allow&gt;false&lt;/allow&gt;
    &lt;scour&gt;10 min&lt;/scour&gt;
    &lt;maxAge&gt;-1 min&lt;/maxAge&gt;
  &lt;/NetcdfSubsetService&gt;
  --&gt;

  &lt;!--
  &lt;Opendap&gt;
    &lt;ascLimit&gt;50&lt;/ascLimit&gt;
    &lt;binLimit&gt;500&lt;/binLimit&gt;
    &lt;serverVersion&gt;opendap/3.7&lt;/serverVersion&gt;
  &lt;/Opendap&gt;
    --&gt;
  
  &lt;!--
  The WCS Service is off by default.
  Also, off by default (and encouraged) is operating on a remote dataset.
  &lt;WCS&gt;
    &lt;allow&gt;false&lt;/allow&gt;
    &lt;allowRemote&gt;false&lt;/allowRemote&gt;
    &lt;scour&gt;15 min&lt;/scour&gt;
    &lt;maxAge&gt;30 min&lt;/maxAge&gt;
  &lt;/WCS&gt;
  --&gt;

  &lt;!--
  &lt;WMS&gt;
    &lt;allow&gt;false&lt;/allow&gt;
    &lt;allowRemote&gt;false&lt;/allowRemote&gt;
    &lt;maxImageWidth&gt;2048&lt;/maxImageWidth&gt;
    &lt;maxImageHeight&gt;2048&lt;/maxImageHeight&gt;
  &lt;/WMS&gt;
  --&gt;

  &lt;!--
  &lt;NCISO&gt;
    &lt;ncmlAllow&gt;false&lt;/ncmlAllow&gt;
    &lt;uddcAllow&gt;false&lt;/uddcAllow&gt;
    &lt;isoAllow&gt;false&lt;/isoAllow&gt;
  &lt;/NCISO&gt;
  --&gt;

  &lt;!-- CatalogGen service is off by default.
  &lt;CatalogGen&gt;
    &lt;allow&gt;false&lt;/allow&gt;
  &lt;/CatalogGen&gt;
   --&gt;

  &lt;!-- DLwriter service is off by default.
       As is support for operating on remote catalogs.
  &lt;DLwriter&gt;
    &lt;allow&gt;false&lt;/allow&gt;
    &lt;allowRemote&gt;false&lt;/allowRemote&gt;
  &lt;/DLwriter&gt;
   --&gt;

  &lt;!-- DqcService is off by default.
  &lt;DqcService&gt;
    &lt;allow&gt;false&lt;/allow&gt;
  &lt;/DqcService&gt;
   --&gt;

  &lt;!--
   Link to a Viewer application on the HTML page:
   &lt;Viewer&gt;my.package.MyViewer&lt;/Viewer&gt;
   --&gt;

   &lt;!--
   Add a DataSource - essentially an IOSP with access to Servlet request parameters
   &lt;datasetSource&gt;my.package.DatsetSourceImpl&lt;/datasetSource&gt;
   --&gt;

  &lt;!--
   set FeatureCollection logging
  &lt;FeatureCollection&gt;
     &lt;RollingFileAppender&gt;
       &lt;MaxFileSize&gt;1 MB&lt;/MaxFileSize&gt;
       &lt;MaxBackups&gt;5&lt;/MaxBackups&gt;
       &lt;Level&gt;INFO&lt;/Level&gt;
     &lt;/RollingFileAppender&gt;
  &lt;/FeatureCollection&gt;
  --&gt;

  &lt;!--
    Configure how the NetCDF-4 C library is discovered and used.
    libraryPath: The directory in which the native library is installed.
    libraryName: The name of the native library. This will be used to locate the proper .DLL, .SO, or .DYLIB file
      within the libraryPath directory.
    useForReading: By default, the native library is only used for writing NetCDF-4 files; a pure-Java layer is
      responsible for reading them. However, if this property is set to true, then it will be used for reading
      NetCDF-4 (and HDF5) files as well.
  --&gt;
  &lt;!--
  &lt;Netcdf4Clibrary&gt;
    &lt;libraryPath&gt;/usr/local/lib&lt;/libraryPath&gt;
    &lt;libraryName&gt;netcdf&lt;/libraryName&gt;
    &lt;useForReading&gt;false&lt;/useForReading&gt;
  &lt;/Netcdf4Clibrary&gt;
  --&gt;
&lt;/threddsConfig&gt;</code></pre>
</div>
</div>
<div id="update-the-catalog" class="section level3">
<h3><span class="header-section-number">4.2.9</span> Update the catalog</h3>
<p>For example to update the catalog with the latest data, run the following command from the root crontab. This cronjob will also synchronize the database with remote servers and dump your database (by default in /home/carya/dump)</p>
<pre><code>0 * * * * /home/carya/pecan/scripts/cron.sh -o /home/carya/dump</code></pre>
</div>
<div id="troubleshooting-1" class="section level3">
<h3><span class="header-section-number">4.2.10</span> Troubleshooting</h3>
<p>Refer to the log files for Tomcat (<code>/var/log/tomcat8/*</code>) and Thredds (<code>/home/carya/thredds/logs</code>).</p>
</div>
<div id="further-reading-1" class="section level3">
<h3><span class="header-section-number">4.2.11</span> Further reading</h3>
<ul>
<li><a href="http://www.unidata.ucar.edu/software/thredds/current/tds/">Thredds reference</a></li>
</ul>

</div>
</div>
<div id="docker-index" class="section level2">
<h2><span class="header-section-number">4.3</span> Docker</h2>
<p>This chapter describes the PEcAn Docker container infrastructure.
It contains the following sections:</p>
<ul>
<li><a href="pecan-manual-setup.html#docker-intro">Introduction to Docker</a> – Brief introduction to Docker and <code>docker-compose</code></li>
<li><a href="pecan-manual-setup.html#docker-quickstart">Docker quickstart</a> – Brief tutorial for setting up a Docker-based PEcAn instance</li>
<li><a href="pecan-manual-setup.html#pecan-docker">PEcAn Docker Architecture</a> – Detailed description of the containers comprising the PEcAn Docker-based infrastructure</li>
<li><a href="pecan-manual-setup.html#model-docker">Dockerfiles for models</a> – General guide for writing Dockerfiles for new models</li>
<li><a href="pecan-manual-setup.html#docker-build-images">Building and modifying images</a></li>
<li><span id="docker-troubleshooting">Troubleshooting Docker</span></li>
<li><a href="pecan-manual-setup.html#docker-migrate">Migrating from VM to Docker</a> – Steps to migrate from running PEcAn on a VM to a docker.</li>
</ul>

<div id="docker-intro" class="section level4">
<h4><span class="header-section-number">4.3.0.1</span> Introduction to Docker?</h4>
<p><a href="pecan-manual-setup.html#what-is-docker">What is Docker</a>
<a href="pecan-manual-setup.html#working-with-docker">Working with Docker</a>
<span id="docker-compose"><code>docker-compose</code></span></p>
</div>
<div id="what-is-docker" class="section level4">
<h4><span class="header-section-number">4.3.0.2</span> What is Docker?</h4>
<p>For a quick and accessible introduction to Docker, we suggest this YouTube video: <a href="https://www.youtube.com/watch?v=YFl2mCHdv24">Learn Docker in 12 Minutes</a>.</p>
<p>For more comprehensive Docker documentation, we refer you to the <a href="https://docs.docker.com/">Docker documentation website</a>.</p>
<p>For a useful analogy for Docker containerization, we refer you to the webcomic <a href="https://xkcd.com/1988/">xkcd</a>.</p>
<p>Docker is a technology for encapsulating software in “containers”, somewhat similarly to virtual machines.
Like virtual machines, Docker containers facilitate software distribution by bundling the software with all of its dependencies in a single location.
Unlike virtual machines, Docker containers are meant to only run a single service or process and are build on top of existing services provided by the host OS (such as disk access, networking, memory management etc.).</p>
<p>In Docker, an <strong>image</strong> refers to a binary snapshot of a piece of software and all of its dependencies.
A <strong>container</strong> refers to a running instance of a particular image.
A good rule of thumb is that each container should be responsible for no more than one running process.
A software <strong>stack</strong> refers to a collection of containers, each responsible for its own process, working together to power a particular application.
Docker makes it easy to run multiple software stacks at the same time in parallel on the same machine.
Stacks can be given a unique name, which is passed along as a prefix to all their containers.
Inside these stacks, containers can communicate using generic names not prefixed with the stack name, making it easy to deploy multiple stacks with the same internal configuration.
Containers within the same stack communicate with each other via a common <strong>network</strong>.
Like virtual machines or system processes, Docker stacks can also be instructed to open specific ports to facilitate communication with the host and other machines.</p>
<p>The PEcAn database BETY provides an instructive case-study.
BETY is comprised of two core processes – a PostgreSQL database, and a web-based front-end to that database (Apache web server with Ruby on Rails).
Running BETY as a “Dockerized” application therefore involves two containers – one for the PostgreSQL database, and one for the web server.
We could build these containers ourselves by starting from a container with nothing but the essentials of a particular operating system, but we can save some time and effort by starting with an <a href="https://hub.docker.com/_/postgres/">existing image for PostgreSQL</a> from Docker Hub.
When starting a Dockerized BETY, we start the PostgreSQL container first, then start the BETY container telling it how to communicate with the PostgreSQL container.
To upgrade an existing BETY instance, we stop the BETY container, download the latest version, tell it to upgrade the database, and re-start the BETY container.
There is no need to install new dependencies for BETY since they are all shipped as part of the container.</p>
<p>The PEcAn Docker architecture is designed to facilitate installation and maintenance on a variety of systems by eliminating the need to install and maintain complex system dependencies (such as PostgreSQL, Apache web server, and Shiny server).
Furthermore, using separate Docker containers for each ecosystem model helps avoid clashes between different software version requirements of different models (e.g. some models require GCC &lt;5.0, while others may require GCC &gt;=5.0).</p>
<p>The full PEcAn Docker stack is described in more detail in the <a href="pecan-manual-setup.html#pecan-docker">next section</a>.</p>
</div>
<div id="working-with-docker" class="section level4">
<h4><span class="header-section-number">4.3.0.3</span> Working with Docker</h4>
<p>To run an image, you can use the Docker command line interface.
For example, the following runs a PostgreSQL image based on the <a href="https://hub.docker.com/r/mdillon/postgis/">pre-existing PostGIS image</a> by <code>mdillon</code>:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run \
    --detach \
    --rm \
    --name postgresql \
    --network pecan \
    --publish 9876:5432 \
    --volume <span class="va">${PWD}</span>/postgres:/var/lib/postgresql/data \
    mdillon/postgis:9.6-alpine</code></pre>
<p>This will start the PostgreSQL+PostGIS container.
The following options were used:</p>
<ul>
<li><code>--detach</code> makes the container run in the background.</li>
<li><code>--rm</code> removes the container when it is finished (make sure to use the volume below).</li>
<li><code>--name</code> the name of the container, also the hostname of the container which can be used by other docker containers in the same network inside docker.</li>
<li><code>--network pecan</code> the network that the container should be running in, this leverages of network isolation in docker and allows this container to be connected to by others using the postgresql hostname.</li>
<li><code>--publish</code> exposes the port to the outside world, this is like ssh, and maps port 9876 to port 5432 in the docker container</li>
<li><code>--volume</code> maps a folder on your local machine to the machine in the container. This allows you to save data on your local machine.</li>
<li><code>mdillon/postgis:9.6-alpine</code> is the actual image that will be run, in this case it comes from the group/person mdillon, the container is postgis and the version 9.6-alpine (version 9.6 build on alpine linux).</li>
</ul>
<p>Other options that might be used:</p>
<ul>
<li><code>--tty</code> allocate a pseudo-TTY to send stdout and stderr back to the console.</li>
<li><code>--interactive</code> keeps stdin open so the user can interact with the application running.</li>
<li><code>--env</code> sets environment variables, these are often used to change the behavior of the docker container.</li>
</ul>
<p>To see a list of all running containers you can use the following command:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> ps</code></pre>
<p>To see the log files of this container you use the following command (you can either use their name or id as returned by <code>docker ps</code>). The <code>-f</code> flag will follow the <code>stdout</code>/<code>stderr</code> from the container, use <code>Ctrl-C</code> to stop following the <code>stdout</code>/<code>stderr</code>.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> logs -f postgresql</code></pre>
<p>To stop a running container use:</p>
<pre><code>docker stop postgresql</code></pre>
<p>Containers that are running in the foreground (without the <code>--detach</code>) can be stopped by pressing <code>Ctrl-C</code>. Any containers running in the background (with <code>--detach</code>) will continue running until the machine is restarted or the container is stopped using <code>docker stop</code>.</p>
</div>
<div id="docker-compose" class="section level4">
<h4><span class="header-section-number">4.3.0.4</span> <code>docker-compose</code></h4>
<p>For a quick introduction to <code>docker-compose</code>, we recommend the following YouTube video: <a href="https://www.youtube.com/watch?v=Qw9zlE3t8Ko">Docker Compose in 12 Minutes</a>.</p>
<p>The complete <code>docker-compose</code> references can be found on the <a href="https://docs.docker.com/compose/">Docker documentation website</a>.</p>
<p><code>docker-compose</code> provides a convenient way to configure and run a multi-container Docker stack.
Basically, a <code>docker-compose</code> setup consists of a list of containers and their configuration parameters, which are then internally converted into a bunch of <code>docker</code> commands.
To configure BETY as described above, we can use a <code>docker-compose.yml</code> file like the following:</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">version:</span><span class="at"> </span><span class="st">&quot;3&quot;</span>
<span class="fu">services:</span>
  <span class="fu">postgres:</span>
    <span class="fu">image:</span><span class="at"> mdillon/postgis:9.5</span>
  <span class="fu">bety:</span>
    <span class="fu">image:</span><span class="at"> pecan/bety</span>
    <span class="fu">depends_on:</span>
      <span class="kw">-</span> postgres</code></pre>
<p>This simple file allows us to bring up a full BETY application with both database and BETY application. The BETY app will not be brought up until the database container has started.</p>
<p>You can now start this application by changing into the same directory as the <code>docker-compose.yml</code> file (<code>cd /path/to/file</code>) and then running:</p>
<pre><code>docker-compose up</code></pre>
<p>This will start the application, and you will see the log files for the 2 different containers.</p>

</div>
<div id="docker-quickstart" class="section level4">
<h4><span class="header-section-number">4.3.0.5</span> Quickstart for Docker and PEcAn</h4>
<p>This is a short documentation on how to start with Docker and PEcAn. This will not go into much detail about about how to use docker. The previous section will talk more about <a href="pecan-manual-setup.html#docker-intro"><code>docker</code></a> and <a href="pecan-manual-setup.html#docker-compose"><code>docker-compose</code></a>. The quickstart below assumes you have a basic understanding of both of these technologies.</p>
<p><a href="pecan-manual-setup.html#install-docker">Install Docker</a>
<a href="pecan-manual-setup.html#curl-model-runs">Start model runs using curl</a>
<a href="pecan-manual-setup.html#pecan-setup-compose">Setup PEcAn using docker-compose</a>
<a href="pecan-manual-setup.html#pecan-docker-quickstart-init">Initialize the PEcAn database (first time only)</a>
<a href="pecan-manual-setup.html#start-pecan">Start PEcAn</a></p>
</div>
<div id="install-docker" class="section level4">
<h4><span class="header-section-number">4.3.0.6</span> Install Docker</h4>
<p>You will need to install docker first. See <a href="https://www.docker.com/community-edition#/download" class="uri">https://www.docker.com/community-edition#/download</a></p>
<p>Once Docker is installed, make sure it is running.
To test that Docker is installed and running, open a terminal and run the following commands:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run hello-world</code></pre>
<p>If successful, this should return a message starting with <code>&quot;Hello from Docker!&quot;</code>.
If this doesn’t work, there is something wrong with your configuration.
Refer to the Docker documentation for debugging.</p>
<p>NOTE: Depending on how Docker is installed and configured, you may have to run this command as <code>sudo</code>.
Try running the command without <code>sudo</code> first.
If that fails, but running as <code>sudo</code> succeeds, see <a href="https://docs.docker.com/install/linux/linux-postinstall/">these instructions</a> for steps to use Docker as a non-root user.</p>
</div>
<div id="pecan-setup-compose" class="section level4">
<h4><span class="header-section-number">4.3.0.7</span> Setup PEcAn using docker-compose</h4>
<p>Next make sure you have docker-compose installed. If you are running this on a Mac or Windows this might be already installed. On Linux you will need to install this , see separately <a href="https://docs.docker.com/compose/install/" class="uri">https://docs.docker.com/compose/install/</a>.</p>
<p>You can check to see if docker-compose is installed using</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker-compose</span> -v</code></pre>
<p>This should print the current version of docker-compose. We have tested the instruction below with versions of docker-compose 1.22 and above.</p>
</div>
<div id="setup-pecan-using-docker-compose" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Setup PEcAn using docker-compose</h3>
<p>This section will let you download some configuration files. The documentation provides links to the latest released version (master branch in GitHub) or the develop version that we are working on (develop branch in GitHub) which will become the next release. If you cloned the PEcAn GitHub repository you can use <code>git checkout &lt;branch&gt;</code> to switch branches.</p>
<p>The PEcAn Docker stack is configured using a <code>docker-compose.yml</code> file. You can download just this file directly from GitHub <a href="https://raw.githubusercontent.com/PecanProject/pecan/master/docker-compose.yml">latest</a> or <a href="https://raw.githubusercontent.com/PecanProject/pecan/master/docker-compose.yml">develop</a>. You can also find this file in the root of cloned PEcAn GitHub repository. There is no need to edit the <code>docker-compose.yml</code> file. You can use either the <code>.env</code> file to change some of the settings, or the <code>docker-compose.override.yml</code> file to modify the <code>docker-compose.yml</code> file. This makes it easier for you to get an updated version of the <code>docker-compose.yml</code> file and not lose any chances you have made to it.</p>
<p>Some of the settings in the <code>docker-compose.yml</code> can be set using a <code>.env</code> file. You can download either the <a href="https://raw.githubusercontent.com/PecanProject/pecan/master/docker/env.example">latest</a> or the <a href="https://raw.githubusercontent.com/PecanProject/pecan/develop/docker/env.example">develop</a> version. If you have cloned the GitHub repository it is also located in the docker folder. This file should be called <code>.env</code> and be placed in the same folder as your <code>docker-compose.yml</code> file. This file will allow you to set which version of PEcAn or BETY to use. See the comments in this file to control the settings. Option you might want to set are:</p>
<ul>
<li><code>PECAN_VERSION</code> : The docker images to use for PEcAn. The default is <code>latest</code> which is the latest released version of PEcAn. Setting this to <code>develop</code> will result in using the version of PEcAn which will become the next release.</li>
<li><code>PECAN_FQDN</code> : Is the name of the server where PEcAn is running. This is what is used to register all files generated by this version of PEcAn (see also <code>TRAEFIK_HOST</code>).</li>
<li><code>PECAN_NAME</code> : A short name of this PEcAn server that is shown in the pull down menu and might be easier to recognize.</li>
<li><code>BETY_VERSION</code> : This controls the version of BETY. The default is <code>latest</code> which is the latest released version of BETY. Setting this to <code>develop</code> will result in using the version of BETY which will become the next release.</li>
<li><code>TRAEFIK_HOST</code> : Should be the FQDN of the server, this is needed when generating a SSL certificate. For SSL certificates you will need to set <code>TRAEFIK_ACME_ENABLE</code> as well as <code>TRAEFIK_ACME_EMAIL</code>.</li>
<li><code>TRAEFIK_IPFILTER</code> : is used to limit access to certain resources, such as RabbitMQ and the Traefik dashboard.</li>
</ul>
<p>A final file, which is optional, is a <code>docker-compose.override.yml</code>. You can download a version for the <a href="https://raw.githubusercontent.com/PecanProject/pecan/master/docker/docker-compose.example.yml">latest</a> and <a href="https://raw.githubusercontent.com/PecanProject/pecan/develop/docker/docker-compose.example.yml">develop</a> versions. If you have cloned the GitHub repository it is located in the docker folder. Use this file as an example of what you can do, only copy the pieces over that you really need. This will allow you to make changes to the docker-compose file for your local installation. You can use this to add additional containers to your stack, change the path where docker stores the data for the containers, or you can use this to open up the postgresql port.</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">version:</span><span class="at"> </span><span class="st">&quot;3&quot;</span>

<span class="fu">services:</span>
  <span class="co"># expose database to localhost for ease of access</span>
  <span class="fu">postgres:</span>
    <span class="fu">ports:</span>
      <span class="kw">-</span> <span class="fu">5432:</span><span class="at">5432</span></code></pre>
<p>Once you have the <code>docker-compose.yml</code> file as well as the optional <code>.env</code> and <code>docker-compose.override.yml</code> in a folder you can start the PEcAn stack. The following instructions assume you are in the same directory as the file (if not, <code>cd</code> into it).</p>
<p>In the rest of this section we will use a few arguments for the <code>docker-compose</code> application. The location of these arguments are important. The general syntax of <code>docker-compose</code> is <code>docker-compose &lt;ARGUMENTS FOR DOCKER COMPOSE&gt; &lt;COMMAND&gt; &lt;ARGUMENTS FOR COMMAND&gt; [SERVICES]</code>. More generally, <code>docker-compose</code> options are very sensitive to their location relative to other commands in the same line – that is, <code>docker-compose -f /my/docker-compose.yml -p pecan up -d postgres</code> is <em>not</em> the same as <code>docker-compose -d postgres -p pecan up -f /my/docker-compose.yml</code>. If expected ever don’t seem to be working, check that the arguments are in the right order.)</p>
<ul>
<li><code>-f &lt;filename&gt;</code> : <em>ARGUMENTS FOR DOCKER COMPOSE</em> : Allows you to specify a docker-compose.yml file explicitly. You can use this argument multiple times. Default is to use the docker-compose.yml and docker-compose.override.yml in your current folder.</li>
<li><code>-p &lt;projectname&gt;</code> : <em>ARGUMENTS FOR DOCKER COMPOSE</em> : Project name, all volumes, networks, and containers will be prefixed with this argument. The default value is to use the current folder name.</li>
<li><code>-d</code> : <em>ARGUMENTS FOR <code>up</code> COMMAND</em> : Will start all the containers in the background and return back to the command shell.</li>
</ul>
<p>If no services as added to the docker-compose command all services possible will be started.</p>
</div>
<div id="pecan-docker-quickstart-init" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Initialize PEcAn (first time only)</h3>
<p>Before you can start to use PEcAn for the first time you will need to initialize the database (and optionally add some data). The following two sections will <a href="pecan-manual-setup.html#pecan-docker-quickstart-init-db">first initialize the database</a> and <a href="pecan-manual-setup.html#pecan-docker-quickstart-init-data">secondly add some data</a> to the system.</p>
<div id="pecan-docker-quickstart-init-db" class="section level4">
<h4><span class="header-section-number">4.3.2.1</span> Initialize the PEcAn database</h4>
<p>The commands described in this section will set up the PEcAn database (BETY) and pre-load it with some common “default” data.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker-compose</span> -p pecan up -d postgres

<span class="co"># If you have a custom docker-compose file:</span>
<span class="co"># docker-compose -f /path/to/my-docker-compose.yml -p pecan up -d postgres</span></code></pre>
<p>The breakdown of this command is as follows:</p>
<ul>
<li><code>-p pecan</code> – This tells <code>docker-compose</code> to do all of this as part of a “project” <code>-p</code> we’ll call <code>pecan</code>. By default, the project name is set to the name of the current working directory. The project name will be used as a prefix to all containers started by this <code>docker-compose</code> instance (so, if we have a service called <code>postgres</code>, this will create a container called <code>pecan_postgres</code>).</li>
<li><code>up -d</code> – <code>up</code> is a command that initializes the containers. Initialization involves downloading and building the target containers and any containers they depend on, and then running them. Normally, this happens in the foreground, printing logs directly to <code>stderr</code>/<code>stdout</code> (meaning you would have to interrupt it with Ctrl-C), but the <code>-d</code> flag forces this to happen more quietly and in the background.</li>
<li><code>postgres</code> – This indicates that we only want to initialize the service called <code>postgres</code> (and its dependencies). If we omitted this, <code>docker-compose</code> would initialize all containers in the stack.</li>
</ul>
<p>The end result of this command is to initialize a “blank” PostGIS container that will run in the background.
This container is not connected to any data (yet), and is basically analogous to just installing and starting PostgreSQL to your system.
As a side effect, the above command will also create blank data <a href="https://docs.docker.com/storage/volumes/">“volumes”</a> and a <a href="https://docs.docker.com/network/">“network”</a> that containers will use to communicate with each other.
Because our project is called <code>pecan</code> and <code>docker-compose.yml</code> describes a network called <code>pecan</code>, the resulting network is called <code>pecan_pecan</code>.
This is relevant to the following commands, which will actually initialize and populate the BETY database.</p>
<p>Assuming the above ran successfully, next run the following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker-compose</span> run --rm bety initialize</code></pre>
<p>The breakdown of this command is as follows: {#docker-run-init}</p>
<ul>
<li><code>docker-compose run</code> – This says we will be running a specific command inside the target service (bety in this case).</li>
<li><code>--rm</code> – This automatically removes the resulting container once the specified command exits, as well as any volumes associated with the container. This is useful as a general “clean-up” flag for one-off commands (like this one) to make sure you don’t leave any “zombie” containers or volumes around at the end.</li>
<li><code>bety</code> – This is the name of the service in which we want to run the specified command.</li>
<li>Everything after the service name (here, <code>bety</code>) is interpreted as an argument to the image’s specified <a href="https://docs.docker.com/engine/reference/builder/#entrypoint">entrypoint</a>. For the <code>bety</code> service, the entrypoint is the script <a href="https://github.com/PecanProject/bety/blob/master/docker/entrypoint.sh"><code>docker/entrypoint.sh</code></a> located in the BETY repository. Here, the <code>initialize</code> argument is parsed to mean “Create a new database”, which first runs <code>psql</code> commands to create the <code>bety</code> role and database and then runs the <code>load.bety.sh</code> script.
<ul>
<li>NOTE: The entrypoint script that is used is the one copied into the Docker container at the time it was built, which, depending on the indicated image version and how often images are built on Docker Hub relative to updates to the source, may be older than whatever is in the source code.</li>
</ul></li>
</ul>
<p>Note that this command may throw a bunch of errors related to functions and/or operators already existing.
This is normal – it just means that the PostGIS extension to PostgreSQL is already installed.
The important thing is that you see output near the end like:</p>
<pre><code>CREATED SCHEMA
Loading  schema_migrations         : ADDED 61
Started psql (pid=507)
Updated  formats                   :     35 (+35)
Fixed    formats                   : 46
Updated  machines                  :     23 (+23)
Fixed    machines                  : 24
Updated  mimetypes                 :    419 (+419)
Fixed    mimetypes                 : 1095
...
...
...
Added carya41 with access_level=4 and page_access_level=1 with id=323
Added carya42 with access_level=4 and page_access_level=2 with id=325
Added carya43 with access_level=4 and page_access_level=3 with id=327
Added carya44 with access_level=4 and page_access_level=4 with id=329
Added guestuser with access_level=4 and page_access_level=4 with id=331</code></pre>
<p>If you do not see this output, you can look at the <a href="pecan-manual-setup.html#docker-quickstart-troubleshooting">troubleshooting</a> section at the end of this section for some troubleshooting tips, as well as some solutions to common problems.</p>
<p>Once the command has finished successfully, proceed with the next step which will load some initial data into the database and place the data in the docker volumes.</p>
</div>
<div id="pecan-docker-quickstart-init-data" class="section level4">
<h4><span class="header-section-number">4.3.2.2</span> Add example data (first time only)</h4>
<p>The following command will add some initial data to the PEcAn stack and register the data with the database.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run -ti --rm --network pecan_pecan --volume pecan_pecan:/data --env FQDN=docker pecan/data:develop</code></pre>
<p>The breakdown of this command is as follows:</p>
<ul>
<li><code>docker run</code> – This says we will be running a specific command inside the target Docker container. See <code>docker run --help</code> and the <a href="https://docs.docker.com/engine/reference/run/">Docker run reference</a> for more information.</li>
<li><code>-ti</code> – This is actually two flags, <code>-t</code> to allocate a pseudo-tty and <code>-i</code> to keep STDIN open even if detached. <code>-t</code> is necessary to ensure lower-level script commands run correctly. <code>-i</code> makes sure that the command output (<code>stdin</code>) is displayed.</li>
<li><code>--rm</code> – This automatically removes the resulting container once the specified command exits, as well as any volumes associated with the container. This is useful as a general “clean-up” flag for one-off commands (like this one) to make sure you don’t leave any “zombie” containers or volumes around at the end.</li>
<li><code>--network pecan_pecan</code> – This indicates that the container will use the existing <code>pecan_pecan</code> network. This network is what ensures communication between the <code>postgres</code> container (which, recall, is <em>just</em> a PostGIS installation with some data) and the “volumes” where the actual data are persistently stored.</li>
<li><code>pecan/data:develop</code> – This is the name of the image in which to run the specified command, in the form <code>repository/image:version</code>. This is interpreted as follows:
<ul>
<li>First, it sees if there are any images called <code>pecan/data:develop</code> available on your local machine. If there are, it uses that one.</li>
<li>If that image version is <em>not</em> available locally, it will next try to find the image online. By default, it searches <a href="https://hub.docker.com/">Docker Hub</a>, such that <code>pecan/data</code> gets expanded to the container at <code>https://hub.docker.com/r/pecan/data</code>. For custom repositories, a full name can be given, such as <code>hub.ncsa.illinois.edu/pecan/data:latest</code>.</li>
<li>If <code>:version</code> is omitted, Docker assumes <code>:latest</code>. NOTE that while online containers <em>should</em> have a <code>:latest</code> version, not all of them do, and if a <code>:latest</code> version does not exist, Docker will be unable to find the image and will throw an error.</li>
</ul></li>
<li>Everything after the image name (here, <code>pecan/data:develop</code>) is interpreted as an argument to the image’s specified <a href="https://docs.docker.com/engine/reference/builder/#entrypoint">entrypoint</a>.</li>
<li><code>--volume pecan_pecan:/data</code> – This mounts the data from the subsequent container (<code>pecan/data:develop</code>) onto the current project volume, called <code>pecan_pecan</code> (as with the network, the project name <code>pecan</code> is the prefix, and the volume name also happens to be <code>pecan</code> as specified in the <code>docker-compose.yml</code> file).</li>
<li><code>--env FQDN=docker</code> – the Fully Qualified Domain Name, this is the same value as specified in the <code>.env</code> file (for the web, monitor and executor containers). This will link the data files to the name in the machines table in BETY.</li>
<li><code>pecan/data:develop</code> – As above, this is the target image to run. Since there is no argument after the image name, this command will run the default command (<a href="https://docs.docker.com/engine/reference/builder/#cmd"><code>CMD</code></a>) specified for this docker container. In this case, it is the <a href="https://github.com/PecanProject/pecan/blob/develop/docker/add-data.sh"><code>docker/add_data.sh</code></a> script from the PEcAn repository.</li>
</ul>
<p>Under the hood, this container runs the <code>docker/add-data.sh</code> script, which copies a bunch of input files and registers them with the PEcAn database.</p>
<p>Successful execution of this command should take some time because it involves copying reasonably large amounts of data and performing a number of database operations.</p>
</div>
<div id="start-pecan" class="section level4">
<h4><span class="header-section-number">4.3.2.3</span> Start PEcAn</h4>
<p>If you already completed the above steps, you can start the full stack by just running the following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker-compose</span> -p pecan up -d</code></pre>
<p>This will build and start all containers required to run PEcAn.
With the <code>-d</code> flag, this will run all of these containers quietly in the background, and show a nice architecture diagram with the name and status of each container while they are starting.
Once this is done you have a working instance of PEcAn.</p>
<p>If all of the containers started successfully, you should be able to access the various components from a browser via the following URLs (if you run these commands on a remote machine replace localhost with the actual hostname).</p>
<ul>
<li>PEcAn web interface (running models) – <a href="http://localhost:8000/pecan/" class="uri">http://localhost:8000/pecan/</a> (NOTE: The trailing backslash is necessary.)</li>
<li>PEcAn documentation and home page – <a href="http://localhost:8000/" class="uri">http://localhost:8000/</a></li>
<li>BETY web interface – <a href="http://localhost:8000/bety/" class="uri">http://localhost:8000/bety/</a></li>
<li>File browser (minio) – <a href="http://localhost:8000/minio/" class="uri">http://localhost:8000/minio/</a></li>
<li>RabbitMQ management console (for managing queued processes) – <a href="http://localhost:8000/rabbitmq/" class="uri">http://localhost:8000/rabbitmq/</a></li>
<li>Traefik, webserver showing maps from URLs onto their respective containers – <a href="http://localhost:8000/traefik/" class="uri">http://localhost:8000/traefik/</a></li>
<li>Monitor, service that monitors models and shows all models that are online as well as how many instances are online and the number of jobs waiting. The output is in JSON – <a href="http://localhost:8000/monitor/" class="uri">http://localhost:8000/monitor/</a></li>
</ul>
</div>
<div id="curl-model-runs" class="section level4">
<h4><span class="header-section-number">4.3.2.4</span> Start model runs using curl</h4>
<p>To test PEcAn you can use the following <code>curl</code> statement, or use the webpage to submit a request (if you run these commands on a remote machine replace localhost with the actual hostname):</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">curl</span> -v -X POST \
    -F <span class="st">&#39;hostname=docker&#39;</span> \
    -F <span class="st">&#39;modelid=5000000002&#39;</span> \
    -F <span class="st">&#39;sitegroupid=1&#39;</span> \
    -F <span class="st">&#39;siteid=772&#39;</span> \
    -F <span class="st">&#39;sitename=Niwot Ridge Forest/LTER NWT1 (US-NR1)&#39;</span> \
    -F <span class="st">&#39;pft[]=temperate.coniferous&#39;</span> \
    -F <span class="st">&#39;start=2004/01/01&#39;</span> \
    -F <span class="st">&#39;end=2004/12/31&#39;</span> \
    -F <span class="st">&#39;input_met=5000000005&#39;</span> \
    -F <span class="st">&#39;email=&#39;</span> \
    -F <span class="st">&#39;notes=&#39;</span> \
    <span class="st">&#39;http://localhost:8000/pecan/04-runpecan.php&#39;</span></code></pre>
<p>This should return some text with in there <code>Location:</code> this is shows the workflow id, you can prepend <a href="http://localhost:8000/pecan/" class="uri">http://localhost:8000/pecan/</a> to the front of this, for example: <a href="http://localhost:8000/pecan/05-running.php?workflowid=99000000001" class="uri">http://localhost:8000/pecan/05-running.php?workflowid=99000000001</a>. Here you will be able to see the progress of the workflow.</p>
<p>To see what is happening behind the scenes you can use look at the log file of the specific docker containers, once of interest are <code>pecan_executor_1</code> this is the container that will execute a single workflow and <code>pecan_sipnet_1</code> which executes the sipnet mode. To see the logs you use <code>docker logs pecan_executor_1</code> Following is an example output:</p>
<pre><code>2018-06-13 15:50:37,903 [MainThread     ] INFO    : pika.adapters.base_connection - Connecting to 172.18.0.2:5672
2018-06-13 15:50:37,924 [MainThread     ] INFO    : pika.adapters.blocking_connection - Created channel=1
2018-06-13 15:50:37,941 [MainThread     ] INFO    : root -  [*] Waiting for messages. To exit press CTRL+C
2018-06-13 19:44:49,523 [MainThread     ] INFO    : root - b&#39;{&quot;folder&quot;: &quot;/data/workflows/PEcAn_99000000001&quot;, &quot;workflowid&quot;: &quot;99000000001&quot;}&#39;
2018-06-13 19:44:49,524 [MainThread     ] INFO    : root - Starting job in /data/workflows/PEcAn_99000000001.
2018-06-13 19:45:15,555 [MainThread     ] INFO    : root - Finished running job.</code></pre>
<p>This shows that the executor connects to RabbitMQ, waits for messages. Once it picks up a message it will print the message, and execute the workflow in the folder passed in with the message. Once the workflow (including any model executions) is finished it will print Finished. The log file for <code>pecan_sipnet_1</code> is very similar, in this case it runs the <code>job.sh</code> in the run folder.</p>
<p>To run multiple executors in parallel you can duplicate the executor section in the docker-compose file and just rename it from executor to executor1 and executor2 for example. The same can be done for the models. To make this easier it helps to deploy the containers using Kubernetes allowing to easily scale up and down the containers.</p>
</div>
</div>
<div id="docker-quickstart-troubleshooting" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Troubleshooting</h3>
<p>When initializing the database, you will know you have encountered more serious errors if the command exits or hangs with output resembling the following:</p>
<pre><code>LINE 1: SELECT count(*) FROM formats WHERE ...
                             ^
Error: Relation `formats` does not exist</code></pre>
<p><strong>If the above command fails</strong>, you can try to fix things interactively by first opening a shell inside the container…</p>
<pre><code>docker run -ti --rm --network pecan_pecan pecan/bety:latest /bin/bash</code></pre>
<p>…and then running the following commands, which emulate the functionality of the <code>entrypoint.sh</code> with the <code>initialize</code> argument.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Create the bety role in the postgresql database</span>
<span class="ex">psql</span> -h postgres -p 5432 -U postgres -c <span class="st">&quot;CREATE ROLE bety WITH LOGIN CREATEDB NOSUPERUSER NOCREATEROLE PASSWORD &#39;bety&#39;&quot;</span>

<span class="co"># Initialize the bety database itself, and set to be owned by role bety</span>
<span class="ex">psql</span> -h postgres -p 5432 -U postgres -c <span class="st">&quot;CREATE DATABASE bety WITH OWNER bety&quot;</span>

<span class="co"># If either of these fail with a &quot;role/database bety already exists&quot;,</span>
<span class="co"># that&#39;s fine. You can safely proceed to the next command.</span>

<span class="co"># Load the actual bety database tables and values</span>
<span class="ex">./script/load.bety.sh</span> -a <span class="st">&quot;postgres&quot;</span> -d <span class="st">&quot;bety&quot;</span> -p <span class="st">&quot;-h postgres -p 5432&quot;</span> -o bety -c -u -g -m <span class="va">${LOCAL_SERVER}</span> -r 0 -w https://ebi-forecast.igb.illinois.edu/pecan/dump/all/bety.tar.gz</code></pre>

<div id="pecan-docker" class="section level4">
<h4><span class="header-section-number">4.3.3.1</span> PEcAn Docker Architecture</h4>
<p><a href="pecan-manual-setup.html#pecan-docker-overview">Overview</a>
<a href="pecan-manual-setup.html#pecan-docker-compose">PEcAn’s <code>docker-compose</code></a>
<a href="pecan-manual-setup.html#pecan-dc-structure">Top-level structure</a>
<a href="pecan-manual-setup.html#pecan-dc-traefik"><code>traefik</code></a>
<a href="pecan-manual-setup.html#pecan-dc-portainer"><code>portainer</code></a>
<a href="pecan-manual-setup.html#pecan-dc-minio"><code>minio</code></a>
<a href="pecan-manual-setup.html#pecan-dc-thredds"><code>thredds</code></a>
<a href="pecan-manual-setup.html#pecan-dc-postgres"><code>postgres</code></a>
<a href="pecan-manual-setup.html#pecan-dc-rabbitmq"><code>rabbitmq</code></a>
<a href="pecan-manual-setup.html#pecan-dc-bety"><code>bety</code></a>
<a href="pecan-manual-setup.html#pecan-dc-docs"><code>docs</code></a>
<a href="pecan-manual-setup.html#pecan-dc-web"><code>web</code></a>
<a href="pecan-manual-setup.html#pecan-dc-executor"><code>executor</code></a>
<a href="pecan-manual-setup.html#pecan-dc-monitor"><code>monitor</code></a>
<a href="pecan-manual-setup.html#pecan-dc-models">Model-specific containers</a></p>
</div>
<div id="pecan-docker-overview" class="section level4">
<h4><span class="header-section-number">4.3.3.2</span> Overview</h4>
<p>The PEcAn docker architecture consists of many containers (see figure below) that will communicate with each other. The goal of this architecture is to easily expand the PEcAn system by deploying new model containers and registering them with PEcAn. Once this is done the user can now use these new models in their work. The PEcAn framework will setup the configurations for the models, and send a message to the model containers to start execution. Once the execution is finished the PEcAn framework will continue. This is exactly as if the model is running on a HPC machine. Models can be executed in parallel by launching multiple model containers.</p>
<p><img src="06_reference/04_docker/pecan-docker.png" width="50%" height="50%" style="display: block; margin: auto;" /></p>
<p>As can be seen in the figure the architecture leverages of two standard containers (in orange). The first container is postgresql with postgis (<a href="https://hub.docker.com/r/mdillon/postgis/">mdillon/postgis</a>) which is used to store the database used by both BETY and PEcAn. The second containers is a messagebus, more specifically RabbitMQ (<a href="https://hub.docker.com/_/rabbitmq/">rabbitmq</a>).</p>
<p>The BETY app container (<a href="https://hub.docker.com/r/pecan/bety/">pecan/bety</a>) is the front end to the BETY database and is connected to the postgresql container. A http server can be put in front of this container for SSL termination as well to allow for load balancing (by using multiple BETY app containers).</p>
<p>The PEcAn framework containers consist of multiple unique ways to interact with the PEcAn system (none of these containers will have any models installed):</p>
<ul>
<li>PEcAn shiny hosts the shiny applications developed and will interact with the database to get all information necessary to display</li>
<li>PEcAn rstudio is a rstudio environment with the PEcAn libraries preloaded. This allows for prototyping of new algorithms that can be used as part of the PEcAn framework later.</li>
<li>PEcAn web allows the user to create a new PEcAn workflow. The workflow is stored in the database, and the models are executed by the model containers.</li>
<li>PEcAn cli will allow the user to give a pecan.xml file that will be executed by the PEcAn framework. The workflow created from the XML file is stored in the database, and the models are executed by the model containers.</li>
</ul>
<p>The model containers contain the actual models that are executed as well as small wrappers to make them work in the PEcAn framework. The containers will run the model based on the parameters received from the message bus and convert the outputs back to the standard PEcAn output format. Once the container is finished processing a message it will immediatly get the next message and start processing it.</p>
</div>
<div id="pecan-docker-compose" class="section level4">
<h4><span class="header-section-number">4.3.3.3</span> PEcAn’s <code>docker-compose</code></h4>
<p>The PEcAn Docker architecture is described in full by the PEcAn <code>docker-compose.yml</code> file.
For full <code>docker-compose</code> syntax, see the <a href="https://docs.docker.com/compose/">official documentation</a>.</p>
<p>This section describes the <a href="pecan-manual-setup.html#pecan-dc-structure">top-level structure</a> and each of the services, which are as follows:</p>
<ul>
<li><a href="pecan-manual-setup.html#pecan-dc-traefik"><code>traefik</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-portainer"><code>portainer</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-minio"><code>minio</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-thredds"><code>thredds</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-postgres"><code>postgres</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-rabbitmq"><code>rabbitmq</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-bety"><code>bety</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-docs"><code>docs</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-web"><code>web</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-executor"><code>executor</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-monitor"><code>monitor</code></a></li>
<li><a href="pecan-manual-setup.html#pecan-dc-models">Model-specific services</a></li>
</ul>
<p>For reference, the complete <code>docker-compose</code> file is as follows:</p>
<pre><code>version: &#39;3&#39;
services:
  traefik:
    image: traefik:latest
    command:
    - --loglevel=INFO
    - --api
    - --defaultentrypoints=https,http
    - --entryPoints=Name:http Address::${TRAEFIK_HTTP_PORT:-8000} ${TRAEFIK_HTTP_REDIRECT:-&quot;&quot;}
    - --entryPoints=Name:https Address::${TRAEFIK_HTTPS_PORT:-8443} ${TRAEFIK_HTTPS_OPTIONS:-TLS}
    - --acme=${TRAEFIK_ACME_ENABLE:-false}
    - --acme.email=${TRAEFIK_ACME_EMAIL:-&quot;&quot;}
    - --acme.entrypoint=https
    - --acme.onhostrule=true
    - --acme.storage=/config/acme.json
    - --acme.httpchallenge.entrypoint=http
    - --acme.storage=/config/acme.json
    - --acme.acmelogging=true
    - --docker=true
    - --docker.endpoint=unix:///var/run/docker.sock
    - --docker.exposedbydefault=false
    - --docker.watch=true
    restart: unless-stopped
    networks: pecan
    ports:
    - ${TRAEFIK_HTTP_PORT-8000}:${TRAEFIK_HTTP_PORT:-8000}
    - ${TRAEFIK_HTTPS_PORT-8443}:${TRAEFIK_HTTPS_PORT:-8443}
    labels:
    - traefik.enable=true
    - traefik.backend=traefik
    - traefik.port=8080
    - &#39;traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefixStrip: /traefik&#39;
    - traefik.website.frontend.whiteList.sourceRange=${TRAEFIK_IPFILTER:-172.16.0.0/12}
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - traefik:/config
  portainer:
    image: portainer/portainer:latest
    command:
    - --admin-password=${PORTAINER_PASSWORD:-}
    - --host=unix:///var/run/docker.sock
    restart: unless-stopped
    networks: pecan
    labels:
    - traefik.enable=true
    - traefik.backend=portainer
    - &#39;traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefixStrip: /portainer&#39;
    - traefik.website.frontend.whiteList.sourceRange=${TRAEFIK_IPFILTER:-172.16.0.0/12}
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - portainer:/data
  minio:
    image: minio/minio:latest
    command: server /data
    restart: unless-stopped
    networks: pecan
    environment:
    - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-carya}
    - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-illinois}
    labels:
    - traefik.enable=true
    - traefik.backend=minio
    - traefik.port=9000
    - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/minio/
    volumes: pecan:/data
  thredds:
    image: pecan/thredds:${PECAN_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    volumes: pecan:/data
    labels:
    - traefik.enable=true
    - traefik.port=8080
    - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/thredds
    - traefik.backend=thredds
  rabbitmq:
    image: rabbitmq:management
    restart: unless-stopped
    networks: pecan
    environment:
    - RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=-rabbitmq_management path_prefix &quot;/rabbitmq&quot;
    - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER:-guest}
    - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS:-guest}
    labels:
    - traefik.enable=true
    - traefik.backend=rabbitmq
    - traefik.port=15672
    - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/rabbitmq
    - traefik.website.frontend.whiteList.sourceRange=${TRAEFIK_IPFILTER:-172.16.0.0/12}
    volumes: rabbitmq:/var/lib/rabbitmq
  postgres:
    image: mdillon/postgis:9.5
    restart: unless-stopped
    networks: pecan
    volumes: postgres:/var/lib/postgresql/data
  bety:
    image: pecan/bety:${BETY_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    environment:
    - UNICORN_WORKER_PROCESSES=1
    - SECRET_KEY_BASE=${BETY_SECRET_KEY:-notasecret}
    - RAILS_RELATIVE_URL_ROOT=/bety
    - LOCAL_SERVER=${BETY_LOCAL_SERVER:-99}
    depends_on: postgres
    labels:
    - traefik.enable=true
    - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/bety/
    - traefik.backend=bety
  docs:
    image: pecan/docs:${PECAN_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    labels:
    - traefik.enable=true
    - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/
    - traefik.backend=docs
  web:
    image: pecan/web:${PECAN_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    environment:
    - RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
    - FQDN=${PECAN_FQDN:-docker}
    - NAME=${PECAN_NAME:-docker}
    depends_on:
    - postgres
    - rabbitmq
    labels:
    - traefik.enable=true
    - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/pecan/
    - traefik.backend=pecan
    volumes:
    - pecan:/data
    - pecan:/var/www/html/pecan/data
  monitor:
    image: pecan/monitor:${PECAN_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    ports: 9999:9999
    environment:
    - RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
    - FQDN=${PECAN_FQDN:-docker}
    depends_on: rabbitmq
    labels:
    - traefik.enable=true
    - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefixStrip:/monitor/
    - traefik.backend=monitor
    volumes: pecan:/data
  executor:
    image: pecan/executor:${PECAN_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    environment:
    - RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
    - FQDN=${PECAN_FQDN:-docker}
    depends_on:
    - postgres
    - rabbitmq
    volumes: pecan:/data
  sipnet:
    image: pecan/model-sipnet-136:${PECAN_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    environment: RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
    depends_on: rabbitmq
    volumes: pecan:/data
  ed2:
    image: pecan/model-ed2-git:${PECAN_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    environment: RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
    depends_on: rabbitmq
    volumes: pecan:/data
  maespa:
    image: pecan/model-maespa-git:${PECAN_VERSION:-latest}
    restart: unless-stopped
    networks: pecan
    environment: RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
    depends_on: rabbitmq
    volumes: pecan:/data
networks:
  pecan: ~
volumes:
  traefik: ~
  postgres: ~
  rabbitmq: ~
  pecan: ~
  portainer: ~</code></pre>
<p>There are two ways you can override different values in the docker-compose.yml file. The first method is to create a file called <code>.env</code> that is placed in the same folder as the docker-compose.yml file. This file can override some of configuration variables used by docker-compose. For example the following is an example of the env file</p>
<pre><code># This file will override the configation options in the docker-compose
# file. Copy this file to the same folder as docker-compose as .env

# ----------------------------------------------------------------------
# GENERAL CONFIGURATION
# ----------------------------------------------------------------------

# project name (-p flag for docker-compose)
#COMPOSE_PROJECT_NAME=dev

# ----------------------------------------------------------------------
# TRAEFIK CONFIGURATION
# ----------------------------------------------------------------------

# hostname of server
#TRAEFIK_HOST=Host:pecan-docker.ncsa.illinois.edu;

# only allow access from localhost and NCSA
#TRAEFIK_IPFILTER=172.16.0.0/12, 141.142.0.0/16

# Run traffik on port 80 (http) and port 443 (https)
#TRAEFIK_HTTP_PORT=80
#TRAEFIK_HTTPS_PORT=443
#TRAEFIK_HTTPS_OPTIONS=TLS

# enable SSL cerificate generation
#TRAEFIK_ACME_ENABLE=true

# Use you real email address here to be notified if cert expires
#TRAEFIK_ACME_EMAIL=pecanproj@gmail.com

# Always use https, trafic to http is redirected to https
#TRAEFIK_HTTP_REDIRECT=Redirect.EntryPoint:https

# ----------------------------------------------------------------------
# PEcAn CONFIGURATION
# ----------------------------------------------------------------------

# what version of pecan to use
#PECAN_VERSION=develop

# the fully qualified hostname used for this server
#PECAN_FQDN=pecan-docker.ncsa.illinois.edu

# short name shown in the menu
#PECAN_NAME=pecan-docker

# ----------------------------------------------------------------------
# BETY CONFIGURATION
# ----------------------------------------------------------------------

# what version of BETY to use
#BETY_VERSION=develop

# what is our server number, 99=vm, 98=docker
#BETY_LOCAL_SERVER=98

# secret used to encrypt cookies in BETY
#BETY_SECRET_KEY=1208q7493e8wfhdsohfo9ewhrfiouaho908ruq30oiewfdjspadosuf08q345uwrasdy98t7q243

# ----------------------------------------------------------------------
# MINIO CONFIGURATION
# ----------------------------------------------------------------------

# minio username and password
#MINIO_ACCESS_KEY=carya
#MINIO_SECRET_KEY=illinois

# ----------------------------------------------------------------------
# PORTAINER CONFIGURATION
# ----------------------------------------------------------------------

# password for portainer admin account
# use docker run --rm httpd:2.4-alpine htpasswd -nbB admin &lt;password&gt; | cut -d &quot;:&quot; -f 2
#PORTAINER_PASSWORD=$2y$05$5meDPBtS3NNxyGhBpYceVOxmFhiiC3uY5KEy2m0YRbWghhBr2EVn2

# ----------------------------------------------------------------------
# RABBITMQ CONFIGURATION
# ----------------------------------------------------------------------

# RabbitMQ username and password
#RABBITMQ_DEFAULT_USER=carya
#RABBITMQ_DEFAULT_PASS=illinois

# create the correct URI with above username and password
#RABBITMQ_URI=amqp://carya:illinois@rabbitmq/%2F</code></pre>
<p>You can also extend the <code>docker-compose.yml</code> file with a <code>docker-compose.override.yml</code> file (in the same directory), allowing you to add more services, or for example to change where the volumes are stored (see <a href="https://docs.docker.com/compose/extends/">official documentation</a>). For example the following will change the volume for postgres to be stored in your home directory:</p>
<pre><code>version: &quot;3&quot;

volumes:
  postgres:
    driver_opts:
      type: none
      device: ${HOME}/postgres
      o: bind</code></pre>
</div>
<div id="pecan-dc-structure" class="section level4">
<h4><span class="header-section-number">4.3.3.4</span> Top-level structure</h4>
<p>The root of the <code>docker-compose.yml</code> file contains three sections:</p>
<ul>
<li><p><code>services</code> – This is a list of services provided by the application, with each service corresponding to a container.
When communicating with each other internally, the hostnames of containers correspond to their names in this section.
For instance, regardless of the “project” name passed to <code>docker-compose up</code>, the hostname for connecting to the PostgreSQL database of any given container is <em>always</em> going to be <code>postgres</code> (e.g. you should be able to access the PostgreSQL database by calling the following from inside the container: <code>psql -d bety -U bety -h postgres</code>).
The services comprising the PEcAn application are described below.</p></li>
<li><p><code>networks</code> – This is a list of networks used by the application.
Containers can only communicate with each other (via ports and hostnames) if they are on the same Docker network, and containers on different networks can only communicate through ports exposed by the host machine.
We just provide the network name (<code>pecan</code>) and resort to Docker’s default network configuration.
Note that the services we want connected to this network include a <code>networks: ... - pecan</code> tag.
For more details on Docker networks, see the <a href="https://docs.docker.com/network/">official documentation</a>.</p></li>
<li><p><code>volumes</code> – Similarly to <code>networks</code>, this just contains a list of volume names we want.
Briefly, in Docker, volumes are directories containing files that are meant to be shared across containers.
Each volume corresponds to a directory, which can be mounted at a specific location by different containers.
For example, syntax like <code>volumes: ... - pecan:/data</code> in a service definition means to mount the <code>pecan</code> “volume” (including its contents) in the <code>/data</code> directory of that container.
Volumes also allow data to persist on containers between restarts, as normally, any data created by a container during its execution is lost when the container is re-launched.
For example, using a volume for the database allows data to be saved between different runs of the database container.
Without volumes, we would start with a blank database every time we restart the containers.
For more details on Docker volumes, see the <a href="https://docs.docker.com/storage/volumes/">official documentation</a>.
Here, we define three volumes:</p>
<ul>
<li><p><code>postgres</code> – This contains the data files underlying the PEcAn PostgreSQL database (BETY).
Notice that it is mounted by the <code>postgres</code> container to <code>/var/lib/postgresql/data</code>.
This is the data that we pre-populate when we run the Docker commands to <a href="pecan-manual-setup.html#pecan-docker-quickstart-init">initialize the PEcAn database</a>.
Note that these are the values stored <em>directly in the PostgreSQL database</em>.
The default files to which the database points (i.e. <code>dbfiles</code>) are stored in the <code>pecan</code> volume, described below.</p></li>
<li><p><code>rabbitmq</code> – This volume contains persistent data for RabbitMQ.
It is only used by the <code>rabbitmq</code> service.</p></li>
<li><p><code>pecan</code> – This volume contains PEcAn’s <code>dbfiles</code>, which include downloaded and converted model inputs, processed configuration files, and outputs.
It is used by almost all of the services in the PEcAn stack, and is typically mounted to <code>/data</code>.</p></li>
</ul></li>
</ul>
</div>
<div id="pecan-dc-traefik" class="section level4">
<h4><span class="header-section-number">4.3.3.5</span> <code>traefik</code></h4>
<p><a href="https://traefik.io/">Traefik</a> manages communication among the different PEcAn services and between PEcAn and the web.
Among other things, <code>traefik</code> facilitates the setup of web access to each PEcAn service via common and easy-to-remember URLs.
For instance, the following lines in the <code>web</code> service configure access to the PEcAn web interface via the URL <a href="http://localhost:8000/pecan/" class="uri">http://localhost:8000/pecan/</a> :</p>
<pre><code>labels:
- traefik.enable=true
- traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/pecan/
- traefik.backend=pecan</code></pre>
<p>(Further details in the works…)</p>
<p>The traefik service configuration looks like this:</p>
<pre><code>traefik:
  image: traefik:latest
  command:
  - --loglevel=INFO
  - --api
  - --defaultentrypoints=https,http
  - --entryPoints=Name:http Address::${TRAEFIK_HTTP_PORT:-8000} ${TRAEFIK_HTTP_REDIRECT:-&quot;&quot;}
  - --entryPoints=Name:https Address::${TRAEFIK_HTTPS_PORT:-8443} ${TRAEFIK_HTTPS_OPTIONS:-TLS}
  - --acme=${TRAEFIK_ACME_ENABLE:-false}
  - --acme.email=${TRAEFIK_ACME_EMAIL:-&quot;&quot;}
  - --acme.entrypoint=https
  - --acme.onhostrule=true
  - --acme.storage=/config/acme.json
  - --acme.httpchallenge.entrypoint=http
  - --acme.storage=/config/acme.json
  - --acme.acmelogging=true
  - --docker=true
  - --docker.endpoint=unix:///var/run/docker.sock
  - --docker.exposedbydefault=false
  - --docker.watch=true
  restart: unless-stopped
  networks: pecan
  ports:
  - ${TRAEFIK_HTTP_PORT-8000}:${TRAEFIK_HTTP_PORT:-8000}
  - ${TRAEFIK_HTTPS_PORT-8443}:${TRAEFIK_HTTPS_PORT:-8443}
  labels:
  - traefik.enable=true
  - traefik.backend=traefik
  - traefik.port=8080
  - &#39;traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefixStrip: /traefik&#39;
  - traefik.website.frontend.whiteList.sourceRange=${TRAEFIK_IPFILTER:-172.16.0.0/12}
  volumes:
  - /var/run/docker.sock:/var/run/docker.sock:ro
  - traefik:/config</code></pre>
</div>
<div id="pecan-dc-portainer" class="section level4">
<h4><span class="header-section-number">4.3.3.6</span> <code>portainer</code></h4>
<p><a href="https://portainer.io/">portainer</a> is lightweight management UI that allows you to manage the docker host (or swarm). You can use this service to monitor the different containers, see the logfiles, and start and stop containers.</p>
<p>The portainer service configuration looks like this:</p>
<pre><code>portainer:
  image: portainer/portainer:latest
  command:
  - --admin-password=${PORTAINER_PASSWORD:-}
  - --host=unix:///var/run/docker.sock
  restart: unless-stopped
  networks: pecan
  labels:
  - traefik.enable=true
  - traefik.backend=portainer
  - &#39;traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefixStrip: /portainer&#39;
  - traefik.website.frontend.whiteList.sourceRange=${TRAEFIK_IPFILTER:-172.16.0.0/12}
  volumes:
  - /var/run/docker.sock:/var/run/docker.sock
  - portainer:/data</code></pre>
<p>Portainer is accessible by browsing to <code>localhost:8000/portainer/</code>. You can either set the password in the <code>.env</code> file (for an example see env.example) or you can use the web browser and go to the portainer url. If this is the first time it will ask for your password.</p>
</div>
<div id="pecan-dc-minio" class="section level4">
<h4><span class="header-section-number">4.3.3.7</span> <code>minio</code></h4>
<p><a href="https://github.com/minio/minio">Minio</a> is a service that provides access to the a folder on disk through a variety of protocols, including S3 buckets and web-based access.
We mainly use Minio to facilitate access to PEcAn data using a web browser without the need for CLI tools.</p>
<p>Our current configuration is as follows:</p>
<pre><code>minio:
  image: minio/minio:latest
  command: server /data
  restart: unless-stopped
  networks: pecan
  environment:
  - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-carya}
  - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-illinois}
  labels:
  - traefik.enable=true
  - traefik.backend=minio
  - traefik.port=9000
  - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/minio/
  volumes: pecan:/data</code></pre>
<p>The Minio interface is accessible by browsing to <code>localhost:8000/minio/</code>.
From there, you can browse directories and download files.
You can also upload files by clicking the red “+” in the bottom-right corner.</p>
<p>Note that it is currently impossible to create or upload directories using the Minio interface (except in the <code>/data</code> root directory – those folders are called “buckets” in Minio).
Therefore, the recommended way to perform any file management tasks other than individual file uploads is through the command line, e.g.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run -it --rm --volumes pecan_pecan:/data --volumes /path/to/local/directory:/localdir ubuntu

<span class="co"># Now, you can move files between `/data` and `/localdir`, create new directories, etc.</span></code></pre>
</div>
<div id="pecan-dc-thredds" class="section level4">
<h4><span class="header-section-number">4.3.3.8</span> <code>thredds</code></h4>
<p>This service allows PEcAn model outputs to be accessible via the <a href="https://www.unidata.ucar.edu/software/thredds/current/tds/">THREDDS data server (TDS)</a>.
When the PEcAn stack is running, the catalog can be explored in a web browser at <a href="http://localhost:8000/thredds/catalog.html" class="uri">http://localhost:8000/thredds/catalog.html</a>.
Specific output files can also be accessed from the command line via commands like the following:</p>
<pre class="sourceCode r"><code class="sourceCode r">nc &lt;-<span class="st"> </span>ncdf4<span class="op">::</span><span class="kw">nc_open</span>(<span class="st">&quot;http://localhost:8000/thredds/dodsC/outputs/PEcAn_&lt;workflow_id&gt;/out/&lt;run_id&gt;/&lt;year&gt;.nc&quot;</span>)</code></pre>
<p>Note that everything after <code>outputs/</code> exactly matches the directory structure of the <code>workflows</code> directory.</p>
<p>Which files are served, which subsetting services are available, and other aspects of the data server’s behavior are configured in the <code>docker/thredds_catalog.xml</code> file.
Specifically, this XML tells the data server to use the <code>datasetScan</code> tool to serve all files within the <code>/data/workflows</code> directory, with the additional <code>filter</code> that only files ending in <code>.nc</code> are served.
For additional information about the syntax of this file, see the extensive <a href="https://www.unidata.ucar.edu/software/thredds/current/tds/reference/index.html">THREDDS documentation</a>.</p>
<p>Our current configuration is as follows:</p>
<pre><code>thredds:
  image: pecan/thredds:${PECAN_VERSION:-latest}
  restart: unless-stopped
  networks: pecan
  volumes: pecan:/data
  labels:
  - traefik.enable=true
  - traefik.port=8080
  - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/thredds
  - traefik.backend=thredds</code></pre>
</div>
<div id="pecan-dc-postgres" class="section level4">
<h4><span class="header-section-number">4.3.3.9</span> <code>postgres</code></h4>
<p>This service provides a working PostGIS database.
Our configuration is fairly straightforward:</p>
<pre><code>postgres:
  image: mdillon/postgis:9.5
  restart: unless-stopped
  networks: pecan
  volumes: postgres:/var/lib/postgresql/data</code></pre>
<p>Some additional details about our configuration:</p>
<ul>
<li><p><code>image</code> – This pulls a container with PostgreSQL + PostGIS pre-installed.
Note that by default, we use PostgreSQL version 9.5.
To experiment with other versions, you can change <code>9.5</code> accordingly.</p></li>
<li><p><code>networks</code> – This allows PostgreSQL to communicate with other containers on the <code>pecan</code> network.
As mentioned above, the hostname of this service is just its name, i.e. <code>postgres</code>, so to connect to the database from inside a running container, use a command like the following: <code>psql -d bety -U bety -h postgres</code></p></li>
<li><p><code>volumes</code> – Note that the PostgreSQL data files (which store the values in the SQL database) are stored on a <em>volume</em> called <code>postgres</code> (which is <em>not</em> the same as the <code>postgres</code> <em>service</em>, even though they share the same name).</p></li>
</ul>
</div>
<div id="pecan-dc-rabbitmq" class="section level4">
<h4><span class="header-section-number">4.3.3.10</span> <code>rabbitmq</code></h4>
<p><a href="https://www.rabbitmq.com/">RabbitMQ</a> is a message broker service.
In PEcAn, RabbitMQ functions as a task manager and scheduler, coordinating the execution of different tasks (such as running models and analyzing results) associated with the PEcAn workflow.</p>
<p>Our configuration is as follows:</p>
<pre><code>rabbitmq:
  image: rabbitmq:management
  restart: unless-stopped
  networks: pecan
  environment:
  - RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=-rabbitmq_management path_prefix &quot;/rabbitmq&quot;
  - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER:-guest}
  - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS:-guest}
  labels:
  - traefik.enable=true
  - traefik.backend=rabbitmq
  - traefik.port=15672
  - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/rabbitmq
  - traefik.website.frontend.whiteList.sourceRange=${TRAEFIK_IPFILTER:-172.16.0.0/12}
  volumes: rabbitmq:/var/lib/rabbitmq</code></pre>
<p>Note that the <code>traefik.frontend.rule</code> indicates that browsing to <a href="http://localhost:8000/rabbitmq/" class="uri">http://localhost:8000/rabbitmq/</a> leads to the RabbitMQ management console.</p>
<p>By default, the RabbitMQ management console has username/password <code>guest/guest</code>, which is highly insecure.
For production instances of PEcAn, we highly recommend changing these credentials to something more secure, and removing access to the RabbitMQ management console via Traefik.</p>
</div>
<div id="pecan-dc-bety" class="section level4">
<h4><span class="header-section-number">4.3.3.11</span> <code>bety</code></h4>
<p>This service operates the BETY web interface, which is effectively a web-based front-end to the PostgreSQL database.
Unlike the <code>postgres</code> service, which contains all the data needed to run PEcAn models, this service is not essential to the PEcAn workflow.
However, note that certain features of the PEcAn web interface do link to the BETY web interface and will not work if this container is not running.</p>
<p>Our configuration is as follows:</p>
<pre><code>bety:
  image: pecan/bety:${BETY_VERSION:-latest}
  restart: unless-stopped
  networks: pecan
  environment:
  - UNICORN_WORKER_PROCESSES=1
  - SECRET_KEY_BASE=${BETY_SECRET_KEY:-notasecret}
  - RAILS_RELATIVE_URL_ROOT=/bety
  - LOCAL_SERVER=${BETY_LOCAL_SERVER:-99}
  depends_on: postgres
  labels:
  - traefik.enable=true
  - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/bety/
  - traefik.backend=bety</code></pre>
<p>The BETY container Dockerfile is located in the root directory of the <a href="https://github.com/pecan/bety">BETY GitHub repository</a> (<a href="https://github.com/PecanProject/bety/blob/master/Dockerfile">direct link</a>).</p>
</div>
<div id="pecan-dc-docs" class="section level4">
<h4><span class="header-section-number">4.3.3.12</span> <code>docs</code></h4>
<p>This service will show the documentation for the version of PEcAn running as well as a homepage with links to all relevant endpoints. You can access this at <a href="http://localhost:8000/" class="uri">http://localhost:8000/</a>. You can find the documentation for PEcAn at <a href="http://localhost:8000/docs/pecan/" class="uri">http://localhost:8000/docs/pecan/</a>.</p>
<p>Our current configuration is as follows:</p>
<pre><code>docs:
  image: pecan/docs:${PECAN_VERSION:-latest}
  restart: unless-stopped
  networks: pecan
  labels:
  - traefik.enable=true
  - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/
  - traefik.backend=docs</code></pre>
</div>
<div id="pecan-dc-web" class="section level4">
<h4><span class="header-section-number">4.3.3.13</span> <code>web</code></h4>
<p>This service runs the PEcAn web interface.
It is effectively a thin wrapper around a standard Apache web server container from Docker Hub that installs some additional dependencies and copies over the necessary files from the PEcAn source code.</p>
<p>Our configuration is as follows:</p>
<pre><code>web:
  image: pecan/web:${PECAN_VERSION:-latest}
  restart: unless-stopped
  networks: pecan
  environment:
  - RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
  - FQDN=${PECAN_FQDN:-docker}
  - NAME=${PECAN_NAME:-docker}
  depends_on:
  - postgres
  - rabbitmq
  labels:
  - traefik.enable=true
  - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefix:/pecan/
  - traefik.backend=pecan
  volumes:
  - pecan:/data
  - pecan:/var/www/html/pecan/data</code></pre>
<p>Its Dockerfile ships with the PEcAn source code, in <a href="https://github.com/PecanProject/pecan/blob/develop/docker/base/Dockerfile.web"><code>docker/base/Dockerfile.web</code></a>.</p>
<p>In terms of <a href="#pecan-docker-develop">actively developing PEcAn using Docker</a>, this is the service to modify when making changes to the web interface (i.e. PHP, HTML, and JavaScript code located in the PEcAn <code>web</code> directory).</p>
</div>
<div id="pecan-dc-executor" class="section level4">
<h4><span class="header-section-number">4.3.3.14</span> <code>executor</code></h4>
<p>This service is in charge of running the R code underlying the core PEcAn workflow.
However, it is <em>not</em> in charge of executing the models themselves – model binaries are located on their <a href="pecan-manual-setup.html#pecan-dc-models">own dedicated Docker containers</a>, and model execution is coordinated by RabbitMQ.</p>
<p>Our configuration is as follows:</p>
<pre><code>executor:
  image: pecan/executor:${PECAN_VERSION:-latest}
  restart: unless-stopped
  networks: pecan
  environment:
  - RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
  - FQDN=${PECAN_FQDN:-docker}
  depends_on:
  - postgres
  - rabbitmq
  volumes: pecan:/data</code></pre>
<p>Its Dockerfile is ships with the PEcAn source code, in <a href="https://github.com/PecanProject/pecan/blob/develop/docker/base/Dockerfile.executor"><code>docker/base/Dockerfile.executor</code></a>.
Its image is built on top of the <code>pecan/base</code> image (<a href="https://github.com/PecanProject/pecan/blob/develop/docker/base/Dockerfile.base"><code>docker/base/Dockerfile.base</code></a>), which contains the actual PEcAn source.
To facilitate caching, the <code>pecan/base</code> image is itself built on top of the <code>pecan/depends</code> image (<a href="https://github.com/PecanProject/pecan/blob/develop/docker/base/Dockerfile.depends"><code>docker/base/Dockerfile.depends</code></a>), a large image that contains an R installation and PEcAn’s many system and R package dependencies (which usually take ~30 minutes or longer to install from scratch).</p>
<p>In terms of <a href="#pecan-docker-develop">actively developing PEcAn using Docker</a>, this is the service to modify when making changes to the PEcAn R source code.
Note that, unlike changes to the <code>web</code> image’s PHP code, changes to the R source code do not immediately propagate to the PEcAn container; instead, you have to re-compile the code by running <code>make</code> inside the container.</p>
</div>
<div id="pecan-dc-monitor" class="section level4">
<h4><span class="header-section-number">4.3.3.15</span> <code>monitor</code></h4>
<p>This service will show all models that are currently running <a href="http://localhost:8000/monitor/" class="uri">http://localhost:8000/monitor/</a>. This list returned is JSON and shows all models (grouped by type and version) that are currently running, or where seen in the past. This list will also contain a list of all current active containers, as well as how many jobs are waiting to be processed.</p>
<p>This service is also responsible for registering any new models with PEcAn so users can select it and execute the model from the web interface.</p>
<p>Our current configuration is as follows:</p>
<pre><code>monitor:
  image: pecan/monitor:${PECAN_VERSION:-latest}
  restart: unless-stopped
  networks: pecan
  ports: 9999:9999
  environment:
  - RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
  - FQDN=${PECAN_FQDN:-docker}
  depends_on: rabbitmq
  labels:
  - traefik.enable=true
  - traefik.frontend.rule=${TRAEFIK_FRONTEND_RULE:-}PathPrefixStrip:/monitor/
  - traefik.backend=monitor
  volumes: pecan:/data</code></pre>
</div>
<div id="pecan-dc-models" class="section level4">
<h4><span class="header-section-number">4.3.3.16</span> Model-specific containers</h4>
<p>Additional models are added as additional services.
In general, their configuration should be similar to the following configuration for SIPNET, which ships with PEcAn:</p>
<pre><code>sipnet:
  image: pecan/model-sipnet-136:${PECAN_VERSION:-latest}
  restart: unless-stopped
  networks: pecan
  environment: RABBITMQ_URI=${RABBITMQ_URI:-amqp://guest:guest@rabbitmq/%2F}
  depends_on: rabbitmq
  volumes: pecan:/data</code></pre>
<p>The PEcAn source contains Dockerfiles for ED2 (<a href="https://github.com/PecanProject/pecan/blob/develop/docker/models/Dockerfile.ed2"><code>docker/models/Dockerfile.ed2</code></a>) and SIPNET (<a href="https://github.com/PecanProject/pecan/blob/develop/docker/models/Dockerfile.sipnet"><code>docker/models/Dockerfile.sipnet</code></a>) that can serve as references.
For additional tips on constructing a Dockerfile for your model, see <a href="pecan-manual-setup.html#model-docker">Dockerfiles for Models</a>.</p>

</div>
<div id="model-docker" class="section level4">
<h4><span class="header-section-number">4.3.3.17</span> Models using Docker</h4>
<p>This section will discuss how to add new models to PEcAn docker. To be able to add a new model to PEcAn when using docker is as simple as starting a new container. The model will come online and let the PEcAn framework know there is a new model available, there is no need to go through the process of registering this model with PEcAn. Users will be able to select this new model from web interface and run with this model selected.</p>
<p>For this process to work a docker image of the model will need to be created as well as small json file that is used to announce this new model. A separate service in PEcAn (<a href="pecan-manual-setup.html#pecan-dc-monitor"><code>monitor</code></a>) will use this json file to keep track of all models available as well as register these models with PEcAn.</p>
<p><a href="pecan-manual-setup.html#model-docker-json-file">Model information</a>
<a href="pecan-manual-setup.html#model-docker-Dockerfile">Model build</a>
<a href="pecan-manual-setup.html#common-docker-problems">Common problems</a></p>
</div>
<div id="model-docker-json-file" class="section level4">
<h4><span class="header-section-number">4.3.3.18</span> Model information</h4>
<p>Each model will have a small json file called model_info.json that is used to describe the model and used by the monitor service to register the model with PEcAn. This file will contain information about the model that is send as part of the heartbeat of the container to the monitor service. Below is an example of this file for the ED model. The required fields are <code>name</code>, <code>type</code>, <code>version</code> and <code>binary</code>. The fields <code>type</code> and <code>version</code> are used by PEcAn to send the messages to RabbitMQ. There is no need to specify the queue name explicitly. The queue name will be created by combining these two fields with an underscore. The field <code>binary</code> is used to point to the actual binary in the docker container.</p>
<p>There are 2 special values that can be used, <code>@VERSION@</code> which will be replaced by the version that is passed in when building the container, and <code>@BINARY@</code> which will be replaced by the binary when building the docker image.</p>
<pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;ED2.2&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;ED2&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;@VERSION@&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;binary&quot;</span><span class="fu">:</span> <span class="st">&quot;@BINARY@&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;The Ecosystem Demography Biosphere Model (ED2) is an integrated terrestrial biosphere model incorporating hydrology, land-surface biophysics, vegetation dynamics, and soil carbon and nitrogen biogeochemistry&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;author&quot;</span><span class="fu">:</span> <span class="st">&quot;Mike Dietze&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;contributors&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;David LeBauer&quot;</span><span class="ot">,</span> <span class="st">&quot;Xiaohui Feng&quot;</span><span class="ot">,</span> <span class="st">&quot;Dan Wang&quot;</span><span class="ot">,</span> <span class="st">&quot;Carl Davidson&quot;</span><span class="ot">,</span> <span class="st">&quot;Rob Kooper&quot;</span><span class="ot">,</span> <span class="st">&quot;Shawn Serbin&quot;</span><span class="ot">,</span> <span class="st">&quot;Alexey Shiklomanov&quot;</span><span class="ot">]</span><span class="fu">,</span>
  <span class="dt">&quot;links&quot;</span><span class="fu">:</span> <span class="fu">{</span>
    <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="st">&quot;https://github.com/EDmodel/ED2&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;issues&quot;</span><span class="fu">:</span> <span class="st">&quot;https://github.com/EDmodel/ED2/issues&quot;</span>
  <span class="fu">},</span>
  <span class="dt">&quot;inputs&quot;</span><span class="fu">:</span> <span class="fu">{},</span>
  <span class="dt">&quot;citation&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Medvigy D., Wofsy S. C., Munger J. W., Hollinger D. Y., Moorcroft P. R. 2009. Mechanistic scaling of ecosystem function and dynamics in space and time: Ecosystem Demography model version 2. J. Geophys. Res. 114 (doi:10.1029/2008JG000812)&quot;</span><span class="ot">]</span>
<span class="fu">}</span></code></pre>
<p>Other fields that are recommended, but currently not used yet, are:</p>
<ul>
<li><code>description</code> : a longer description of the model.</li>
<li><code>creator</code> : contact person about this docker image.</li>
<li><code>contribuor</code> : other people that have contributed to this docker image.</li>
<li><code>links</code> : addtional links to help people when using this docker image, for example values that can be used are <code>source</code> to link to the source code, <code>issues</code> to link to issue tracking system, and <code>documentation</code> to link to model specific documentation.</li>
<li><code>citation</code> : how the model should be cited in publications.</li>
</ul>
</div>
<div id="model-docker-Dockerfile" class="section level4">
<h4><span class="header-section-number">4.3.3.19</span> Model build</h4>
<p>In general we try to minimize the size of the images. To be able to do this we split the process of creating the building of the model images into two pieces (or leverage of an image that exists from the original model developers). If you look at the example Dockerfile you will see that there are 2 sections, the first section will build the model binary, the second section will build the actual PEcAn model, which copies the binary from the first section.</p>
<p>This is an example of how the ED2 model is build. This will install all the packages needed to build ED2 model, gets the latest version from GitHub and builds the model.</p>
<p>The second section will create the actual model runner. This will leverage the PEcAn model image that has PEcAn already installed as well as the python code to listen for messages and run the actual model code. This will install some additional packages needed by the model binary (more about that below), copy the model_info.json file and change the <code>@VERSION@</code> and <code>@BINARY@</code> placeholders.</p>
<p>It is important values for <code>type</code> and <code>version</code> are set correct. The PEcAn code will use these to register the model with the BETY database, which is then used by PEcAn to send out a message to a specfic worker queue, if you do not set these variables correctly your model executor will pick up messages for the wrong model.</p>
<p>To build the docker image, we use a Dockerfile (see example below) and run the following command. This command will expect the Dockerfile to live in the model specific folder and the command is executed in the root pecan folder. It will copy the content of the pecan folder and make it available to the build process (in this example we do not need any additional files).</p>
<p>Since we can have multiple different versions of a model be available for PEcAn we ar using the following naming schema <code>pecan/model-&lt;modeltype&gt;-&lt;version&gt;:&lt;pecan version</code>. For example the image below will be named pecan/model-ed2-git, since we do not specify the exact version it will be atomically be named <code>pecan/model-ed2-git:latest</code>.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> build \
    --tag pecan/model-ed2-git \
    --file models/ed/Dockerfile \
    .</code></pre>
<p>Example of a Dockerfile, in this case to build the ED2 model.</p>
<pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># BUILD MODEL BINARY</span>
<span class="co"># ----------------------------------------------------------------------</span>
<span class="kw">FROM</span> debian:stretch as model-binary

<span class="co"># Some variables that can be used to set control the docker build</span>
<span class="kw">ARG</span> MODEL_VERSION=git

<span class="co"># install dependencies</span>
<span class="kw">RUN</span> apt-get update \
    &amp;&amp; apt-get install -y --no-install-recommends \
       build-essential \
       curl \
       gfortran \
       git \
       libhdf5-dev \
       libopenmpi-dev \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

<span class="co"># download, unzip and build ed2</span>
<span class="kw">WORKDIR</span> /src
<span class="kw">RUN</span> git -c http.sslVerify=false clone https://github.com/EDmodel/ED2.git \
    &amp;&amp; cd ED2/ED/build \
    &amp;&amp; curl -o make/include.mk.VM http://isda.ncsa.illinois.edu/~kooper/EBI/include.mk.opt.Linux \
    &amp;&amp; if [ <span class="st">&quot;${MODEL_VERSION}&quot;</span> != <span class="st">&quot;git&quot;</span> ]; then git checkout ${MODEL_VERSION}; fi \
    &amp;&amp; ./install.sh -g -p VM

<span class="co">########################################################################</span>

<span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># BUILD PECAN FOR MODEL</span>
<span class="co"># ----------------------------------------------------------------------</span>
<span class="kw">FROM</span> pecan/models:latest

<span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># INSTALL MODEL SPECIFIC PIECES</span>
<span class="co"># ----------------------------------------------------------------------</span>

<span class="kw">RUN</span> apt-get update \
    &amp;&amp; apt-get install -y --no-install-recommends \
       libgfortran3 \
       libopenmpi2 \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

<span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># SETUP FOR SPECIFIC MODEL</span>
<span class="co"># ----------------------------------------------------------------------</span>

<span class="co"># Some variables that can be used to set control the docker build</span>
<span class="kw">ARG</span> MODEL_VERSION=git

<span class="co"># Setup model_info file</span>
<span class="kw">COPY</span> models/ed/model_info.json /work/model.json
<span class="kw">RUN</span> sed -i -e <span class="st">&quot;s/@VERSION@/${MODEL_VERSION}/g&quot;</span> \
           -e <span class="st">&quot;s#@BINARY@#/usr/local/bin/ed2.${MODEL_VERSION}#g&quot;</span> /work/model.json

<span class="co"># COPY model binary</span>
<span class="kw">COPY</span> --from=model-binary /src/ED2/ED/build/ed_2.1-opt /usr/local/bin/ed2.${MODEL_VERSION}</code></pre>
<p><strong>WARNING</strong>: Dockerfile environment variables set via <code>ENV</code> are assigned <em>all at once</em>; <em>they do not evaluate successively, left to right</em>.
Consider the following block:</p>
<pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="co"># Don&#39;t do this!</span>
<span class="kw">ENV</span> MODEL_TYPE=<span class="st">&quot;SIPNET&quot;</span> \
    MODEL_VERSION=136 \
    MODEL_TYPE_VERSION=${MODEL_TYPE}_${MODEL_VERSION}   <span class="co"># &lt;- Doesn&#39;t know about MODEL_TYPE or MODEL_VERSION!</span></code></pre>
<p>In this block, the expansion for setting <code>MODEL_TYPE_VERSION</code> <em>is not aware</em> of the current values of <code>MODEL_TYPE</code> or <code>MODEL_VERSION</code>, and will therefore be set incorrectly to just <code>_</code> (unless they have been set previously, in which case it will be aware only of their earlier values).
As such, <strong>variables depending on other variables must be set in a separate, subsequent <code>ENV</code> statement than the variables they depend on</strong>.</p>
<p>Once the model has build and is working we can add it to the PEcAn stack and be able to use this model in the web interface. There are two methods to start this new model. First, we can add it to the <code>docker-compose.yml</code> file and start the container using <code>docker-compose -p pecan -d up</code>.</p>
<pre class="sourceCode yaml"><code class="sourceCode yaml">  <span class="fu">sipnet:</span>
    <span class="fu">image:</span><span class="at"> pecan/model-ed2-git</span>
    <span class="fu">networks:</span>
      <span class="kw">-</span> pecan
    <span class="fu">volumes:</span>
      <span class="kw">-</span> <span class="fu">pecan:</span><span class="at">/data</span>
    <span class="fu">depends_on:</span>
       <span class="kw">-</span> rabbitmq
    <span class="fu">restart:</span><span class="at"> unless-stopped</span></code></pre>
<p>Alternatively we can start the container manually using the following command.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run \
    --detach \
    --rm \
    --name pecan-ed2-git \
    --networks pecan_pecan \
    --volume pecan_pecan:/data
    <span class="ex">pecan/model-ed2-git</span></code></pre>
</div>
<div id="common-docker-problems" class="section level4">
<h4><span class="header-section-number">4.3.3.20</span> Common problems</h4>
<p>Following are some solutions for common problems that you might encounter when building the docker images for a model.</p>
</div>
<div id="debugging-missing-libraries" class="section level4">
<h4><span class="header-section-number">4.3.3.21</span> Debugging missing libraries</h4>
<p>When building the model binary it might require specific libraries to be installed. In the second stage the model binary is copied into a new image, which could result in the binary missing specific libraries. In the case of the ED2 model the following was used to find the libraries that are needed to be installed (libgfortran5 and libopenmpi3).</p>
<p>The first step is to build the model using the Dockerfile (in this case the ap-get install was missing in the second stage).</p>
<pre><code>Step 5/9 : RUN git clone https://github.com/EDmodel/ED2.git     &amp;&amp; cd ED2/ED/build     &amp;&amp; curl -o make/include.mk.VM http://isda.ncsa.illinois.edu/~kooper/EBI/include.mk.opt.`uname -s`     &amp;&amp; if [ &quot;${MODEL_VERSION}&quot; != &quot;git&quot; ]; then git checkout ${MODEL_VERSION}; fi     &amp;&amp; ./install.sh -g -p VM
... LOTS OF OUTPUT ...
make[1]: Leaving directory &#39;/src/ED2/ED/build/bin-opt-E&#39;
Installation Complete.
Removing intermediate container a53eba9a8fc1
 ---&gt; 7f23c6302130
Step 6/9 : FROM pecan/executor:latest
 ---&gt; f19d81b739f5
... MORE OUTPUT ...
Step 9/9 : COPY --from=model-binary /src/ED2/ED/build/ed_2.1-opt /usr/local/bin/ed2.${MODEL_VERSION}
 ---&gt; 07ac841be457
Successfully built 07ac841be457
Successfully tagged pecan/pecan-ed2:latest</code></pre>
<p>At this point we have created a docker image with the binary and all PEcAn code that is needed to run the model. Some models (especially those build as native code) might be missing additional packages that need to be installed in the docker image. To see if all libraries are installed for the binary.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="op">&gt;</span> <span class="ex">docker</span> run -ti --rm pecan/pecan-ed2 /bin/bash
<span class="ex">root@8a95ee8b6b47</span>:/work# ldd /usr/local/bin/ed2.git  <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;not found&quot;</span>
    <span class="ex">libmpi_usempif08.so.40</span> =<span class="op">&gt;</span> not found
    <span class="ex">libmpi_usempi_ignore_tkr.so.40</span> =<span class="op">&gt;</span> not found
    <span class="ex">libmpi_mpifh.so.40</span> =<span class="op">&gt;</span> not found
    <span class="ex">libmpi.so.40</span> =<span class="op">&gt;</span> not found
    <span class="ex">libgfortran.so.5</span> =<span class="op">&gt;</span> not found</code></pre>
<p>Start the build container again (this is the number before the line FROM pecan/executor:latest, 7f23c6302130 in the example), and find the missing libraries listed above (for example libmpi_usempif08.so.40):</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="op">&gt;</span> <span class="ex">docker</span> run --rm -ti 7f23c6302130
<span class="ex">root@e716c63c031f</span>:/src# dpkg -S libmpi_usempif08.so.40
<span class="ex">libopenmpi3</span>:amd64: /usr/lib/x86_64-linux-gnu/openmpi/lib/libmpi_usempif08.so.40.10.1
<span class="ex">libopenmpi3</span>:amd64: /usr/lib/x86_64-linux-gnu/libmpi_usempif08.so.40.10.1
<span class="ex">libopenmpi3</span>:amd64: /usr/lib/x86_64-linux-gnu/libmpi_usempif08.so.40</code></pre>
<p>This shows the pages is libopenmpi3 that needs to be installed, do this for all missing packages, modify the Dockerfile and rebuild. Next time you run the ldd command there should be no more packages being listed.</p>

</div>
<div id="docker-build-images" class="section level4">
<h4><span class="header-section-number">4.3.3.22</span> Building and modifying images</h4>
<p>The only other section on this page is:
<a href="pecan-manual-setup.html#docker-local-devel">Local development and testing with Docker</a></p>
<p>For general use, it is sufficient to use the pre-built PEcAn images hosted on <a href="https://hub.docker.com/r/pecan/">Docker Hub</a> (see <a href="pecan-manual-setup.html#docker-quickstart">Docker quickstart</a>).
However, there are cases where it makes sense to re-build the Docker images locally.
The following is a list of PEcAn-specific images and reasons why you would want to rebuild them locally:</p>
<ul>
<li><code>pecan/depends</code> – Rebuild if:
<ul>
<li>You modify the <code>docker/base/Dockerfile.depends</code></li>
<li>You introduce new system dependencies (i.e. things that need to be installed with <code>apt-get</code>)</li>
<li>You introduce new R package dependencies, and you want those R package installations to be cached during future builds. For packages with fast build times, it may be fine to let them be installed as part of PEcAn’s standard build process (i.e. <code>make</code>).</li>
</ul></li>
<li><code>pecan/base</code> – Rebuild if:
<ul>
<li>You built a new version of <code>pecan/depends</code> (on which <code>pecan/base</code> depends)</li>
<li>You modify the <code>docker/base/Dockerfile.base</code></li>
<li>You made changes to the PEcAn R package source code, the Makefile, or <code>web/workflow.R</code>.
<ul>
<li>NOTE that changes to the web interface code affect <code>pecan/web</code>, <em>not</em> <code>pecan/base</code></li>
</ul></li>
</ul></li>
<li><code>pecan/executor</code> – Rebuild if:
<ul>
<li>You built a new version of <code>pecan/base</code> (on which <code>pecan/executor</code> depends) and/or, <code>pecan/depends</code> (on which <code>pecan/base</code> depends)</li>
<li>You modified the <code>docker/base/Dockerfile.executor</code></li>
<li>You modified the RabbitMQ Python scripts (e.g. <code>docker/receiver.py</code>, <code>docker/sender.py</code>)</li>
</ul></li>
<li><code>pecan/web</code> – Rebuild if you modified any of the following:
<ul>
<li><code>docker/base/Dockerfile.web</code></li>
<li>The PHP/HTML/JavaScript code for the PEcAn web interface in <code>web/</code> (<em>except</em> <code>web/workflow.R</code> – that goes in <code>pecan/base</code>)</li>
<li><code>docker/config.docker.php</code> (the <code>config.php</code> file for Docker web instances)</li>
<li><code>documentation/index_vm.html</code> (the documentation HTML website)</li>
<li>NOTE: Because changes to this code are applied instantly (i.e. do not require compilation or installation), a more effective way to do local development may be to mount the <code>web/</code> or other relevant folders as a volume onto the <code>pecan/web</code> container.</li>
</ul></li>
</ul>
<p>The easiest way to quickly re-build all of the images is using the <code>docker.sh</code> script in the PEcAn source code root directory.
This script will build all of the docker images locally on your machine, and tag them as <code>latest</code>.
This will not build the <code>pecan/depends</code> image by default because that takes considerably longer.
However, you can force the script to build <code>pecan/depends</code> as well by setting the <code>DEPEND</code> environment variable to 1 (i.e. <code>DEPEND=1 ./docker.sh</code>).
The following instructions provide details on how to build each image individually.</p>
<p>To build an image locally, use the <code>docker build</code> command as described below.
For more details, see <code>docker build --help</code> or the <a href="https://docs.docker.com/engine/reference/commandline/build/">online Docker build documentation</a>.</p>
<p>First, in a terminal window, navigate (<code>cd</code>) into the PEcAn source code root directory.
From there, the general syntax for building an image looks like the following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> build -t pecan/<span class="op">&lt;</span>image name<span class="op">&gt;</span>:<span class="op">&lt;</span>image version<span class="op">&gt;</span> -f docker/base/Dockerfile.<span class="op">&lt;</span>image name<span class="op">&gt;</span> .</code></pre>
<p>For instance, to build a local version of the <code>pecan/depends:latest</code> image, you would run:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> build -t pecan/depends:latest -f docker/base/Dockerfile.depends .</code></pre>
<p>The breakdown of this command is as follows:</p>
<ul>
<li><p><code>docker build</code> – This is the core command.
The standard syntax is <code>docker build [OPTIONS] &lt;PATH&gt;</code>, where <code>&lt;PATH&gt;</code> refers to the directory to be used as the “build context”.
The “build context” is the working directory assumed by the Dockerfiles.
In PEcAn, this is always the PEcAn source code root directory, which allows Dockerfiles to use instructions such as <code>COPY web/workflow.R /work/</code>.
In this example, the <code>&lt;PATH&gt;</code> is set to the current working directory, i.e. <code>.</code> because we are already in the PEcAn root directory.
If you were located in a different directory, you would have to provide a path to the PEcAn source code root directory.
Also, by default, <code>docker build</code> will look for a Dockerfile located at <code>&lt;PATH&gt;/Dockerfile</code>, but this is modified by the <code>-f</code> option described below.</p></li>
<li><code>-t pecan/depends:latest</code> – The <code>-t/--tag</code> option specifies how the image will be labeled.
By default, Docker only defines unique image IDs, which are hexidecimal strings that are unintuitive and hard to remember.
Tags are useful for referring to specific images in a human-readable way.
Note that the same unique image can have multiple tags associated with it, so it is possible for, e.g. <code>pecan/depends:latest</code>, <code>pecan/depends:custom</code>, and even <code>mypecan/somethingelse:20.0</code> to refer to the same exact image.
To see a table of all local images, including their tags and IDs, run <code>docker image ls</code>.
<ul>
<li><strong>NOTE</strong>: PEcAn’s <code>docker-compose.yml</code> can be configured via the <code>PECAN</code> environment variable to point at different versions of PEcAn images.
By default, it points to the <code>:latest</code> versions of all images.
However, if you wanted to, for instance, build <code>:local</code> images corresponding to your local source code and then run that version of PEcAn, you would run:</li>
</ul>
<pre><code>PECAN=local docker-compose -p pecan up -d</code></pre>
<p>This is an effective way to do local development and testing of different PEcAn versions, as described <a href="pecan-manual-setup.html#docker-local-devel">below</a>.</p></li>
<li><p><code>-f docker/base/Dockerfile.depends</code> – The <code>-f/--file</code> tag is used to provide an alternative location and file name for the Dockerfile.
The convention in PEcAn is to put Dockerfiles for core PEcAn functionality in <code>docker/base/</code> and for specific models in <code>docker/models/</code>, and to name these files <code>Dockerfile.&lt;image name&gt;</code>.</p></li>
</ul>
</div>
<div id="docker-local-devel" class="section level4">
<h4><span class="header-section-number">4.3.3.23</span> Local development and testing with Docker</h4>
<p>The following is an example of one possible workflow for developing and testing PEcAn using local Docker images.
The basic idea is to mount a local version of the PEcAn source code onto a running <code>pecan/executor</code> image, and then send a special “rebuild” RabbitMQ message to the container to trigger the rebuild whenever you make changes.
NOTE: All commands assume you are working from the PEcAn source code root directory.</p>
<ol style="list-style-type: decimal">
<li><p>In the PEcAn source code directory, create a <code>docker-compose.override.yml</code> file with the following contents.:</p>
<pre class="sourceCode yml"><code class="sourceCode yaml"><span class="fu">version:</span><span class="at"> </span><span class="st">&quot;3&quot;</span>
<span class="fu">services:</span>
  <span class="fu">executor:</span>
    <span class="fu">volumes:</span>
      <span class="kw">-</span> <span class="fu">.:</span><span class="at">/pecan</span></code></pre>
<p>This will mount the current directory <code>.</code> to the <code>/pecan</code> directory in the <code>executor</code> container.
The special <code>docker-compose.override.yml</code> file is read automatically by <code>docker-compose</code> and overrides or extends any instructions set in the original <code>docker-compose.yml</code> file.
It provides a convenient way to host server-specific configurations without having to modify the project-wide (and version-controlled) default configuration.
For more details, see the <a href="https://docs.docker.com/compose/extends/">Docker Compose documentation</a>.</p></li>
<li><p>Update your PEcAn Docker stack with <code>docker-compose up -d</code>.
If the stack is already running, this should only restart your <code>executor</code> instance while leaving the remaining containers running.</p></li>
<li><p>To update to the latest local code, run <code>./scripts/docker_rebuild.sh</code>.
Under the hood, this uses <code>curl</code> to post a RabbitMQ message to a running Docker instance.
By default, the scripts assumes that username and password are both <code>guest</code> and that the RabbitMQ URL is <code>http://localhost:8000/rabbitmq</code>.
All of these can be customized by setting the environment variables <code>RABBITMQ_USER</code>, <code>RABBITMQ_PASSWORD</code>, and <code>RABBITMQ_URL</code>, respectively (or running the script prefixed with those variables, e.g. <code>RABBITMQ_USER=carya RABBITMQ_PASSWORD=illinois ./scripts/docker_rebuild.sh</code>).
This step can be repeated whenever you want to trigger a rebuild of the local code.</p></li>
</ol>
<p>NOTE: The updates with this workflow are <em>specific to the running container session</em>; restarting the <code>executor</code> container will revert to the previous versions of the installed packages.
To make persistent changes, you should re-build the <code>pecan/base</code> and <code>pecan/executor</code> containers against the current version of the source code.</p>
<p>NOTE: The mounted PEcAn source code directory includes <em>everything</em> in your local source directory, <em>including installation artifacts used by make</em>.
This can lead to two common issues:
- Any previous make cache files (stuff in the <code>.install</code>, <code>.docs</code>, etc. directories) persist across container instances, even though the installed packages may not. To ensure a complete build, it’s a good idea to run <code>make clean</code> on the host machine to remove these artifacts.
- Similarly, any installation artifacts from local builds will be carried over to the build. In particular, be wary of packages with compiled code, such as <code>modules/rtm</code> (<code>PEcAnRTM</code>) – the compiled <code>.o</code>, <code>.so</code>, <code>.mod</code>, etc. files from compilation of such packages will carry over into the build, which can cause conflicts if the package was also built locally.</p>
<p>The <code>docker-compose.override.yml</code> is useful for some other local modifications.
For instance, the following adds a custom ED2 “develop” model container.</p>
<pre class="sourceCode yml"><code class="sourceCode yaml"><span class="fu">services:</span>
  <span class="co"># ...</span>
  <span class="fu">ed2devel:</span>
    <span class="fu">image:</span><span class="at"> pecan/model-ed2-develop:latest</span>
    <span class="fu">build:</span>
      <span class="fu">context:</span><span class="at"> ../ED2  </span><span class="co"># Or wherever ED2 source code is found</span>
    <span class="fu">networks:</span>
      <span class="kw">-</span> pecan
    <span class="fu">depends_on:</span>
      <span class="kw">-</span> rabbitmq
    <span class="fu">volumes:</span>
      <span class="kw">-</span> <span class="fu">pecan:</span><span class="at">/data</span>
    <span class="fu">restart:</span><span class="at"> unless-stopped</span></code></pre>
<p>Similarly, this snippet modifies the <code>pecan</code> network to use a custom IP subnet mask.
This is required on the PNNL cluster because its servers’ IP addresses often clash with Docker’s default IP mask.</p>
<pre class="sourceCode yml"><code class="sourceCode yaml"><span class="fu">networks:</span>
  <span class="fu">pecan:</span>
    <span class="fu">ipam:</span>
      <span class="fu">config:</span>
        <span class="kw">-</span> <span class="fu">subnet:</span><span class="at"> 10.17.1.0/24</span></code></pre>

</div>
<div id="docker-troubleshooting" class="section level4">
<h4><span class="header-section-number">4.3.3.24</span> Troubleshooting Docker</h4>
</div>
<div id="package-not-available-while-building-images" class="section level4">
<h4><span class="header-section-number">4.3.3.25</span> “Package not available” while building images</h4>
<p><strong>PROBLEM</strong>: Packages fail to install while building <code>pecan/depends</code> and/or <code>pecan/base</code> with an error like the following:</p>
<pre><code>Installing package into ‘/usr/local/lib/R/site-library’
(as ‘lib’ is unspecified)
Warning: unable to access index for repository https://mran.microsoft.com/snapshot/2018-09-01/src/contrib:
 cannot open URL &#39;https://mran.microsoft.com/snapshot/2018-09-01/src/contrib/PACKAGES&#39;
Warning message:
package ‘&lt;PACKAGE&gt;’ is not available (for R version 3.5.1)</code></pre>
<p><strong>CAUSE</strong>: This can sometimes happen if there are problems with Microsoft’s CRAN snapshots, which are the default repository for the <code>rocker/tidyverse</code> containers.
See GitHub issues <a href="https://github.com/rocker-org/rocker-versioned/issues/102">rocker-org/rocker-versioned#102</a> and <a href="https://github.com/rocker-org/rocker-versioned/issues/58">#58</a>.</p>
<p><strong>SOLUTION</strong>: Add the following line to the <code>depends</code> and/or <code>base</code> Dockerfiles <em>before</em> (i.e. above) any commands that install R packages (e.g. <code>Rscript -e &quot;install.packages(...)&quot;</code>):</p>
<pre><code>RUN echo &quot;options(repos = c(CRAN = &#39;https://cran.rstudio.org&#39;))&quot; &gt;&gt; /usr/local/lib/R/etc/Rprofile.site</code></pre>
<p>This will set the default repository to the more reliable (albeit, more up-to-date; beware of breaking package changes!) RStudio CRAN mirror.
Then, build the image as usual.</p>

</div>
<div id="docker-migrate" class="section level4">
<h4><span class="header-section-number">4.3.3.26</span> Migrating PEcAn from VM to Docker</h4>
<p>This document assumes you have read through the <a href="pecan-manual-setup.html#docker-intro">Introduction to Docker</a> as well as <a href="pecan-manual-setup.html#docker-quickstart">Docker quickstart</a> and have docker running on the VM.</p>
<p>This document will slowly replace each of the components with the appropriate docker images. At then end of this document you should be able to use the docker-compose command to bring up the full docker stack as if you had started with this origianally.</p>
</div>
<div id="running-bety-as-a-docker-container" class="section level4">
<h4><span class="header-section-number">4.3.3.27</span> Running BETY as a docker container</h4>
<p>This will replace the BETY application running on the machine with a docker image. This will assume you still have the database running on the local machine and the only thing we replace is the BETY application.</p>
<p>If you are running systemd (Ubuntu 16.04 or Centos 7) you can copy the following file to /etc/systemd/system/bety.service (replace LOCAL_SERVER=99 with your actual server). If you have postgres running on another server replace 127.0.0.1 with the actual ip address of the postgres server.</p>
<pre><code>[Unit]
Description=BETY container
After=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker run -t --rm --name bety --add-host=postgres:127.0.0.1 --network=host --env RAILS_RELATIVE_URL_ROOT=/bety --env LOCAL_SERVER=99 pecan/bety
ExecStop=/usr/bin/docker stop -t 2 bety

[Install]
WantedBy=local.target</code></pre>
<p>At this point we can enable the bety service (this only needs to be done once). First we need to tell systemd a new service is available using <code>systemctl daemon-reload</code>. Next we enable the BETY service so it will restart automatically when the machine reboots, using <code>systemctl enable bety</code>. Finally we can start the BETY service using <code>systemctl start bety</code>. At this point BETY is running as a docker container on port 8000. You can see the log messages using <code>journalctl -u bety</code>.</p>
<p>Next we need to modify apache configuration files. The file /etc/apache2/conf-enabled/bety.conf will be replaced with the following content:</p>
<pre><code>ProxyPass                /bety/ http://localhost:8000/bety/
ProxyPassReverse         /bety/ http://localhost:8000/bety/
RedirectMatch permanent ^/bety$ /bety/</code></pre>
<p>Once this modified we can restart apache using <code>systemctl restart apache2</code>. At this point BETY is running in a container and is accessable trough the webserver at <a href="http://server/bety/" class="uri">http://server/bety/</a>.</p>
<p>To upgrade to a new version of BETY you can now use the docker commands. You can use the following commands to stop BETY, pull the latest image down, migrate the database (you made a backup correct?) and start BETY again.</p>
<pre><code>systemctl stop bety
docker pull pecan/bety:latest
docker run -ti --rm --add-host=postgres:127.0.0.1 --network=host --env LOCAL_SERVER=99 pecan/bety migrate
systemctl start bety</code></pre>
<p>Once you are satisfied with the migration of BETY you can remove the bety folder as well as any ruby binaries you have installed.</p>

</div>
</div>
<div id="osinstall" class="section level3">
<h3><span class="header-section-number">4.3.4</span> OS Specific Installations</h3>
<ul>
<li><a href="pecan-manual-setup.html#ubuntu">Ubuntu</a></li>
<li><a href="#centos/redhat">CentOS</a></li>
<li><a href="pecan-manual-setup.html#macosx">OSX</a></li>
<li><a href="pecan-manual-setup.html#install-bety">Install BETY</a> THIS PAGE IS DEPRECATED</li>
<li><a href="pecan-manual-setup.html#install-models">Install Models</a></li>
<li><a href="pecan-manual-setup.html#install-data">Install Data</a></li>
</ul>

<div id="ubuntu" class="section level4">
<h4><span class="header-section-number">4.3.4.1</span> Ubuntu</h4>
<p>These are specific notes for installing PEcAn on Ubuntu (14.04) and will be referenced from the main <a href="Installing-PEcAn">installing PEcAn</a> page. You will at least need to install the build environment and Postgres sections. If you want to access the database/PEcAn using a web browser you will need to install Apache. To access the database using the BETY interface, you will need to have Ruby installed.</p>
<p>This document also contains information on how to install the Rstudio server edition as well as any other packages that can be helpful.</p>
<div id="install-build-environment" class="section level5">
<h5><span class="header-section-number">4.3.4.1.1</span> Install build environment</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -s

<span class="co"># point to latest R</span>
<span class="bu">echo</span> <span class="st">&quot;deb http://cran.rstudio.com/bin/linux/ubuntu </span><span class="kw">`</span><span class="ex">lsb_release</span> -s -c<span class="kw">`</span><span class="st">/&quot;</span> <span class="op">&gt;</span> /etc/apt/sources.list.d/R.list
<span class="ex">apt-key</span> adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9

<span class="co"># update package list</span>
<span class="ex">apt-get</span> -y update

<span class="co"># install packages needed for PEcAn</span>
<span class="ex">apt-get</span> -y install build-essential gfortran git r-base-core r-base-dev jags liblapack-dev libnetcdf-dev netcdf-bin bc libcurl4-gnutls-dev curl udunits-bin libudunits2-dev libgmp-dev python-dev libgdal1-dev libproj-dev expect

<span class="co"># install packages needed for ED2</span>
<span class="ex">apt-get</span> -y install openmpi-bin libopenmpi-dev

<span class="co"># install requirements for DALEC</span>
<span class="ex">apt-get</span> -y install libgsl0-dev

<span class="co"># install packages for webserver</span>
<span class="ex">apt-get</span> -y install apache2 libapache2-mod-php5 php5

<span class="co"># install packages to compile docs</span>
<span class="ex">apt-get</span> -y install texinfo texlive-latex-base texlive-latex-extra texlive-fonts-recommended

<span class="co"># install devtools</span>
<span class="bu">echo</span> <span class="st">&#39;install.packages(&quot;devtools&quot;, repos=&quot;http://cran.rstudio.com/&quot;)&#39;</span> <span class="kw">|</span> <span class="ex">R</span> --vanilla

<span class="co"># done as root</span>
<span class="bu">exit</span></code></pre>
</div>
<div id="install-postgres" class="section level5">
<h5><span class="header-section-number">4.3.4.1.2</span> Install Postgres</h5>
<p>Documentation: <a href="http://trac.osgeo.org/postgis/wiki/UsersWikiPostGIS21UbuntuPGSQL93Apt" class="uri">http://trac.osgeo.org/postgis/wiki/UsersWikiPostGIS21UbuntuPGSQL93Apt</a></p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -s

<span class="co"># point to latest PostgreSQL</span>
<span class="bu">echo</span> <span class="st">&quot;deb http://apt.postgresql.org/pub/repos/apt </span><span class="kw">`</span><span class="ex">lsb_release</span> -s -c<span class="kw">`</span><span class="st">-pgdg main&quot;</span> <span class="op">&gt;</span> /etc/apt/sources.list.d/pgdg.list
<span class="fu">wget</span> --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc <span class="kw">|</span> <span class="ex">apt-key</span> add -

<span class="co"># update package list</span>
<span class="ex">apt-get</span> -y update

<span class="co"># install packages for postgresql (using a newer version than default)</span>
<span class="ex">apt-get</span> -y install libdbd-pgsql postgresql postgresql-client libpq-dev postgresql-9.4-postgis-2.1 postgresql-9.4-postgis-2.1-scripts

<span class="co"># install following if you want to run pecan through the web</span>
<span class="ex">apt-get</span> -y install php5-pgsql

<span class="co"># enable bety user to login with trust by adding the following lines after</span>
<span class="co"># the ability of postgres user to login in /etc/postgresql/9.4/main/pg_hba.conf</span>
<span class="bu">local</span>   <span class="va">all</span>             <span class="va">bety</span>                                    <span class="va">trust</span>
<span class="ex">host</span>    all             bety            127.0.0.1/32            trust
<span class="ex">host</span>    all             bety            ::1/128                 trust

<span class="co"># Once done restart postgresql</span>
<span class="ex">/etc/init.d/postgresql</span> restart

<span class="bu">exit</span></code></pre>
<p>To install the BETYdb database ..
##### Apache Configuration PEcAn</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># become root</span>
<span class="fu">sudo</span> -s

<span class="co"># get index page</span>
<span class="fu">rm</span> /var/www/html/index.html
<span class="fu">ln</span> -s <span class="va">${HOME}</span>/pecan/documentation/index_vm.html /var/www/html/index.html

<span class="co"># setup a redirect</span>
<span class="fu">cat</span> <span class="op">&gt;</span> /etc/apache2/conf-available/pecan.conf <span class="op">&lt;&lt; EOF</span>
Alias /pecan <span class="va">${HOME}</span>/pecan/web
&lt;Directory <span class="va">${HOME}</span>/pecan/web&gt;
  DirectoryIndex index.php
  Options +ExecCGI
  Require all granted
&lt;/Directory&gt;
<span class="op">EOF</span>
<span class="ex">a2enconf</span> pecan
<span class="ex">/etc/init.d/apache2</span> restart

<span class="co"># done as root</span>
<span class="bu">exit</span></code></pre>
</div>
<div id="apache-configuration-bety" class="section level5">
<h5><span class="header-section-number">4.3.4.1.3</span> Apache Configuration BETY</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -s

<span class="co"># install all ruby related packages</span>
<span class="ex">apt-get</span> -y install ruby2.0 ruby2.0-dev libapache2-mod-passenger 

<span class="co"># link static content</span>
<span class="fu">ln</span> -s <span class="va">${HOME}</span>/bety/public /var/www/html/bety

<span class="co"># setup a redirect</span>
<span class="fu">cat</span> <span class="op">&gt;</span> /etc/apache2/conf-available/bety.conf <span class="op">&lt;&lt; EOF</span>
RailsEnv production
RailsBaseURI /bety
PassengerRuby /usr/bin/ruby2.0
&lt;Directory /var/www/html/bety&gt;
  Options +FollowSymLinks
  Require all granted
&lt;/Directory&gt;
<span class="op">EOF</span>
<span class="ex">a2enconf</span> bety
<span class="ex">/etc/init.d/apache2</span> restart</code></pre>
</div>
<div id="rstudio-server" class="section level5">
<h5><span class="header-section-number">4.3.4.1.4</span> Rstudio-server</h5>
<p><em>NOTE This will allow anybody to login to the machine through the rstudio interface and run any arbitrary code. The login used however is the same as the system login/password.</em></p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">wget</span> http://download2.rstudio.org/rstudio-server-0.98.1103-amd64.deb</code></pre>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># bceome root</span>
<span class="fu">sudo</span> -s

<span class="co"># install required packages</span>
<span class="ex">apt-get</span> -y install libapparmor1 apparmor-utils libssl0.9.8

<span class="co"># install rstudio</span>
<span class="ex">dpkg</span> -i rstudio-server-*
<span class="fu">rm</span> rstudio-server-*
<span class="bu">echo</span> <span class="st">&quot;www-address=127.0.0.1&quot;</span> <span class="op">&gt;&gt;</span> /etc/rstudio/rserver.conf
<span class="bu">echo</span> <span class="st">&quot;r-libs-user=~/R/library&quot;</span> <span class="op">&gt;&gt;</span> /etc/rstudio/rsession.conf
<span class="ex">rstudio-server</span> restart

<span class="co"># setup rstudio forwarding in apache</span>
<span class="ex">a2enmod</span> proxy_http
<span class="fu">cat</span> <span class="op">&gt;</span> /etc/apache2/conf-available/rstudio.conf <span class="op">&lt;&lt; EOF</span>
ProxyPass        /rstudio/ http://localhost:8787/
ProxyPassReverse /rstudio/ http://localhost:8787/
RedirectMatch permanent ^/rstudio$ /rstudio/
<span class="op">EOF</span>
<span class="ex">a2enconf</span> rstudio
<span class="ex">/etc/init.d/apache2</span> restart

<span class="co"># all done, exit root</span>
<span class="bu">exit</span></code></pre>
</div>
<div id="additional-packages" class="section level5">
<h5><span class="header-section-number">4.3.4.1.5</span> Additional packages</h5>
<p>HDF5 Tools, netcdf, GDB and emacs</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> apt-get -y install hdf5-tools cdo nco netcdf-bin ncview gdb emacs ess nedit</code></pre>

</div>
</div>
<div id="centosredhat-centosredhat" class="section level4">
<h4><span class="header-section-number">4.3.4.2</span> CentOS/RedHat {#centos/redhat}</h4>
<p>These are specific notes for installing PEcAn on CentOS (7) and will be referenced from the main <a href="Installing-PEcAn">installing PEcAn</a> page. You will at least need to install the build environment and Postgres sections. If you want to access the database/PEcAn using a web browser you will need to install Apache. To access the database using the BETY interface, you will need to have Ruby installed.</p>
<p>This document also contains information on how to install the Rstudio server edition as well as any other packages that can be helpful.</p>
<div id="install-build-environment-1" class="section level5">
<h5><span class="header-section-number">4.3.4.2.1</span> Install build environment</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -s

<span class="co"># install packages needed for PEcAn</span>
<span class="ex">yum</span> -y groupinstall <span class="st">&#39;Development Tools&#39;</span> 
<span class="ex">yum</span> -y install git netcdf-fortran-openmpi-devel R bc curl libxml2-devel openssl-devel ed  udunits2 udunits2-devel netcdf netcdf-devel gmp-devel python-devel gdal-devel proj-devel proj-epsg expect

<span class="co"># jags</span>
<span class="ex">yum</span> -y install http://download.opensuse.org/repositories/home:/cornell_vrdc/CentOS_7/x86_64/jags3-3.4.0-54.1.x86_64.rpm
<span class="ex">yum</span> -y install http://download.opensuse.org/repositories/home:/cornell_vrdc/CentOS_7/x86_64/jags3-devel-3.4.0-54.1.x86_64.rpm

<span class="co"># fix include folder for udunits2</span>
<span class="fu">ln</span> -s /usr/include/udunits2/* /usr/include/

<span class="co"># install packages needed for ED2</span>
<span class="ex">yum</span> -y install environment-modules openmpi-bin libopenmpi-dev

<span class="co"># install requirements for DALEC</span>
<span class="ex">yum</span> -y install gsl-devel

<span class="co"># install packages for webserver</span>
<span class="ex">yum</span> -y install httpd php
<span class="ex">systemctl</span> enable httpd
<span class="ex">systemctl</span> start httpd
<span class="ex">firewall-cmd</span> --zone=public --add-port=80/tcp --permanent
<span class="ex">firewall-cmd</span> --reload

<span class="co"># install packages to compile docs</span>
<span class="co">#apt-get -y install texinfo texlive-latex-base texlive-latex-extra texlive-fonts-recommended</span>

<span class="co"># install devtools</span>
<span class="bu">echo</span> <span class="st">&#39;install.packages(&quot;devtools&quot;, repos=&quot;http://cran.rstudio.com/&quot;)&#39;</span> <span class="kw">|</span> <span class="ex">R</span> --vanilla

<span class="co"># done as root</span>
<span class="bu">exit</span>

<span class="bu">echo</span> <span class="st">&quot;module load mpi&quot;</span> <span class="op">&gt;&gt;</span> ~/.bashrc
<span class="ex">module</span> load mpi</code></pre>
<div id="install-and-configure-postgresql-udunits2-netcdf" class="section level6">
<h6><span class="header-section-number">4.3.4.2.1.1</span> Install and configure PostgreSQL, udunits2, NetCDF</h6>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -s

<span class="co"># point to latest PostgreSQL</span>
<span class="ex">yum</span> install -y epel-release 
<span class="ex">yum</span> -y install http://yum.postgresql.org/9.4/redhat/rhel-7-x86_64/pgdg-centos94-9.4-1.noarch.rpm

<span class="co"># install packages for postgresql (using a newer version than default)</span>
<span class="ex">yum</span> -y install postgresql94-server postgresql94-contrib postgis2_94 postgresql94-devel udunits2 netcdf

<span class="co"># install following if you want to run pecan through the web</span>
<span class="ex">yum</span> -y install php-pgsql

<span class="co"># enable bety user to login with trust by adding the following lines after</span>
<span class="co"># the ability of postgres user to login in /var/lib/pgsql/9.4/data/pg_hba.conf</span>
<span class="bu">local</span>   <span class="va">all</span>             <span class="va">bety</span>                                    <span class="va">trust</span>
<span class="ex">host</span>    all             bety            127.0.0.1/32            trust
<span class="ex">host</span>    all             bety            ::1/128                 trust

<span class="co"># Create database</span>
<span class="ex">/usr/pgsql-9.4/bin/postgresql94-setup</span> initdb

<span class="co"># Enable postgres</span>
<span class="ex">systemctl</span> enable postgresql-9.4
<span class="ex">systemctl</span> start postgresql-9.4

<span class="bu">exit</span></code></pre>
</div>
</div>
<div id="apache-configuration-pecan" class="section level5">
<h5><span class="header-section-number">4.3.4.2.2</span> Apache Configuration PEcAn</h5>
<p>Install and Start Apache</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">yum</span> -y install httpd
<span class="ex">systemctl</span> enable httpd
<span class="ex">systemctl</span> start httpd</code></pre>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># become root</span>
<span class="fu">sudo</span> -s

<span class="co"># get index page</span>
<span class="fu">rm</span> /var/www/html/index.html
<span class="fu">ln</span> -s /home/carya/pecan/documentation/index_vm.html /var/www/html/index.html

<span class="co"># fix selinux context (does this need to be done after PEcAn is installed?)</span>
<span class="ex">chcon</span> -R -t httpd_sys_content_t /home/carya/pecan /home/carya/output

<span class="co"># setup a redirect</span>
<span class="fu">cat</span> <span class="op">&gt;</span> /etc/httpd/conf.d/pecan.conf <span class="op">&lt;&lt; EOF</span>
Alias /pecan /home/carya/pecan/web
&lt;Directory /home/carya/pecan/web&gt;
  DirectoryIndex index.php
  Options +ExecCGI
  Require all granted
&lt;/Directory&gt;
<span class="op">EOF</span>
<span class="ex">a2enconf</span> pecan
<span class="ex">/etc/init.d/apache2</span> restart

<span class="co"># done as root</span>
<span class="bu">exit</span></code></pre>
</div>
<div id="apache-configuration-bety-1" class="section level5">
<h5><span class="header-section-number">4.3.4.2.3</span> Apache Configuration BETY</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -s

<span class="co"># install all ruby related packages</span>
<span class="fu">sudo</span> curl --fail -sSLo /etc/yum.repos.d/passenger.repo https://oss-binaries.phusionpassenger.com/yum/definitions/el-passenger.repo
<span class="ex">yum</span> -y install ruby ruby-devel mod_passenger

<span class="co"># link static content</span>
<span class="fu">ln</span> -s /home/carya/bety/public /var/www/html/bety

<span class="co"># fix GemFile</span>
<span class="bu">echo</span> <span class="st">&#39;gem &quot;test-unit&quot;&#39;</span> <span class="op">&gt;&gt;</span> bety/Gemlile

<span class="co"># fix selinux context (does this need to be done after bety is installed?)</span>
<span class="ex">chcon</span> -R -t httpd_sys_content_t /home/carya/bety

<span class="co"># setup a redirect</span>
<span class="fu">cat</span> <span class="op">&gt;</span> /etc/httpd/conf.d/bety.conf <span class="op">&lt;&lt; EOF</span>
RailsEnv production
RailsBaseURI /bety
PassengerRuby /usr/bin/ruby
&lt;Directory /var/www/html/bety&gt;
  Options +FollowSymLinks
  Require all granted
&lt;/Directory&gt;
<span class="op">EOF</span>
<span class="ex">systemctl</span> restart httpd</code></pre>
</div>
<div id="rstudio-server-1" class="section level5">
<h5><span class="header-section-number">4.3.4.2.4</span> Rstudio-server</h5>
<p>NEED FIXING</p>
<p><em>NOTE This will allow anybody to login to the machine through the rstudio interface and run any arbitrary code. The login used however is the same as the system login/password.</em></p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">wget</span> http://download2.rstudio.org/rstudio-server-0.98.1103-amd64.deb</code></pre>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># bceome root</span>
<span class="fu">sudo</span> -s

<span class="co"># install required packages</span>
<span class="ex">apt-get</span> -y install libapparmor1 apparmor-utils libssl0.9.8

<span class="co"># install rstudio</span>
<span class="ex">dpkg</span> -i rstudio-server-*
<span class="fu">rm</span> rstudio-server-*
<span class="bu">echo</span> <span class="st">&quot;www-address=127.0.0.1&quot;</span> <span class="op">&gt;&gt;</span> /etc/rstudio/rserver.conf
<span class="bu">echo</span> <span class="st">&quot;r-libs-user=~/R/library&quot;</span> <span class="op">&gt;&gt;</span> /etc/rstudio/rsession.conf
<span class="ex">rstudio-server</span> restart

<span class="co"># setup rstudio forwarding in apache</span>
<span class="ex">a2enmod</span> proxy_http
<span class="fu">cat</span> <span class="op">&gt;</span> /etc/apache2/conf-available/rstudio.conf <span class="op">&lt;&lt; EOF</span>
ProxyPass        /rstudio/ http://localhost:8787/
ProxyPassReverse /rstudio/ http://localhost:8787/
RedirectMatch permanent ^/rstudio$ /rstudio/
<span class="op">EOF</span>
<span class="ex">a2enconf</span> rstudio
<span class="ex">/etc/init.d/apache2</span> restart

<span class="co"># all done, exit root</span>
<span class="bu">exit</span></code></pre>
<p><em>Alternative Rstudio instructions</em></p>
</div>
<div id="install-and-configure-rstudio-server" class="section level5">
<h5><span class="header-section-number">4.3.4.2.5</span> Install and configure Rstudio-server</h5>
<p>Install RStudio Server by following the <a href="https://www.rstudio.com/products/rstudio/download-server/">official documentation</a> for your platform.
Then, proceed with the following:</p>
<ul>
<li>add <code>PATH=$PATH:/usr/sbin:/sbin</code> to <code>/etc/profile</code></li>
</ul>
<pre class="sourceCode bash"><code class="sourceCode bash">   <span class="fu">cat</span> <span class="st">&quot;PATH=</span><span class="va">$PATH</span><span class="st">:/usr/sbin:/sbin; export PATH&quot;</span> <span class="op">&gt;&gt;</span> /etc/profile</code></pre>
<ul>
<li>add <a href="https://gist.github.com/dlebauer/6921889">rstudio.conf</a> to /etc/httpd/conf.d/</li>
</ul>
<pre class="sourceCode bash"><code class="sourceCode bash">   <span class="fu">wget</span> https://gist.github.com/dlebauer/6921889/raw/d1e0f945228e5519afa6223d6f49d6e0617262bd/rstudio.conf
   <span class="fu">sudo</span> mv rstudio.conf /httpd/conf.d/</code></pre>
<ul>
<li>restart the Apache server: <code>sudo httpd restart</code></li>
<li>now you should be able to access <code>http://&lt;server&gt;/rstudio</code></li>
</ul>
<div id="install-ruby-netcdf-gem" class="section level6">
<h6><span class="header-section-number">4.3.4.2.5.1</span> Install ruby-netcdf gem</h6>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> <span class="va">$RUBY_APPLICATION_HOME</span>
<span class="bu">export</span> <span class="va">$NETCDF_URL=</span>http://www.gfd-dennou.org/arch/ruby/products/ruby-netcdf/release/ruby-netcdf-0.6.6.tar.gz
<span class="bu">export</span> <span class="va">$NETCDF_DIR=</span>/usr/local/netcdf
<span class="ex">gem</span> install narray
<span class="bu">export</span> <span class="va">NARRAY_DIR=</span><span class="st">&quot;</span><span class="va">$(</span><span class="fu">ls</span> <span class="va">$GEM_HOME</span>/gems <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&#39;narray-&#39;</span><span class="va">)</span><span class="st">&quot;</span>
<span class="bu">export</span> <span class="va">NARRAY_PATH=</span><span class="st">&quot;</span><span class="va">$GEM_HOME</span><span class="st">/gems/</span><span class="va">$NARRAY_DIR</span><span class="st">&quot;</span>
<span class="bu">cd</span> <span class="va">$MY_RUBY_HOME</span>/bin
<span class="fu">wget</span> <span class="va">$NETCDF_URL</span> -O ruby-netcdf.tgz
<span class="fu">tar</span> zxf ruby-netcdf.tgz <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> ruby-netcdf-0.6.6/
<span class="ex">ruby</span> -rubygems extconf.rb --with-narray-include=<span class="va">$NARRAY_PATH</span> --with-netcdf-dir=/usr/local/netcdf-4.3.0
<span class="fu">sed</span> -i <span class="st">&#39;s|rb/$|rb|&#39;</span> Makefile
<span class="fu">make</span>
<span class="fu">make</span> install
<span class="bu">cd</span> ../ <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> rm -rf ruby-netcdf*

<span class="bu">cd</span> <span class="va">$RUBY_APPLICATION</span>
<span class="ex">bundle</span> install --without development</code></pre>
</div>
</div>
<div id="additional-packages-1" class="section level5">
<h5><span class="header-section-number">4.3.4.2.6</span> Additional packages</h5>
<p>NEED FIXING</p>
<p>HDF5 Tools, netcdf, GDB and emacs</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> apt-get -y install hdf5-tools cdo nco netcdf-bin ncview gdb emacs ess nedit</code></pre>

</div>
</div>
<div id="macosx" class="section level4">
<h4><span class="header-section-number">4.3.4.3</span> Mac OSX</h4>
<p>These are specific notes for installing PEcAn on Mac OSX and will be referenced from the main <a href="Installing-PEcAn">installing PEcAn</a> page. You will at least need to install the build environment and Postgres sections. If you want to access the database/PEcAn using a web browser you will need to install Apache. To access the database using the BETY interface, you will need to have Ruby installed.</p>
<p>This document also contains information on how to install the Rstudio server edition as well as any other packages that can be helpful.</p>
<div id="install-build-environment-2" class="section level5">
<h5><span class="header-section-number">4.3.4.3.1</span> Install build environment</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># install R</span>
<span class="co"># download from http://cran.r-project.org/bin/macosx/</span>

<span class="co"># install gfortran </span>
<span class="co"># download from http://cran.r-project.org/bin/macosx/tools/</span>

<span class="co"># install OpenMPI</span>
<span class="ex">curl</span> -o openmpi-1.6.3.tar.gz http://www.open-mpi.org/software/ompi/v1.6/downloads/openmpi-1.6.3.tar.gz
<span class="fu">tar</span> zxf openmpi-1.6.3.tar.gz
<span class="bu">cd</span> openmpi-1.6.3
<span class="ex">./configure</span> --prefix=/usr/local
<span class="fu">make</span> all
<span class="fu">sudo</span> make install
<span class="bu">cd</span> ..

<span class="co"># install szip</span>
<span class="ex">curl</span> -o szip-2.1-MacOSX-intel.tar.gz ftp://ftp.hdfgroup.org/lib-external/szip/2.1/bin/szip-2.1-MacOSX-intel.tar.gz
<span class="fu">tar</span> zxf szip-2.1-MacOSX-intel.tar.gz
<span class="fu">sudo</span> mv szip-2.1-MacOSX-intel /usr/local/szip

<span class="co"># install HDF5</span>

<span class="ex">curl</span> -o hdf5-1.8.11.tar.gz http://www.hdfgroup.org/ftp/HDF5/current/src/hdf5-1.8.11.tar.gz
<span class="fu">tar</span> zxf hdf5-1.8.11.tar.gz
<span class="bu">cd</span> hdf5-1.8.11
<span class="fu">sed</span> -i -e <span class="st">&#39;s/-O3/-O0/g&#39;</span> config/gnu-flags 
<span class="ex">./configure</span> --prefix=/usr/local/hdf5 --enable-fortran --enable-cxx --with-szlib=/usr/local/szip
<span class="fu">make</span>
<span class="co"># make check</span>
<span class="fu">sudo</span> make install
<span class="co"># sudo make check-install</span>
<span class="bu">cd</span> ..</code></pre>
</div>
<div id="install-postgres-1" class="section level5">
<h5><span class="header-section-number">4.3.4.3.2</span> Install Postgres</h5>
<p>For those on a Mac I use the following app for postgresql which has
postgis already installed (<a href="http://postgresapp.com/" class="uri">http://postgresapp.com/</a>)</p>
<p>To get postgis run the following commands in psql:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">##### Enable PostGIS (includes raster)</span>
<span class="ex">CREATE</span> EXTENSION postgis<span class="kw">;</span>
<span class="co">##### Enable Topology</span>
<span class="ex">CREATE</span> EXTENSION postgis_topology<span class="kw">;</span>
<span class="co">##### fuzzy matching needed for Tiger</span>
<span class="ex">CREATE</span> EXTENSION fuzzystrmatch<span class="kw">;</span>
<span class="co">##### Enable US Tiger Geocoder</span>
<span class="ex">CREATE</span> EXTENSION postgis_tiger_geocoder<span class="kw">;</span></code></pre>
<p>To check your postgis run the following command again in psql: <code>SELECT PostGIS_full_version();</code></p>
</div>
<div id="additional-installs" class="section level5">
<h5><span class="header-section-number">4.3.4.3.3</span> Additional installs</h5>
<div id="install-jags" class="section level6">
<h6><span class="header-section-number">4.3.4.3.3.1</span> Install JAGS</h6>
<p>Download JAGS from <a href="http://sourceforge.net/projects/mcmc-jags/files/JAGS/3.x/Mac%20OS%20X/JAGS-Mavericks-3.4.0.dmg/download">http://sourceforge.net/projects/mcmc-jags/files/JAGS/3.x/Mac%20OS%20X/JAGS-Mavericks-3.4.0.dmg/download</a></p>
</div>
<div id="install-udunits" class="section level6">
<h6><span class="header-section-number">4.3.4.3.3.2</span> Install udunits</h6>
<p>Installing udunits-2 on MacOSX is done from source.</p>
<ul>
<li>download most recent <a href="http://www.unidata.ucar.edu/downloads/udunits/index.jsp">version of Udunits here</a></li>
<li>instructions for <a href="http://www.unidata.ucar.edu/software/udunits/udunits-2/udunits2.html#Obtain">compiling from source</a></li>
</ul>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">curl</span> -o udunits-2.1.24.tar.gz ftp://ftp.unidata.ucar.edu/pub/udunits/udunits-2.1.24.tar.gz
<span class="fu">tar</span> zxf udunits-2.1.24.tar.gz
<span class="bu">cd</span> udunits-2.1.24
<span class="ex">./configure</span>
<span class="fu">make</span>
<span class="fu">sudo</span> make install</code></pre>
</div>
</div>
<div id="apache-configuration" class="section level5">
<h5><span class="header-section-number">4.3.4.3.4</span> Apache Configuration</h5>
<p>Mac does not support pdo/postgresql by default. The easiest way to install is use: <a href="http://php-osx.liip.ch/" class="uri">http://php-osx.liip.ch/</a></p>
<p>To enable pecan to run from your webserver.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">cat</span> <span class="op">&gt;</span> /etc/apache2/others/pecan.conf <span class="op">&lt;&lt; EOF</span>
Alias /pecan <span class="va">${PWD}</span>/pecan/web
&lt;Directory <span class="va">${PWD}</span>/pecan/web&gt;
  DirectoryIndex index.php
  Options +All
  Require all granted
&lt;/Directory&gt;
<span class="op">EOF</span></code></pre>
</div>
<div id="ruby" class="section level5">
<h5><span class="header-section-number">4.3.4.3.5</span> Ruby</h5>
<p>The default version of ruby should work. Or use <a href="https://jewelrybox.unfiniti.com/">JewelryBox</a>.</p>
</div>
<div id="rstudio-server-2" class="section level5">
<h5><span class="header-section-number">4.3.4.3.6</span> Rstudio Server</h5>
<p>For the mac you can download <a href="http://www.rstudio.com/">Rstudio Desktop</a>.</p>

</div>
</div>
<div id="install-bety" class="section level4">
<h4><span class="header-section-number">4.3.4.4</span> Installing BETY</h4>
<p>**************THIS PAGE IS DEPRECATED*************</p>
<p>Official Instructions for BETY are maintained here: <a href="https://pecan.gitbook.io/betydb-documentation" class="uri">https://pecan.gitbook.io/betydb-documentation</a></p>
<p>If you would like to install the Docker Version of BETY, please consult the <a href="pecan-manual-setup.html#pecan-docker">PEcAn Docker</a> section.</p>
</div>
<div id="install-database-data" class="section level4">
<h4><span class="header-section-number">4.3.4.5</span> Install Database + Data</h4>
<ul>
<li><em>note</em> To install BETYdb without PEcAn, first download the <a href="https://raw.githubusercontent.com/PecanProject/pecan/master/scripts/load.bety.sh"><code>load.bety.sh</code> script</a></li>
</ul>
<pre class="sourceCode sh"><code class="sourceCode bash"><span class="co"># install database (code assumes password is bety)</span>
<span class="fu">sudo</span> -u postgres createuser -d -l -P -R -S bety
<span class="fu">sudo</span> -u postgres createdb -O bety bety
<span class="fu">sudo</span> -u postgres ./scripts/load.bety.sh -c YES -u YES -r 0
<span class="fu">sudo</span> -u postgres ./scripts/load.bety.sh -r 1
<span class="fu">sudo</span> -u postgres ./scripts/load.bety.sh -r 2

<span class="co"># configure for PEcAn web app (change password if needed)</span>
<span class="fu">cp</span> web/config.example.php web/config.php 

<span class="co"># add models to database (VM only)</span>
<span class="ex">./scripts/add.models.sh</span>

<span class="co"># add data to database</span>
<span class="ex">./scripts/add.data.sh</span>

<span class="co"># create outputs folder</span>
<span class="fu">mkdir</span> ~/output
<span class="fu">chmod</span> 777 ~/output</code></pre>
</div>
<div id="installing-betydb-web-application" class="section level4">
<h4><span class="header-section-number">4.3.4.6</span> Installing BETYdb Web Application</h4>
<p>There are two flavors of BETY, PHP and RUBY. The PHP version allows for a minimal interaction with the database while the RUBY version allows for full interaction with the database.</p>
<div id="php-version" class="section level5">
<h5><span class="header-section-number">4.3.4.6.1</span> PHP version</h5>
<p>The php version comes with PEcAn and is already configured.</p>
</div>
<div id="ruby-version" class="section level5">
<h5><span class="header-section-number">4.3.4.6.2</span> RUBY version</h5>
<p>The RUBY version requires a few extra packages to be installed first.</p>
<p>Next we install the web app.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># install bety</span>
<span class="bu">cd</span>
<span class="fu">git</span> clone https://github.com/PecanProject/bety.git

<span class="co"># install gems</span>
<span class="bu">cd</span> bety
<span class="fu">sudo</span> gem2.0 install bundler
<span class="ex">bundle</span> install --without development:test:javascript_testing:debug</code></pre>
<p>and configure BETY</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># create folders for upload folders</span>
<span class="fu">mkdir</span> paperclip/files paperclip/file_names
<span class="fu">chmod</span> 777 paperclip/files paperclip/file_names

<span class="co"># create folder for log files</span>
<span class="fu">mkdir</span> log
<span class="fu">touch</span> log/production.log
<span class="fu">chmod</span> 0666 log/production.log

<span class="co"># fix configuration for vm</span>
<span class="fu">cp</span> config/additional_environment_vm.rb config/additional_environment.rb
<span class="fu">chmod</span> go+w public/javascripts/cache/

<span class="co"># setup bety database configuration</span>
<span class="fu">cat</span> <span class="op">&gt;</span> config/database.yml <span class="op">&lt;&lt; EOF</span>
production:
  adapter: postgis
  encoding: utf-8
  reconnect: false
  database: bety
  pool: 5
  username: bety
  password: bety
<span class="op">EOF</span>

<span class="co"># setup login tokens</span>
<span class="fu">cat</span> <span class="op">&gt;</span> config/initializers/site_keys.rb <span class="op">&lt;&lt; EOF</span>
REST_AUTH_SITE_KEY         = &#39;thisisnotasecret&#39;
REST_AUTH_DIGEST_STRETCHES = 10
<span class="op">EOF</span></code></pre>

</div>
</div>
<div id="install-models" class="section level4">
<h4><span class="header-section-number">4.3.4.7</span> Install Models</h4>
<p>This page contains instructions on how to download and install ecosystem models that have been or are being coupled to PEcAn.
These instructions have been tested on the PEcAn unbuntu VM. Commands may vary on other operating systems.
Also, some model downloads require permissions before downloading, making them unavailable to the general public. Please contact the PEcAn team if you would like access to a model that is not already installed on the default PEcAn VM.</p>
<ul>
<li><a href="pecan-manual-setup.html#inst-biocro">BioCro</a></li>
<li><a href="pecan-manual-setup.html#inst-clm45">CLM 4.5</a></li>
<li><a href="pecan-manual-setup.html#inst-dalec">DALEC</a></li>
<li><a href="pecan-manual-setup.html#inst-ed2">ED2</a></li>
<li><a href="pecan-manual-setup.html#inst-fates">FATES</a></li>
<li><a href="pecan-manual-setup.html#inst-gday">GDAY</a></li>
<li><a href="pecan-manual-setup.html#inst-jules">JULES</a></li>
<li><a href="pecan-manual-setup.html#inst-linkages">LINKAGES</a></li>
<li><a href="pecan-manual-setup.html#inst-lpj-guess">LPJ-GUESS</a></li>
<li><a href="pecan-manual-setup.html#inst-maespa">MAESPA</a></li>
<li><a href="#inst-sipnet">SIPNET</a></li>
</ul>

</div>
<div id="inst-biocro" class="section level4">
<h4><span class="header-section-number">4.3.4.8</span> BioCro</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Public</span>
echo <span class="st">&#39;devtools::install_github(&quot;ebimodeling/biocro&quot;)&#39;</span> <span class="op">|</span><span class="st"> </span>R <span class="op">--</span>vanilla
<span class="co"># Development:</span>
echo <span class="st">&#39;devtools::install_github(&quot;ebimodeling/biocro-dev&quot;)&#39;</span> <span class="op">|</span><span class="st"> </span>R <span class="op">--</span>vanilla</code></pre>
<p><em>BioCro Developers:</em> request from <span class="citation">[@dlebauer on GitHub]</span>(<a href="https://github.com/dlebauer" class="uri">https://github.com/dlebauer</a>)</p>

</div>
<div id="inst-clm45" class="section level4">
<h4><span class="header-section-number">4.3.4.9</span> CLM 4.5</h4>
<p>The version of CLM installed on PEcAn is the ORNL branch provided by Dan Ricciuto. This version includes Dan’s point-level CLM processing scripts</p>
<p>Download the code (~300M compressed), input data (1.7GB compressed and expands to 14 GB), and a few misc inputs.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">mkdir</span> models
<span class="bu">cd</span> models
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/clm4_5_1_r085.tar.gz
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/clm/ccsm_inputdata.tar.gz
<span class="fu">tar</span> -xvzf clm4_5*
<span class="fu">tar</span> -xvzf ccsm_inputdata.tar.gz

<span class="co">#Parameter file:</span>
<span class="fu">mkdir</span> /home/carya/models/ccsm_inputdata/lnd/clm2/paramdata
<span class="bu">cd</span>  /home/carya/models/ccsm_inputdata/lnd/clm2/paramdata
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/clm_params.c130821.nc
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/clm_params.c140423.nc

<span class="co">#Domain file:</span>
<span class="bu">cd</span> /home/carya/models/ccsm_inputdata/share/domains/domain.clm/
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/domain.lnd.1x1pt_US-UMB_navy.nc

<span class="co">#Aggregated met data file:</span>
<span class="bu">cd</span> /home/carya/models/ccsm_inputdata/atm/datm7/CLM1PT_data/1x1pt_US-UMB
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/all_hourly.nc 

<span class="co">## lightning database</span>
<span class="bu">cd</span> /home/carya/models/ccsm_inputdata/atm/datm7/NASA_LIS/
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/clmforc.Li_2012_climo1995-2011.T62.lnfm_Total_c140423.nc

<span class="co">## surface data</span>
<span class="bu">cd</span> /home/carya/models/ccsm_inputdata/lnd/clm2/surfdata
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/clm/surfdata_360x720cru_simyr1850_c130927.nc
<span class="bu">cd</span> /home/carya/models/ccsm_inputdata/lnd/clm2/surfdata_map
<span class="fu">wget</span> ftp://nacp.ornl.gov/synthesis/2008/firenze/site/clm/surfdata_1x1pt_US-UMB_I1850CLM45CN_simyr1850.nc_new
<span class="fu">mv</span> surfdata_1x1pt_US-UMB_I1850CLM45CN_simyr1850.nc_new surfdata_1x1pt_US-UMB_I1850CLM45CN_simyr1850.nc</code></pre>
<p>Required libraries</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> apt-get install mercurial csh tcsh subversion cmake

<span class="fu">sudo</span> ln -s /usr/bin/make /usr/bin/gmake</code></pre>
<p>Compile and build default inputs</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> ~/carya/models/clm4_5_1_r085/scripts
<span class="ex">python</span> runCLM.py --site US-UMB ––compset I1850CLM45CN --mach ubuntu --ccsm_input /home/carya/models/ccsm_inputdata --tstep 1 --nopointdata --coldstart --cpl_bypass --clean_build</code></pre>
<div id="clm-test-run" class="section level5">
<h5><span class="header-section-number">4.3.4.9.1</span> CLM Test Run</h5>
<p>You will see a new directory in scripts: US-UMB_I1850CLM45CN
Enter this directory and run (you shouldn’t have to do this normally, but there is a bug with the python script and doing this ensures all files get to the right place):</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">./US-UMB_I1850CLM45CN.build</span></code></pre>
<p>Next you are ready to go to the run directory:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">/home/carya/models/clm4_5_1_r085/run/US-UMB_I1850CLM45CN/run</span></code></pre>
<p>Open to edit file: datm.streams.txt.CLM1PT.CLM_USRDAT and check file paths such that all paths start with /home/carya/models/ccsm_inputdata</p>
<p>From this directory, launch the executable that resides in the bld directory:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">/home/carya/clm4_5_1_r085/run/US-UMB_I1850CLM45CN/bld/cesm.exe</span></code></pre>
<p>not sure this was the right location, but wherever the executable is</p>
<p>You should begin to see output files that look like this:
US-UMB_I1850CLM45CN.clm2.h0.yyyy-mm.nc (yyyy is year, mm is month)
These are netcdf files containing monthly averages of lots of variables.</p>
<p>The lnd_in file in the run directory can be modified to change the output file frequency and variables.</p>

</div>
</div>
<div id="inst-dalec" class="section level4">
<h4><span class="header-section-number">4.3.4.10</span> DALEC</h4>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span>
<span class="ex">curl</span> -o dalec_EnKF_pub.tgz http://isda.ncsa.illinois.edu/~kooper/EBI/dalec_EnKF_pub.tgz
<span class="fu">tar</span> zxf dalec_EnKF_pub.tgz
<span class="fu">rm</span> dalec_EnKF_pub.tgz

<span class="bu">cd</span> dalec_EnKF_pub
<span class="fu">make</span> dalec_EnKF
<span class="fu">make</span> dalec_seqMH
<span class="fu">sudo</span> cp dalec_EnKF dalec_seqMH /usr/local/bin</code></pre>

</div>
<div id="inst-ed2" class="section level4">
<h4><span class="header-section-number">4.3.4.11</span> ED2</h4>
<div id="ed2.2-r46-used-in-pecan-manuscript" class="section level5">
<h5><span class="header-section-number">4.3.4.11.1</span> ED2.2 r46 (used in PEcAn manuscript)</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># Get version r46 with a few patches for ubuntu</span>
<span class="bu">cd</span>
<span class="ex">curl</span> -o ED.r46.tgz http://isda.ncsa.illinois.edu/~kooper/EBI/ED.r46.tgz
<span class="fu">tar</span> zxf ED.r46.tgz
<span class="fu">rm</span> ED.r46.tgz
<span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># configure and compile ed</span>
<span class="bu">cd</span> ~/ED.r46/ED/build/bin
<span class="ex">curl</span> -o include.mk.VM http://isda.ncsa.illinois.edu/~kooper/EBI/include.mk.opt.<span class="kw">`</span><span class="fu">uname</span> -s<span class="kw">`</span>
<span class="fu">make</span> OPT=VM
<span class="fu">sudo</span> cp ../ed_2.1-VM /usr/local/bin/ed2.r46</code></pre>
<p>Perform a test run using pre configured ED settings for ED2.2 r46</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># Create sample run</span>
<span class="bu">cd</span>
<span class="fu">mkdir</span> testrun.ed.r46
<span class="bu">cd</span> testrun.ed.r46
<span class="ex">curl</span> -o ED2IN http://isda.ncsa.illinois.edu/~kooper/EBI/ED2IN.r46
<span class="fu">sed</span> -i -e <span class="st">&quot;s#</span><span class="dt">\$</span><span class="st">HOME#</span><span class="va">$HOME</span><span class="st">#&quot;</span> ED2IN
<span class="ex">curl</span> -o config.xml  http://isda.ncsa.illinois.edu/~kooper/EBI/config.r46.xml
<span class="co"># execute test run</span>
<span class="bu">time</span> ed2.r46</code></pre>
</div>
<div id="ed-2.2-r82" class="section level5">
<h5><span class="header-section-number">4.3.4.11.2</span> ED 2.2 r82</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span>
<span class="ex">curl</span> -o ED.r82.tgz http://isda.ncsa.illinois.edu/~kooper/EBI/ED.r82.tgz
<span class="fu">tar</span> zxf ED.r82.tgz
<span class="fu">rm</span> ED.r82.tgz

<span class="bu">cd</span> ED.r82
<span class="ex">curl</span> -o ED.r82.patch http://isda.ncsa.illinois.edu/~kooper/EBI/ED.r82.patch
<span class="fu">patch</span> -p1 <span class="op">&lt;</span> ED.r82.patch
<span class="bu">cd</span> ED/build/bin
<span class="ex">curl</span> -o include.mk.VM http://isda.ncsa.illinois.edu/~kooper/EBI/include.mk.opt.<span class="kw">`</span><span class="fu">uname</span> -s<span class="kw">`</span>
<span class="fu">make</span> OPT=VM
<span class="fu">sudo</span> cp ../ed_2.1-VM /usr/local/bin/ed2.r82</code></pre>
<p>Perform a test run using pre configured ED settings for ED2.2 r82</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span>
<span class="fu">mkdir</span> testrun.ed.r82
<span class="bu">cd</span> testrun.ed.r82
<span class="ex">curl</span> -o ED2IN http://isda.ncsa.illinois.edu/~kooper/EBI/ED2IN.r82
<span class="fu">sed</span> -i -e <span class="st">&quot;s#</span><span class="dt">\$</span><span class="st">HOME#</span><span class="va">$HOME</span><span class="st">#&quot;</span> ED2IN
<span class="ex">curl</span> -o config.xml  http://isda.ncsa.illinois.edu/~kooper/EBI/config.r82.xml
<span class="co"># execute test run</span>
<span class="bu">time</span> ed2.r82</code></pre>
</div>
<div id="ed-2.2-bleeding-edge" class="section level5">
<h5><span class="header-section-number">4.3.4.11.3</span> ED 2.2 bleeding edge</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span>
<span class="fu">git</span> clone https://github.com/EDmodel/ED2.git

<span class="bu">cd</span> ED2/ED/build/bin
<span class="ex">curl</span> -o include.mk.VM http://isda.ncsa.illinois.edu/~kooper/EBI/include.mk.opt.<span class="kw">`</span><span class="fu">uname</span> -s<span class="kw">`</span>
<span class="ex">./generate_deps.sh</span>
<span class="fu">make</span> OPT=VM
<span class="fu">sudo</span> cp ../ed_2.1-VM /usr/local/bin/ed2.git</code></pre>

</div>
</div>
<div id="inst-fates" class="section level4">
<h4><span class="header-section-number">4.3.4.12</span> CLM-FATES</h4>
<p>Prerequisites</p>
<pre><code>sudo apt-get upgrade libnetcdf-dev
sudo apt-get install subversion
sudo apt-get install csh
sudo apt-get install cmake
sudo ln -s /usr/bin/make /usr/bin/gmake
sudo rm /bin/sh
sudo ln -s /bin/bash /bin/sh

wget https://github.com/Unidata/netcdf-fortran/archive/v4.4.4.tar.gz
cd netcdf-4.4.4
./configure
make
sudo make install</code></pre>
<p>you might need to mess around with installing netcdf and netcdf-fortran to get a version FATES likes…</p>
<p>Get code from Github (currently private) and go to cime/scripts directory</p>
<pre><code>git clone git@github.com:NGEET/ed-clm.git
cd ed-clm/cime/scripts/</code></pre>
<p>Within CLM-FATES, to be able to build an executable we need to create a reference run. We’ll also use this reference run to grab defaults from, so we’ll be registering the location of both the reference <strong>case</strong> (location of executable, scripts, etc) and the reference <strong>inputs</strong> with the PEcAn database. To begin, copy reference run script from pecan</p>
<pre><code>cp ~/pecan/models/fates/inst/create_1x1_ref_case.sh .</code></pre>
<p>Edit reference case script to set NETCDF_HOME, CROOT (reference run case), DIN_LOC_ROOT (reference run inputs). Also, make sure DIN_LOC_ROOT exists as FATES will not create it itself. Then run the script</p>
<pre><code>./create_1x1_ref_case.sh</code></pre>
<p>Be aware that this script WILL ask you for your password on the NCAR server to download the reference case input data (the guest password may work, haven’t tried this). If it gives an error at the pio stage check the log, but the most likely error is it being unable to find a version of netcdf it likes.</p>
<p>Once FATES is installed, set the whole reference case directory as the Model path (leave filename blank) and set the whole inputs directory as an Input with format clm_defaults.</p>

</div>
<div id="inst-gday" class="section level4">
<h4><span class="header-section-number">4.3.4.13</span> GDAY</h4>
<p>Navigate to a directory you would like to store GDAY and run the following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">git</span> clone https://github.com/mdekauwe/GDAY.git

<span class="bu">cd</span> GDAY

<span class="bu">cd</span> src

<span class="fu">make</span></code></pre>
<p><code>gday</code> is your executable.</p>

</div>
<div id="inst-jules" class="section level4">
<h4><span class="header-section-number">4.3.4.14</span> JULES</h4>
<p>INSTALL STEPS:
1) Download JULES and FCM
JULES:
Model requires registration to download. Not to be put on PEcAn VM
Getting Started documentation: <a href="https://jules.jchmr.org/content/getting-started" class="uri">https://jules.jchmr.org/content/getting-started</a>
Registration: <a href="http://jules-lsm.github.io/access_req/JULES_access.html" class="uri">http://jules-lsm.github.io/access_req/JULES_access.html</a></p>
<p>FCM:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">    <span class="ex">https</span>://github.com/metomi/fcm/
    <span class="fu">wget</span> https://github.com/metomi/fcm/archive/2015.05.0.tar.gz</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>edit makefile</li>
</ol>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">open</span> etc/fcm-make/make.cfg

<span class="kw">set</span> <span class="ex">JULES_NETCDF</span> = actual instead of dummy
<span class="kw">set</span> <span class="ex">path</span> (e.g. /usr/) <span class="ex">and</span> lib_path /lib64 to netCDF libraries</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>compile JULES</li>
</ol>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> etc/fcm-make/
<span class="dt">{path.to.fcm}</span><span class="ex">/fcm</span> make -f etc/fcm-make/make.cfg --new</code></pre>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">UBUNTU</span> VERSION: installed without having to add any perl libraries
<span class="co">#perl stuff that I had to install on pecan2 not PEcAN VM</span>
<span class="fu">sudo</span> yum install perl-Digest-SHA
<span class="fu">sudo</span> yum install perl-Time-modules
<span class="fu">sudo</span> yum install cpan
<span class="ex">curl</span> -L http://cpanmin.us <span class="kw">|</span> <span class="fu">perl</span> - --sudo App::cpanminus
<span class="fu">sudo</span> cpanm Time/Piece.pm
<span class="fu">sudo</span> cpanm IO/Uncompress/Gunzip.pm</code></pre>
<p>Executable is under build/bin/jules.exe</p>
<p>Example rundir: examples/point_loobos</p>

</div>
<div id="inst-linkages" class="section level4">
<h4><span class="header-section-number">4.3.4.15</span> LINKAGES</h4>
<div id="r-installation" class="section level5">
<h5><span class="header-section-number">4.3.4.15.1</span> R Installation</h5>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Public</span>
echo <span class="st">&#39;devtools::install_github(&quot;araiho/linkages_package&quot;)&#39;</span> <span class="op">|</span><span class="st"> </span>R <span class="op">--</span>vanilla</code></pre>
</div>
<div id="fortran-version" class="section level5">
<h5><span class="header-section-number">4.3.4.15.2</span> FORTRAN VERSION</h5>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#FORTRAN VERSION</span>
cd
git clone https<span class="op">:</span><span class="er">//</span>github.com<span class="op">/</span>araiho<span class="op">/</span>Linkages.git
cd Linkages
gfortran <span class="op">-</span>o linkages linkages.f
sudo cp linkages <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>bin<span class="op">/</span>linkages.git</code></pre>

</div>
</div>
<div id="inst-lpj-guess" class="section level4">
<h4><span class="header-section-number">4.3.4.16</span> LPJ-GUESS</h4>
<p>Instructions to download source code</p>
<p>Go to <a href="http://web.nateko.lu.se/lpj-guess/download.html">LPJ-GUESS website</a> for instructions to access code.</p>

</div>
<div id="inst-maespa" class="section level4">
<h4><span class="header-section-number">4.3.4.17</span> MAESPA</h4>
<p>Navigate to a directory you would like store MAESPA and run the following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">git</span> clone https://bitbucket.org/remkoduursma/maespa.git

<span class="bu">cd</span> maespa

<span class="fu">make</span></code></pre>
<p><code>maespa.out</code> is your executable. Example input files can be found in the <code>inpufiles</code> directory. Executing measpa.out from within one of the example directories will produce output.</p>
<p>MAESPA developers have also developed a wrapper package called Maeswrap. The usual R package installation method <code>install.packages</code> may present issues with downloading an unpacking a dependency package called <code>rgl</code>. Here are a couple of solutions:</p>
<div id="solution-1" class="section level5">
<h5><span class="header-section-number">4.3.4.17.1</span> Solution 1</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">### From the Command Line</span>
<span class="fu">sudo</span> apt-get install r-cran-rgl</code></pre>
<p>then from within R</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;Maeswrap&quot;</span>)</code></pre>
</div>
<div id="solution-2" class="section level5">
<h5><span class="header-section-number">4.3.4.17.2</span> Solution 2</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">### From the Command line </span>
<span class="fu">sudo</span> apt-get install libglu1-mesa-dev</code></pre>
<p>then from within R</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;Maeswrap&quot;</span>)</code></pre>

</div>
</div>
<div id="sipnet-inst-sipnet" class="section level4">
<h4><span class="header-section-number">4.3.4.18</span> SIPNET {inst-sipnet}</h4>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span>
<span class="ex">curl</span> -o sipnet_unk.tar.gz http://isda.ncsa.illinois.edu/~kooper/EBI/sipnet_unk.tar.gz
<span class="fu">tar</span> zxf sipnet_unk.tar.gz
<span class="fu">rm</span> sipnet_unk.tar.gz

<span class="bu">cd</span> sipnet_unk
<span class="fu">make</span>
<span class="fu">sudo</span> cp sipnet /usr/local/bin/sipnet.runk</code></pre>
<div id="sipnet-testrun" class="section level5">
<h5><span class="header-section-number">4.3.4.18.1</span> SIPNET testrun</h5>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span>
<span class="ex">curl</span> -o testrun.sipnet.tar.gz http://isda.ncsa.illinois.edu/~kooper/EBI/testrun.sipnet.tar.gz
<span class="fu">tar</span> zxf testrun.sipnet.tar.gz
<span class="fu">rm</span> testrun.sipnet.tar.gz
<span class="bu">cd</span> testrun.sipnet
<span class="ex">sipnet.runk</span></code></pre>

</div>
</div>
<div id="install-data" class="section level4">
<h4><span class="header-section-number">4.3.4.19</span> Installing data for PEcAn</h4>
<p>PEcAn assumes some of the data to be installed on the machine. This page will describe how to install this data.</p>
<div id="site-information" class="section level5">
<h5><span class="header-section-number">4.3.4.19.1</span> Site Information</h5>
<p>These are large-ish files that contain data used with ED2 and SIPNET</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">rm</span> -rf sites
<span class="ex">curl</span> -o sites.tgz http://isda.ncsa.illinois.edu/~kooper/EBI/sites.tgz
<span class="fu">tar</span> zxf sites.tgz
<span class="fu">sed</span> -i -e <span class="st">&quot;s#/home/kooper/Projects/EBI#</span><span class="va">${PWD}</span><span class="st">#&quot;</span> sites/*/ED_MET_DRIVER_HEADER
<span class="fu">rm</span> sites.tgz

<span class="fu">rm</span> -rf inputs
<span class="ex">curl</span> -o inputs.tgz http://isda.ncsa.illinois.edu/~kooper/EBI/inputs.tgz
<span class="fu">tar</span> zxf inputs.tgz
<span class="fu">rm</span> inputs.tgz</code></pre>
</div>
<div id="fia-database" class="section level5">
<h5><span class="header-section-number">4.3.4.19.2</span> FIA database</h5>
<p>FIA database is large and will add an extra 10GB to the installation.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># download and install database</span>
<span class="ex">curl</span> -o fia5data.psql.gz http://isda.ncsa.illinois.edu/~kooper/EBI/fia5data.psql.gz
<span class="ex">dropdb</span> --if-exists fia5data
<span class="ex">createdb</span> -O bety fia5data
<span class="fu">gunzip</span> fia5data.psql.gz
<span class="ex">psql</span> -U bety -d fia5data <span class="op">&lt;</span> fia5data.psql
<span class="fu">rm</span> fia5data.psql</code></pre>
</div>
<div id="flux-camp" class="section level5">
<h5><span class="header-section-number">4.3.4.19.3</span> Flux Camp</h5>
<p>Following will install the data for flux camp (as well as the demo script for PEcAn).</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span>
<span class="ex">curl</span> -o plot.tgz http://isda.ncsa.illinois.edu/~kooper/EBI/plot.tgz
<span class="fu">tar</span> zxf plot.tgz
<span class="fu">rm</span> plot.tgz</code></pre>
</div>
<div id="harvard-for-ed-tutorial" class="section level5">
<h5><span class="header-section-number">4.3.4.19.4</span> Harvard for ED tutorial</h5>
<p>Add datasets and runs</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">curl</span> -o Santarem_Km83.zip http://isda.ncsa.illinois.edu/~kooper/EBI/Santarem_Km83.zip
<span class="fu">unzip</span> -d sites Santarem_Km83.zip
<span class="fu">sed</span> -i -e <span class="st">&quot;s#/home/pecan#</span><span class="va">${HOME}</span><span class="st">#&quot;</span> sites/Santarem_Km83/ED_MET_DRIVER_HEADER
<span class="fu">rm</span> Santarem_Km83.zip

<span class="ex">curl</span> -o testrun.s83.zip http://isda.ncsa.illinois.edu/~kooper/EBI/testrun.s83.zip
<span class="fu">unzip</span> testrun.s83.zip
<span class="fu">sed</span> -i -e <span class="st">&quot;s#/home/pecan#</span><span class="va">${HOME}</span><span class="st">#&quot;</span> testrun.s83/ED2IN
<span class="fu">rm</span> testrun.s83.zip

<span class="ex">curl</span> -o ed2ws.harvard.tgz http://isda.ncsa.illinois.edu/~kooper/EBI/ed2ws.harvard.tgz
<span class="fu">tar</span> zxf ed2ws.harvard.tgz
<span class="fu">mkdir</span> ed2ws.harvard/analy ed2ws.harvard/histo
<span class="fu">sed</span> -i -e <span class="st">&quot;s#/home/pecan#</span><span class="va">${HOME}</span><span class="st">#g&quot;</span> ed2ws.harvard/input_harvard/met_driver/HF_MET_HEADER ed2ws.harvard/ED2IN ed2ws.harvard/*.r
<span class="fu">rm</span> ed2ws.harvard.tgz

<span class="ex">curl</span> -o testrun.PDG.zip http://isda.ncsa.illinois.edu/~kooper/EBI/testrun.PDG.zip
<span class="fu">unzip</span> testrun.PDG.zip
<span class="fu">sed</span> -i -e <span class="st">&quot;s#/home/pecan#</span><span class="va">${HOME}</span><span class="st">#&quot;</span> testrun.PDG/Met/PDG_MET_DRIVER testrun.PDG/Template/ED2IN
<span class="fu">sed</span> -i -e <span class="st">&#39;s#/n/scratch2/moorcroft_lab/kzhang/PDG/WFire_Pecan/##&#39;</span> testrun.PDG/Template/ED2IN
<span class="fu">rm</span> testrun.PDG.zip

<span class="ex">curl</span> -o create_met_driver.tar.gz http://isda.ncsa.illinois.edu/~kooper/EBI/create_met_driver.tar.gz
<span class="fu">tar</span> zxf create_met_driver.tar.gz
<span class="fu">rm</span> create_met_driver.tar.gz</code></pre>

</div>
</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="about-the-pecan-book.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="user-section.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tonygardella/pecan/edit/release/vtonydoc/book_source/02_demos_tutorials_workflows/01_installation/00_install_PEcAn_intro.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
